<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OSINT BRIEF | CTI Dashboard</title>

    <!-- PWA Metadata -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#6a3093">
    <meta name="mobile-web-app-capable" content="yes">

    <!-- Service Worker Registration -->
    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('sw.js')
            .then(registration => console.log('ServiceWorker registration successful'))
            .catch(err => console.log('ServiceWorker registration failed: ', err));
        });
      }
    </script>

    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">


    <style>
        :root {
            --primary: #2c3e50; 
            --secondary: #3498db; 
            --danger: #e74c3c; 
            --warning: #f39c12; 
            --success: #2ecc71; 
            --info: #5dade2; 
            --light: #ecf0f1; 
            --dark: #34495e; 
            --bg-color: #f4f7f9;
            --purple-gradient-start: #6a3093;
            --purple-gradient-end: #a044ff;
            --border-color: #e0e6ed;
            --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --border-radius: 8px;
            
            /* Colores para Dashboards EPSS */
            --primary-cve: #6a3093;
            --primary-exploit: #c0392b;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            font-family: 'Roboto', sans-serif; 
            background-color: var(--bg-color); 
            color: var(--dark); 
            line-height: 1.6; 
            margin: 0;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .app-container { display: flex; flex-direction: column; min-height: 100vh; }
        .main-content-area { flex-grow: 1; padding: 25px; }
        .container { 
            max-width: 1400px; 
            margin: 0 auto; 
            background: white; 
            padding: 25px; 
            box-shadow: var(--card-shadow);
            border-radius: var(--border-radius); 
            border: 1px solid var(--border-color);
        }
        h1, h2, h3 { color: var(--primary); font-weight: 500;}
        h2 { font-size: 1.5rem; }
        h3 { font-size: 1.2rem; }

        .form-group { margin-bottom: 18px; }
        label { display: block; margin-bottom: 6px; font-weight: 500; color: #555; font-size: 0.875rem;}
        input[type="text"], input[type="date"], input[type="number"], input[type="url"], textarea, select { 
            width: 100%; 
            padding: 12px; 
            border: 1px solid var(--border-color); 
            border-radius: var(--border-radius); 
            font-size: 0.95rem; 
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
            background-color: #fff;
        }
        input[type="text"]:focus, input[type="date"]:focus, input[type="number"]:focus, input[type="url"]:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--secondary);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }
        textarea { resize: vertical; min-height: 100px; }

        button, .btn { 
            background: var(--secondary); 
            color: white; 
            border: none; 
            padding: 10px 18px; 
            border-radius: var(--border-radius); 
            cursor: pointer; 
            margin-right: 10px; 
            font-size: 0.9rem; 
            font-weight: 500;
            transition: background-color 0.2s ease, transform 0.1s ease; 
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        button:hover, .btn:hover { background: #2980b9; transform: translateY(-1px); }
        button:active, .btn:active { transform: translateY(0); }
        .btn-danger { background-color: var(--danger); }
        .btn-danger:hover { background-color: #c0392b; }
        .btn-edit { background-color: var(--warning); color: white; }
        .btn-edit:hover { background-color: #d68910; }
        .btn-success { background-color: var(--success); }
        .btn-success:hover { background-color: #27ae60; }
        
        .app-header {
            background-color: var(--primary);
            padding: 15px 25px;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .app-header h1 { font-size: 1.6em; margin:0; color: white; font-weight: 700;}

        .dropdown-menu-container { position: relative; }
        .menu-toggle-btn { background: rgba(255,255,255,0.2); color: white; padding: 8px 12px; border-radius: var(--border-radius); font-size: 1em; }
        .menu-toggle-btn:hover { background: rgba(255,255,255,0.3); }
        .dropdown-menu {
            display: none;
            position: absolute;
            right: 0;
            top: calc(100% + 5px);
            background-color: var(--primary);
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
            z-index: 1000;
            border-radius: var(--border-radius);
            min-width: 220px;
            padding: 8px;
            overflow: hidden;
        }
        .dropdown-menu a {
            color: var(--light);
            padding: 10px 15px;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 0.95em;
            border-radius: 6px;
            transition: background-color 0.2s ease, color 0.2s ease;
        }
        .dropdown-menu a i { 
            color: var(--light); 
            opacity: 0.7; 
            transition: color 0.2s ease;
        }
        .dropdown-menu a:hover { 
            background-color: var(--dark); 
            color: white; 
        }
        .dropdown-menu a:hover i { color: white; opacity: 1; }
        .dropdown-menu a.active { background-color: var(--secondary); color: white; font-weight: 500; }
        .dropdown-menu a.active i { color: white; opacity: 1; }
        .dropdown-menu-container.open .dropdown-menu { display: block; }

        .tab-content { display: none; background-color: transparent; padding: 0; }
        .tab-content.active { display: block; }
        
        .dashboard-header { 
            background: var(--primary);
            color: white; 
            padding: 25px; 
            border-radius: 12px; 
            margin-bottom: 25px; 
            box-shadow: var(--card-shadow); 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            flex-wrap: wrap; 
        }
        .header-text h1 { font-size: 24px; font-weight: 700; margin-bottom: 5px; color: white; }
        .header-text p { opacity: 0.9; font-size: 13px; }
        .header-stats { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 10px; } 
        .stat-box { background: rgba(255, 255, 255, 0.15); padding: 8px 10px; border-radius: 8px; text-align: center; min-width: 75px; cursor: pointer; transition: transform 0.2s ease, background-color 0.2s ease; } 
        .stat-box:hover { transform: translateY(-3px); background: rgba(255, 255, 255, 0.25); }
        .stat-value { font-size: 18px; font-weight: 700; margin-bottom: 2px; } 
        .stat-label { font-size: 9px; opacity: 0.8; text-transform: uppercase; } 
        .critical { color: var(--danger); } .high { color: var(--warning); } .medium { color: #f1c40f; } .low { color: var(--success); } .info-stat { color: var(--info); }
        
        .dashboard-controls {
            background: white; padding: 20px; border-radius: var(--border-radius);
            margin-bottom: 25px; box-shadow: var(--card-shadow); border: 1px solid var(--border-color);
            display: flex; align-items: center; flex-wrap: wrap; gap: 15px;
        }
        .dashboard-controls .form-group { margin-bottom: 0; flex: 1; min-width: 180px; }
        .dashboard-controls .control-buttons { margin-left: auto; display: flex; gap: 10px; }


        .grid { display: grid; grid-template-columns: repeat(12, 1fr); gap: 25px; margin-bottom: 25px; }
        .card { 
            background: white; border-radius: 12px; padding: 20px; box-shadow: var(--card-shadow); 
            border: 1px solid var(--border-color); display: flex; flex-direction: column; 
        }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid var(--border-color); padding-bottom: 15px; }
        .card-title { font-size: 1.1rem; font-weight: 500; color: var(--primary); margin-right: auto; }
        .card-body { flex-grow: 1; position: relative; }
        .chart-container, .table-container, .special-container { position: relative; width: 100%; height: 100%; min-height: 280px; }
        .table-container { max-height: 400px; overflow-y: auto; }
        .col-12 { grid-column: span 12; } .col-8 { grid-column: span 8; } .col-6 { grid-column: span 6; } .col-4 { grid-column: span 4; }
        
        /* Edit Mode & Widget Controls */
        .widget-header-controls { display: flex; align-items: center; gap: 10px; }
        .widget-control-btn { background-color: var(--light); color: var(--primary); border: 1px solid var(--border-color); padding: 4px 8px; font-size: 0.8rem; margin: 0; }
        .widget-control-btn:hover { background-color: var(--border-color); }
        .widget-control-btn.delete { background-color: var(--danger); color:white; }
        .widget-control-btn.delete:hover { background-color: #c0392b; }
        .widget-control-btn.edit { background-color: var(--warning); color:white; }
        .widget-control-btn.edit:hover { background-color: #d68910; }
        
        /* Modal Styles */
        .modal {
            display: none; position: fixed; z-index: 1050; left: 0; top: 0; width: 100%; height: 100%;
            overflow: auto; background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: #fefefe; margin: 10% auto; padding: 25px; border: 1px solid #888;
            width: 80%; max-width: 600px; border-radius: var(--border-radius); box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 15px; border-bottom: 1px solid var(--border-color); margin-bottom: 20px; }
        .modal-title { margin: 0; }
        .close-modal { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close-modal:hover, .close-modal:focus { color: black; text-decoration: none; }
        .form-row { display: flex; gap: 20px; } 
        .form-row .form-group { flex: 1; }
        
        .dashboard-alerts-container { max-height: 400px; overflow-y: auto; padding-right: 10px; } 
        .alert-dashboard-item { border-left-width: 4px; border-left-style: solid; padding: 12px 18px; margin-bottom: 12px; border-radius: var(--border-radius); display: flex; align-items: flex-start; transition: box-shadow .2s ease; }
        .alert-dashboard-item:hover { box-shadow: var(--card-shadow); }
        .alert-dashboard-item.critical-alert { background-color: #ffebee; border-left-color: var(--danger); }
        .alert-dashboard-item.high-alert { background-color: #fff3e0; border-left-color: var(--warning); }
        .alert-dashboard-item.medium-alert { background-color: #fff8e1; border-left-color: #f1c40f; }
        .alert-dashboard-item.low-alert { background-color: #e8f5e9; border-left-color: var(--success); }
        .alert-dashboard-item.info-alert { background-color: #e3f2fd; border-left-color: var(--info); }

        .alert-icon { font-size: 20px; margin-right: 15px; line-height: 1.2; }
        .alert-content h3 { font-size: 1rem; margin-bottom: 3px; color: var(--dark); font-weight: 500; } 
        .alert-content p { font-size: 0.875rem; color: #666; margin: 0; }
        .alert-content .alert-date { font-size: 0.75rem; color: #777; margin-top: 5px; display: block; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 0.9rem; }
        th, td { padding: 12px 15px; text-align: left; vertical-align: middle;}
        thead tr { border-bottom: 2px solid var(--primary); }
        th { background-color: transparent; font-weight: 500; color: var(--primary); text-transform: uppercase; font-size: 0.8rem; }
        tbody tr { border-bottom: 1px solid var(--border-color); }
        tbody tr:last-of-type { border-bottom: none; }
        tbody tr:hover { background-color: #f8fafc; }
        td.actions-cell { white-space: nowrap; width: 1%; text-align: right; } 
        .actions-cell button { margin-right: 5px !important; padding: 6px 10px; font-size: 0.8rem; } 
        .actions-cell button:last-child { margin-right: 0 !important; }
        
        .badge { display: inline-block; padding: 4px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: 500; margin-right: 5px; text-transform: capitalize; border: 1px solid transparent;}
        .badge-critical { background-color: #ffebee; color: var(--danger); border-color: var(--danger); } 
        .badge-high { background-color: #fff3e0; color: var(--warning); border-color: var(--warning); }
        .badge-medium { background-color: #fff8e1; color: #f39c12; border-color: #f39c12; } 
        .badge-low { background-color: #e8f5e9; color: var(--success); border-color: var(--success); }
        .badge-info { background-color: #e3f2fd; color: var(--info); border-color: var(--info); }
        .badge-country { background-color: var(--primary); color: white; }
        .badge-sector { background-color: var(--secondary); color: white; }
        .badge-estado-activo { background-color: var(--danger); color: white; }
        .badge-estado-mitigado { background-color: var(--success); color: white; }
        .badge-estado-investigacion { background-color: var(--warning); color: var(--dark); }
        .badge-estado-poc { background-color: var(--info); color: white; }
        .badge-unknown { background-color: #7f8c8d; color: white; }

        .form-container {
            border: 1px solid var(--border-color); padding: 25px; border-radius: var(--border-radius); margin-bottom: 25px;
            background-color: #fdfdfe; display: none;
        }
        .toggle-form-btn-container { margin-bottom: 25px; }
        .toggle-form-btn { background-color: var(--primary); }
        .toggle-form-btn:hover { background-color: var(--dark); }

        footer { text-align: center; margin-top: 40px; padding: 25px; color: #777; font-size: 0.85rem; border-top: 1px solid var(--border-color); background-color: var(--light); }
        .search-box { margin-bottom: 20px; } 
        .search-box input { max-width: 400px; padding: 12px; border: 1px solid var(--border-color); border-radius: var(--border-radius); }
        .action-buttons { margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap;}
        
        .form-title-action { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .form-title-action h2 { margin: 0; }
        .form-title-action button { margin-right: 0; }

        /* Estilos específicos para componentes EPSS */
        .epss-loader {
            text-align: center; padding: 50px; font-size: 1.2rem; color: #777; min-height: 400px;
            display: flex; align-items: center; justify-content: center; flex-direction: column;
        }
        .epss-stats-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 25px;
        }
        .epss-stat-card { text-align: center; padding: 15px; background-color: var(--light); border-radius: var(--border-radius); }
        .epss-stat-value { font-size: 2.2rem; font-weight: 700; }
        .epss-stat-label { font-size: 0.8rem; margin-top: 5px; color: #555; }
        .epss-content-grid {
            display: grid; grid-template-columns: 60% 40%; gap: 20px; flex-grow: 1;
        }
        .epss-dashboard.cve .epss-stat-value { color: var(--primary-cve); }
        .epss-dashboard.exploit .epss-stat-value { color: var(--primary-exploit); }


        @media (max-width: 992px) { 
            .grid { grid-template-columns: repeat(6, 1fr); } 
            .col-12, .col-8, .col-6, .col-4 { grid-column: span 6; }
            .epss-content-grid { grid-template-columns: 1fr; }
        }
        @media (max-width: 768px) {
            .main-content-area { padding: 15px; }
            .container { padding: 15px; }
            .app-header h1 { font-size: 1.2em; }
            .menu-toggle-btn { font-size: 0.9em; padding: 6px 10px; }
            .dashboard-header, .dashboard-controls { flex-direction: column; align-items: stretch;}
            .dashboard-controls .control-buttons { margin-left: 0; margin-top: 15px; justify-content: flex-start; }
            .header-stats { flex-direction: row; gap: 6px; margin-top: 15px; align-items: stretch; width: 100%; justify-content: space-around;}
            .stat-box { min-width: 0; flex-basis: calc(33.33% - 8px); padding: 6px;} 
            .stat-value { font-size: 16px; }
            .stat-label { font-size: 8px;}
            .grid { grid-template-columns: 1fr; gap: 15px; } 
            .col-12, .col-8, .col-6, .col-4 { grid-column: span 1; }
            .form-row { flex-direction: column; gap:0; }
        }
         @media (max-width: 480px) {
            .header-stats { gap: 5px; }
            .stat-box { flex-basis: calc(50% - 5px); } 
            .modal-content { width: 95%; margin: 5% auto; }
         }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="app-header">
            <h1><i class="fa-solid fa-shield-halved" style="margin-right: 10px;"></i>OSINT Brief</h1>
            <img id="fondo-pdf" src="fondo.jpg" style="display: none;" />
            <div class="dropdown-menu-container" id="navMenuContainer">
                <button class="menu-toggle-btn" onclick="toggleNavMenu()">☰ Menú</button>
                <nav class="dropdown-menu" id="appNavigation">
                    <a href="#" class="nav-link active" data-tab-name="dashboard"><i class="fa-fw fa-solid fa-chart-pie"></i>Dashboard</a>
                    <a href="#" class="nav-link" data-tab-name="incidentes"><i class="fa-fw fa-solid fa-triangle-exclamation"></i>Incidentes</a>
                    <a href="#" class="nav-link" data-tab-name="exploits"><i class="fa-fw fa-solid fa-code-branch"></i>Exploits</a>
                    <a href="#" class="nav-link" data-tab-name="zero-days"><i class="fa-fw fa-solid fa-star"></i>Zero Days</a>
                    <a href="#" class="nav-link" data-tab-name="cves"><i class="fa-fw fa-solid fa-bug"></i>CVEs</a>
                    <a href="#" class="nav-link" data-tab-name="alertas"><i class="fa-fw fa-solid fa-bell"></i>Alertas</a>
                    <a href="#" class="nav-link" data-tab-name="fuentes"><i class="fa-fw fa-solid fa-book-journal-whills"></i>Fuentes Intel</a>
                    <a href="#" class="nav-link" data-tab-name="mitigaciones"><i class="fa-fw fa-solid fa-shield-virus"></i>Mitigaciones</a>
                    <a href="#" class="nav-link" data-tab-name="reporte"><i class="fa-fw fa-solid fa-file-export"></i>Exportar</a>
                </nav>
            </div>
        </header>

        <main class="main-content-area">
            <!-- Dashboard Tab -->
            <div id="dashboard" class="tab-content active">
                <div style="background: transparent; box-shadow: none; padding:0;">
                    <header class="dashboard-header">
                        <div class="header-text">
                            <h1>Dashboard de Inteligencia de Amenazas</h1>
                            <p id="dashboardDate">Mostrando todos los datos registrados.</p>
                        </div>
                        <div class="header-stats">
                            <div class="stat-box" onclick="navigateToTab('incidentes')"><div class="stat-value critical" id="statIncidents">0</div><div class="stat-label">Incidentes</div></div>
                            <div class="stat-box" onclick="navigateToTab('exploits')"><div class="stat-value high" id="statExploits">0</div><div class="stat-label">Exploits</div></div>
                            <div class="stat-box" onclick="navigateToTab('zero-days')"><div class="stat-value medium" id="statZeroDays">0</div><div class="stat-label">ZeroDays</div></div>
                            <div class="stat-box" onclick="navigateToTab('cves')"><div class="stat-value" id="statCVEs">0</div><div class="stat-label">CVEs</div></div>
                            <div class="stat-box" onclick="navigateToTab('alertas')"><div class="stat-value info-stat" id="statAlerts">0</div><div class="stat-label">Alertas</div></div>
                            <div class="stat-box" onclick="navigateToTab('fuentes')"><div class="stat-value" id="statFuentes">0</div><div class="stat-label">Fuentes</div></div>
                            <div class="stat-box" onclick="navigateToTab('mitigaciones')"><div class="stat-value" id="statMitigaciones">0</div><div class="stat-label">Mitigaciones</div></div>
                        </div>
                    </header>
                    
                    <div class="dashboard-controls">
                        <div class="form-group">
                            <label for="dashboardStartDate">Fecha de Inicio:</label>
                            <input type="date" id="dashboardStartDate">
                        </div>
                        <div class="form-group">
                            <label for="dashboardEndDate">Fecha de Fin:</label>
                            <input type="date" id="dashboardEndDate">
                        </div>
                        <button id="applyDashboardFilterBtn" class="btn-success"><i class="fa-solid fa-filter"></i>Aplicar Filtro</button>
                        <button id="resetDashboardFilterBtn"><i class="fa-solid fa-arrows-rotate"></i>Resetear</button>
                        <div class="control-buttons">
                            <button id="toggleEditModeBtn"><i class="fa-solid fa-edit"></i> Editar Dashboard</button>
                            <button id="addWidgetBtn" class="btn-success" style="display: none;"><i class="fa-solid fa-plus"></i> Añadir Elemento</button>
                        </div>
                    </div>

                    <!-- DYNAMIC DASHBOARD GRID -->
                    <div id="dashboardGrid" class="grid">
                        <!-- Widgets will be dynamically inserted here -->
                    </div>
                </div>
            </div>

            <!-- Add/Edit Widget Modal -->
            <div id="widgetModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 class="modal-title" id="widgetModalTitle">Añadir Nuevo Elemento</h2>
                        <span class="close-modal">&times;</span>
                    </div>
                    <form id="widgetForm">
                        <input type="hidden" id="widgetEditId">
                        <div class="form-group">
                            <label for="widgetTitle">Título del Elemento</label>
                            <input type="text" id="widgetTitle" required placeholder="Ej: Incidentes por Sector">
                        </div>
                        <div class="form-row">
                             <div class="form-group">
                                <label for="widgetType">Tipo de Elemento</label>
                                <select id="widgetType" required>
                                    <option value="">-- Seleccione --</option>
                                    <option value="chart">Gráfico</option>
                                    <option value="table">Tabla</option>
                                    <option value="special">Componente Especial</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="widgetSize">Tamaño</label>
                                <select id="widgetSize" required>
                                    <option value="col-4">Pequeño (1/3)</option>
                                    <option value="col-6" selected>Mediano (1/2)</option>
                                    <option value="col-8">Grande (2/3)</option>
                                    <option value="col-12">Ancho Completo</option>
                                </select>
                            </div>
                        </div>

                        <!-- Fields for Chart Type -->
                        <div id="chartOptions" class="form-section" style="display:none;">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="chartType">Tipo de Gráfico</label>
                                    <select id="chartType">
                                        <option value="bar">Barras</option>
                                        <option value="pie">Torta (Pie)</option>
                                        <option value="doughnut">Anillo (Doughnut)</option>
                                        <option value="radar">Radar</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="chartDataSource">Fuente de Datos</label>
                                    <select id="chartDataSource"></select>
                                </div>
                            </div>
                             <div class="form-group">
                                <label for="chartGroupBy">Agrupar Por Campo</label>
                                <select id="chartGroupBy"></select>
                            </div>
                        </div>

                        <!-- Fields for Table Type -->
                        <div id="tableOptions" class="form-section" style="display:none;">
                            <div class="form-group">
                                <label for="tableDataSource">Mostrar Datos de</label>
                                <select id="tableDataSource"></select>
                            </div>
                        </div>
                        
                        <!-- Fields for Special Component Type -->
                        <div id="specialOptions" class="form-section" style="display:none;">
                            <div class="form-group">
                                <label for="specialComponentSource">Seleccionar Componente</label>
                                <select id="specialComponentSource"></select>
                            </div>
                        </div>

                        <div class="action-buttons">
                            <button type="submit" class="btn-success" id="saveWidgetBtn"><i class="fa-solid fa-plus"></i> Añadir Elemento</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Formulario de Incidentes -->
            <div id="incidentes" class="tab-content"><div class="container">
                <div class="toggle-form-btn-container"><button class="toggle-form-btn" onclick="toggleForm('incidenteFormContainer', 'incidenteForm')"><i class="fa-solid fa-plus"></i>Registrar Nuevo Incidente</button></div>
                <div id="incidenteFormContainer" class="form-container">
                    <div class="form-title-action">
                        <h2 id="incidenteFormTitle">Registrar Incidente</h2>
                        <button class="btn-danger" id="cancelIncidenteEditBtn" style="display:none;" onclick="cancelEdit('incidenteForm', 'incidenteFormTitle', 'Registrar Incidente', 'guardarIncidenteBtn', 'Guardar Incidente')"><i class="fa-solid fa-times"></i> Cancelar</button>
                    </div>
                    <form id="incidenteForm">
                        <input type="hidden" id="incidenteEditId">
                        <div class="form-row">
                            <div class="form-group"><label for="fechaIncidente">Fecha:</label><input type="date" id="fechaIncidente" required></div>
                            <div class="form-group"><label for="tipoIncidente">Tipo:</label><select id="tipoIncidente" required><option value="DataBreach">Data Breach</option><option value="Ransomware">Ransomware</option><option value="CyberAttack">Cyber Attack (General)</option><option value="DataLeak">Data Leak</option><option value="Phishing">Phishing</option><option value="Defacement">Website Defacement</option><option value="Botnet">Botnet Activity</option><option value="SupplyChain">Supply Chain Attack</option></select></div>
                        </div>
                        <div class="form-group"><label for="entidadIncidente">Entidad Afectada:</label><input type="text" id="entidadIncidente" required></div>
                        <div class="form-row">
                            <div class="form-group"><label for="paisIncidente">País:</label><input type="text" id="paisIncidente" placeholder="Ej: Argentina"></div>
                            <div class="form-group"><label for="sectorIncidente">Sector:</label><input type="text" id="sectorIncidente" placeholder="Ej: Energía, Agro, Salud"></div>
                        </div>
                        <div class="form-group"><label for="descripcionIncidente">Descripción:</label><textarea id="descripcionIncidente" required></textarea></div>
                        <div class="form-group"><label for="datosComprometidosIncidente">Datos Comprometidos:</label><input type="text" id="datosComprometidosIncidente"></div>
                        <div class="form-group"><label for="actorIncidente">Actor de Amenazas:</label><input type="text" id="actorIncidente"></div>
                        <div class="form-group"><label for="urlIncidente">URL de Referencia (Opcional):</label><input type="url" id="urlIncidente"></div>
                        <button type="submit" id="guardarIncidenteBtn"><i class="fa-solid fa-save"></i> Guardar Incidente</button>
                    </form>
                </div>
                <div class="search-box"><input type="text" id="searchIncidentes" placeholder="Buscar incidentes..." onkeyup="buscarIncidentes()"></div>
                <h2>Incidentes Registrados</h2>
                <table id="tablaIncidentes"><thead><tr><th>Fecha</th><th>Entidad</th><th>País</th><th>Sector</th><th>Tipo</th><th>Actor</th><th class="actions-cell">Acciones</th></tr></thead><tbody></tbody></table>
            </div></div>

            <!-- Formulario de Exploits -->
            <div id="exploits" class="tab-content"><div class="container">
                <div class="toggle-form-btn-container"><button class="toggle-form-btn" onclick="toggleForm('exploitFormContainer', 'exploitForm')"><i class="fa-solid fa-plus"></i>Registrar Nuevo Exploit</button></div>
                <div id="exploitFormContainer" class="form-container">
                    <div class="form-title-action">
                        <h2 id="exploitFormTitle">Registrar Exploit</h2>
                        <button class="btn-danger" id="cancelExploitEditBtn" style="display:none;" onclick="cancelEdit('exploitForm', 'exploitFormTitle', 'Registrar Exploit', 'guardarExploitBtn', 'Guardar Exploit')"><i class="fa-solid fa-times"></i> Cancelar</button>
                    </div>
                    <form id="exploitForm">
                        <input type="hidden" id="exploitEditId">
                        <div class="form-row">
                            <div class="form-group"><label for="fechaExploit">Fecha Publicación/Descubrimiento:</label><input type="date" id="fechaExploit" required></div>
                            <div class="form-group"><label for="tipoExploit">Tipo:</label><select id="tipoExploit" required><option value="Network">Network</option><option value="Local">Local</option><option value="RemoteCodeExecution">Remote Code Execution</option><option value="PrivilegeEscalation">Privilege Escalation</option><option value="WebApplication">Web Application</option><option value="DoS">Denial of Service</option><option value="XSS">XSS</option></select></div>
                        </div>
                        <div class="form-group"><label for="nombreExploit">Nombre/Descripción Exploit:</label><input type="text" id="nombreExploit" required placeholder="Ej: XSS en Label Studio"></div>
                        <div class="form-group"><label for="plataformaExploit">Plataforma Afectada:</label><input type="text" id="plataformaExploit" required placeholder="Ej: Label Studio, FortiManager 7.6.0"></div>
                        <div class="form-group"><label for="cveExploit">CVE Asociado (opcional):</label><input type="text" id="cveExploit" placeholder="Ej: CVE-2023-12345"></div>
                        <div class="form-group"><label for="urlExploit">URL de Referencia (Opcional):</label><input type="url" id="urlExploit"></div>
                        <button type="submit" id="guardarExploitBtn"><i class="fa-solid fa-save"></i> Guardar Exploit</button>
                    </form>
                </div>
                <div class="search-box"><input type="text" id="searchExploits" placeholder="Buscar exploits..." onkeyup="buscarExploits()"></div>
                <h2>Exploits Registrados</h2>
                <table id="tablaExploits"><thead><tr><th>Fecha</th><th>Nombre</th><th>Tipo</th><th>Plataforma</th><th>CVE</th><th class="actions-cell">Acciones</th></tr></thead><tbody></tbody></table>
            </div></div>

            <!-- Formulario de Zero Days -->
            <div id="zero-days" class="tab-content"><div class="container">
                <div class="toggle-form-btn-container"><button class="toggle-form-btn" onclick="toggleForm('zeroDayFormContainer', 'zeroDayForm')"><i class="fa-solid fa-plus"></i>Registrar Nuevo Zero Day</button></div>
                 <div id="zeroDayFormContainer" class="form-container">
                    <div class="form-title-action">
                        <h2 id="zeroDayFormTitle">Registrar Zero Day</h2>
                        <button class="btn-danger" id="cancelZeroDayEditBtn" style="display:none;" onclick="cancelEdit('zeroDayForm', 'zeroDayFormTitle', 'Registrar Zero Day', 'guardarZeroDayBtn', 'Guardar Zero Day')"><i class="fa-solid fa-times"></i> Cancelar</button>
                    </div>
                    <form id="zeroDayForm">
                        <input type="hidden" id="zeroDayEditId">
                        <div class="form-row">
                            <div class="form-group"><label for="idZD">ID Zero-Day (Ej: ZDI-ID, interno):</label><input type="text" id="idZD" placeholder="Ej: ZDI-2025-001"></div>
                            <div class="form-group"><label for="fechaZD">Fecha Detección:</label><input type="date" id="fechaZD" required></div>
                        </div>
                        <div class="form-group"><label for="nombreZD">Nombre/Vulnerabilidad:</label><input type="text" id="nombreZD" required placeholder="Ej: Windows Kernel Privilege Escalation"></div>
                        <div class="form-group"><label for="plataformaZD">Plataforma/Software Afectado:</label><input type="text" id="plataformaZD" required placeholder="Ej: Microsoft Windows, Apache Struts"></div>
                        <div class="form-row">
                            <div class="form-group"><label for="cvssZD">CVSS (Estimado):</label><input type="number" id="cvssZD" step="0.1" min="0" max="10" required></div>
                            <div class="form-group"><label for="estadoZD">Estado:</label><select id="estadoZD" required><option value="Activo">Activo</option><option value="Mitigado">Mitigado</option><option value="Investigacion">En Investigación</option><option value="PruebaDeConcepto">Prueba de Concepto</option></select></div>
                        </div>
                        <div class="form-group"><label for="urlZD">URL de Referencia (Opcional):</label><input type="url" id="urlZD" placeholder="https://example.com/zero-day-info"></div>
                        <div class="form-group"><label for="descripcionZD">Descripción Adicional/Requisitos:</label><textarea id="descripcionZD"></textarea></div>
                        <button type="submit" id="guardarZeroDayBtn"><i class="fa-solid fa-save"></i> Guardar Zero Day</button>
                    </form>
                </div>
                <div class="search-box"><input type="text" id="searchZeroDays" placeholder="Buscar zero days..." onkeyup="buscarZeroDays()"></div>
                <h2>Zero Days Registrados</h2>
                <table id="tablaZeroDays"><thead><tr><th>ID</th><th>Nombre</th><th>Plataforma</th><th>Fecha</th><th>CVSS</th><th>Estado</th><th class="actions-cell">Acciones</th></tr></thead><tbody></tbody></table>
            </div></div>

            <!-- Formulario de CVEs -->
            <div id="cves" class="tab-content"><div class="container">
                <div class="toggle-form-btn-container"><button class="toggle-form-btn" onclick="toggleForm('cveFormContainer', 'cveForm')"><i class="fa-solid fa-plus"></i>Registrar Nuevo CVE</button></div>
                <div id="cveFormContainer" class="form-container">
                    <div class="form-title-action">
                        <h2 id="cveFormTitle">Registrar CVE</h2>
                        <button class="btn-danger" id="cancelCveEditBtn" style="display:none;" onclick="cancelEdit('cveForm', 'cveFormTitle', 'Registrar CVE', 'guardarCveBtn', 'Guardar CVE')"><i class="fa-solid fa-times"></i> Cancelar</button>
                    </div>
                    <form id="cveForm">
                        <input type="hidden" id="cveEditId">
                        <div class="form-row">
                            <div class="form-group"><label for="idCVE">ID CVE:</label><input type="text" id="idCVE" required placeholder="Ej: CVE-2023-12345"></div>
                            <div class="form-group"><label for="fechaCVE">Fecha Publicación:</label><input type="date" id="fechaCVE" required></div>
                        </div>
                        <div class="form-group"><label for="aplicativoCVE">Aplicativo/Producto Afectado:</label><input type="text" id="aplicativoCVE" required></div>
                        <div class="form-row">
                            <div class="form-group"><label for="cvssCVE">CVSS 3.x:</label><input type="number" id="cvssCVE" step="0.1" min="0" max="10" required></div>
                            <div class="form-group"><label for="estadoCVE">Estado:</label><select id="estadoCVE"><option value="Publicado">Publicado</option><option value="ExplotadoActivamente">Explotado Activamente</option><option value="PruebaDeConcepto">Prueba de Concepto Disponible</option><option value="Parcheado">Parcheado</option><option value="Analisis">En Análisis</option></select></div>
                        </div>
                        <div class="form-group"><label for="descripcionCVE">Descripción Breve:</label><textarea id="descripcionCVE" required></textarea></div>
                        <div class="form-group"><label for="urlCVE">URL de Referencia (Opcional):</label><input type="url" id="urlCVE"></div>
                        <button type="submit" id="guardarCveBtn"><i class="fa-solid fa-save"></i> Guardar CVE</button>
                    </form>
                </div>
                <div class="search-box"><input type="text" id="searchCVEs" placeholder="Buscar CVEs..." onkeyup="buscarCVEs()"></div>
                <h2>CVEs Registrados</h2>
                <table id="tablaCVEs"><thead><tr><th>ID</th><th>Aplicativo</th><th>Fecha Pub.</th><th>CVSS</th><th>Estado</th><th class="actions-cell">Acciones</th></tr></thead><tbody></tbody></table>
            </div></div>

            <!-- Formulario de Alertas -->
            <div id="alertas" class="tab-content"><div class="container">
                <div class="toggle-form-btn-container"><button class="toggle-form-btn" onclick="toggleForm('alertaFormContainer', 'alertaForm')"><i class="fa-solid fa-plus"></i>Registrar Nueva Alerta</button></div>
                <div id="alertaFormContainer" class="form-container">
                    <div class="form-title-action">
                        <h2 id="alertaFormTitle">Registrar Alerta de Seguridad</h2>
                        <button class="btn-danger" id="cancelAlertaEditBtn" style="display:none;" onclick="cancelEdit('alertaForm', 'alertaFormTitle', 'Registrar Alerta', 'guardarAlertaBtn', 'Guardar Alerta')"><i class="fa-solid fa-times"></i> Cancelar</button>
                    </div>
                    <form id="alertaForm">
                        <input type="hidden" id="alertaEditId">
                        <div class="form-row">
                            <div class="form-group"><label for="tituloAlerta">Título de la Alerta:</label><input type="text" id="tituloAlerta" required></div>
                            <div class="form-group"><label for="fechaAlerta">Fecha de Alerta:</label><input type="date" id="fechaAlerta" required></div>
                        </div>
                        <div class="form-group"><label for="descripcionAlerta">Descripción Detallada:</label><textarea id="descripcionAlerta" required></textarea></div>
                        <div class="form-group"><label for="criticidadAlerta">Criticidad:</label><select id="criticidadAlerta" required><option value="Informacional">Informacional</option><option value="Baja">Baja</option><option value="Media">Media</option><option value="Alta">Alta</option><option value="Critica">Crítica</option></select></div>
                        <div class="form-group"><label for="urlAlerta">URL de Referencia (Opcional):</label><input type="url" id="urlAlerta"></div>
                        <button type="submit" id="guardarAlertaBtn"><i class="fa-solid fa-save"></i> Guardar Alerta</button>
                    </form>
                </div>
                <div class="search-box"><input type="text" id="searchAlertas" placeholder="Buscar alertas..." onkeyup="buscarAlertas()"></div>
                <h2>Alertas Registradas</h2>
                <table id="tablaAlertas"><thead><tr><th>Fecha</th><th>Título</th><th>Criticidad</th><th>Descripción</th><th class="actions-cell">Acciones</th></tr></thead><tbody></tbody></table>
            </div></div>

            <!-- Formulario de Fuentes de Inteligencia -->
            <div id="fuentes" class="tab-content"><div class="container">
                <div class="toggle-form-btn-container"><button class="toggle-form-btn" onclick="toggleForm('fuenteFormContainer', 'fuenteForm')"><i class="fa-solid fa-plus"></i>Registrar Nueva Fuente</button></div>
                 <div id="fuenteFormContainer" class="form-container">
                    <div class="form-title-action">
                        <h2 id="fuenteFormTitle">Registrar Fuente de Inteligencia</h2>
                        <button class="btn-danger" id="cancelFuenteEditBtn" style="display:none;" onclick="cancelEdit('fuenteForm', 'fuenteFormTitle', 'Registrar Fuente', 'guardarFuenteBtn', 'Guardar Fuente')"><i class="fa-solid fa-times"></i> Cancelar</button>
                    </div>
                    <form id="fuenteForm">
                        <input type="hidden" id="fuenteEditId">
                        <div class="form-row">
                            <div class="form-group"><label for="nombreFuente">Nombre de la Fuente:</label><input type="text" id="nombreFuente" required placeholder="Ej: FortiGuard Labs, MITRE ATT&CK"></div>
                            <div class="form-group"><label for="fechaFuente">Fecha:</label><input type="date" id="fechaFuente" required></div>
                        </div>
                        <div class="form-group"><label for="tipoFuente">Tipo de Fuente:</label><select id="tipoFuente"><option value="OSINT">OSINT</option><option value="VendorReport">Vendor Report</option><option value="ThreatFeed">Threat Feed</option><option value="Forum">Security Forum</option><option value="Internal">Internal Research</option></select></div>
                        <div class="form-group"><label for="urlFuente">URL:</label><input type="url" id="urlFuente"></div>
                        <div class="form-group"><label for="descripcionFuente">Descripción/Notas:</label><textarea id="descripcionFuente" placeholder="Ej: Detección de campañas de ransomware, Tácticas y técnicas de grupos de amenazas"></textarea></div>
                        <button type="submit" id="guardarFuenteBtn"><i class="fa-solid fa-save"></i> Guardar Fuente</button>
                    </form>
                </div>
                <div class="search-box"><input type="text" id="searchFuentes" placeholder="Buscar fuentes..." onkeyup="buscarFuentes()"></div>
                <h2>Fuentes de Inteligencia Registradas</h2>
                <table id="tablaFuentes"><thead><tr><th>Fecha</th><th>Nombre</th><th>Tipo</th><th>URL</th><th>Descripción</th><th class="actions-cell">Acciones</th></tr></thead><tbody></tbody></table>
            </div></div>

            <!-- Formulario de Mitigaciones -->
            <div id="mitigaciones" class="tab-content"><div class="container">
                <div class="toggle-form-btn-container"><button class="toggle-form-btn" onclick="toggleForm('mitigacionFormContainer', 'mitigacionForm')"><i class="fa-solid fa-plus"></i>Registrar Nueva Mitigación</button></div>
                <div id="mitigacionFormContainer" class="form-container">
                    <div class="form-title-action">
                        <h2 id="mitigacionFormTitle">Registrar Mitigación/Recomendación</h2>
                        <button class="btn-danger" id="cancelMitigacionEditBtn" style="display:none;" onclick="cancelEdit('mitigacionForm', 'mitigacionFormTitle', 'Registrar Mitigación', 'guardarMitigacionBtn', 'Guardar Mitigación')"><i class="fa-solid fa-times"></i> Cancelar</button>
                    </div>
                    <form id="mitigacionForm">
                        <input type="hidden" id="mitigacionEditId">
                        <div class="form-group"><label for="tituloMitigacion">Título de la Mitigación:</label><input type="text" id="tituloMitigacion" required placeholder="Ej: Actualizaciones y Parches Críticos"></div>
                        <div class="form-row">
                            <div class="form-group"><label for="fechaMitigacion">Fecha:</label><input type="date" id="fechaMitigacion" required></div>
                            <div class="form-group"><label for="categoriaMitigacion">Categoría:</label><select id="categoriaMitigacion"><option value="Parches">Parches y Actualizaciones</option><option value="Configuracion">Configuración Segura</option><option value="Deteccion">Detección y Respuesta</option><option value="Concientizacion">Concientización</option><option value="ProteccionRansomware">Protección contra Ransomware</option><option value="ProteccionPhishing">Protección contra Phishing</option></select></div>
                        </div>
                        <div class="form-group"><label for="descripcionMitigacion">Descripción Detallada:</label><textarea id="descripcionMitigacion" required></textarea></div>
                        <div class="form-group"><label for="prioridadMitigacion">Prioridad:</label><select id="prioridadMitigacion"><option value="Alta">Alta</option><option value="Media">Media</option><option value="Baja">Baja</option></select></div>
                        <div class="form-group"><label for="urlMitigacion">URL de Referencia (Opcional):</label><input type="url" id="urlMitigacion"></div>
                        <button type="submit" id="guardarMitigacionBtn"><i class="fa-solid fa-save"></i> Guardar Mitigación</button>
                    </form>
                </div>
                <div class="search-box"><input type="text" id="searchMitigaciones" placeholder="Buscar mitigaciones..." onkeyup="buscarMitigaciones()"></div>
                <h2>Mitigaciones Registradas</h2>
                <table id="tablaMitigaciones"><thead><tr><th>Título</th><th>Categoría</th><th>Prioridad</th><th>Descripción</th><th class="actions-cell">Acciones</th></tr></thead><tbody></tbody></table>
            </div></div>
            
            <!-- Exportar -->
            <div id="reporte" class="tab-content"><div class="container">
                <h2>Exportar Datos</h2>
                
                <h3 style="margin-top: 20px;">Seleccionar Período para Reporte</h3>
                <div class="form-row" style="margin-bottom: 20px;">
                    <div class="form-group">
                        <label for="reportStartDate">Fecha de Inicio:</label>
                        <input type="date" id="reportStartDate">
                    </div>
                    <div class="form-group">
                        <label for="reportEndDate">Fecha de Fin:</label>
                        <input type="date" id="reportEndDate">
                    </div>
                </div>

                <div class="action-buttons">
                    <button onclick="handlePdfExportClick()"><i class="fa-solid fa-file-pdf"></i>Exportar a PDF (Brief)</button>
                    <button onclick="exportarExcel()"><i class="fa-solid fa-file-excel"></i>Exportar a Excel</button>
                    <button onclick="document.getElementById('excelImporter').click()"><i class="fa-solid fa-file-import"></i>Importar desde Excel</button>
                    <input type="file" id="excelImporter" style="display:none" onchange="handleExcelImport(event)" accept=".xlsx, .xls">
                     <button onclick="descargarCorreoHTML()"><i class="fa-solid fa-envelope"></i>Descargar Correo HTML</button>
                    <button onclick="generarReporteCompletoHTML()"><i class="fa-solid fa-eye"></i>Previsualizar Reporte</button>
                </div>
                <div id="previewReporte" style="margin-top: 20px; padding: 15px; border: 1px solid #ddd; background: #f9f9f9; max-height: 600px; overflow-y: auto;">Presione "Previsualizar Reporte HTML" para ver.</div>
            </div></div>
        </main>

        <footer>Report builder app © <span id="currentYear"></span> | Datos obtenidos desde API.</footer>
    </div> 

<script>
    // =============================================================================
    // CONFIGURACIÓN INICIAL Y VARIABLES GLOBALES
    // =============================================================================
    const API_BASE_URL = 'http://localhost:3000/api';
    const EPSS_API_URL = 'https://api.first.org/data/v1/epss?cve=';
    let ALL_DATA_CACHE = {}; 
    let chartInstances = {}; 
    const ROOT_CSS_VARIABLES = {};
    document.getElementById('currentYear').textContent = new Date().getFullYear();

    // =============================================================================
    // GESTIÓN DEL DASHBOARD DINÁMICO
    // =============================================================================
    let dashboardState = {
        isEditMode: false,
        layoutConfig: []
    };

    const DATA_SOURCES = {
        incidentes: { label: 'Incidentes', fields: {tipo: 'Tipo', sector: 'Sector', pais: 'País', actor: 'Actor de Amenazas'} },
        exploits: { label: 'Exploits', fields: {tipo: 'Tipo', plataforma: 'Plataforma'} },
        'zero-days': { label: 'Zero Days', fields: {estado: 'Estado', plataforma: 'Plataforma'} },
        cves: { label: 'CVEs', fields: {estado: 'Estado', aplicativo: 'Aplicativo'} },
        alertas: { label: 'Alertas', fields: {criticidad: 'Criticidad'} },
        fuentes: { label: 'Fuentes Intel', fields: {tipo: 'Tipo'} },
        mitigaciones: { label: 'Mitigaciones', fields: {categoria: 'Categoría', prioridad: 'Prioridad'} }
    };

    const SPECIAL_COMPONENTS = {
        timelineChart: { label: 'Línea de Tiempo de Amenazas', defaultTitle: 'Línea de Tiempo de Amenazas' },
        dashboardAllAlerts: { label: 'Lista de Últimas Alertas', defaultTitle: 'Últimas Alertas Registradas' },
        cveEpssDashboard: { label: 'Priorización de CVEs (EPSS)', defaultTitle: 'Análisis de Vulnerabilidades (CVEs)' },
        exploitEpssDashboard: { label: 'Priorización de Exploits (EPSS)', defaultTitle: 'Análisis de Riesgo de Exploits' }
    };
    
    const SPECIAL_CHARTS_AND_TABLES = {
        exploitsByCve: { label: 'Top CVEs por Nº de Exploits', type: 'chart', defaultTitle: 'CVEs con más Exploits Públicos' },
        vulnerablePlatforms: { label: 'Plataformas/Aplicativos más Vulnerables', type: 'chart', defaultTitle: 'Tecnologías con más Vulnerabilidades' },
        exploitsWithSeverity: { label: 'Tabla de Exploits con Severidad (CVSS)', type: 'table', defaultTitle: 'Exploits Priorizados por Severidad de CVE' }
    };
    
    const DEFAULT_LAYOUT = [
        { id: 'timeline-1', type: 'special', component: 'timelineChart', title: 'Línea de Tiempo de Amenazas', size: 'col-12' },
        { id: 'cve-epss-1', type: 'special', component: 'cveEpssDashboard', title: 'Análisis de Vulnerabilidades (CVEs)', size: 'col-12'},
        { id: 'exploit-epss-1', type: 'special', component: 'exploitEpssDashboard', title: 'Análisis de Riesgo de Exploits', size: 'col-12'},
        { id: 'alerts-list-1', type: 'special', component: 'dashboardAllAlerts', title: 'Últimas Alertas Registradas', size: 'col-6' },
        { id: 'alerts-severity-1', type: 'chart', chartType: 'bar', source: 'alertas', groupBy: 'criticidad', title: 'Alertas por Criticidad', size: 'col-6' },
        { id: 'incidents-sector-1', type: 'chart', chartType: 'pie', source: 'incidentes', groupBy: 'sector', title: 'Incidentes por Sector', size: 'col-4' },
        { id: 'incidents-country-1', type: 'chart', chartType: 'pie', source: 'incidentes', groupBy: 'pais', title: 'Incidentes por País', size: 'col-4' },
        { id: 'cve-status-1', type: 'chart', chartType: 'doughnut', source: 'cves', groupBy: 'estado', title: 'CVEs por Estado', size: 'col-4' },
        { id: 'incidents-table-1', type: 'table', source: 'incidentes', title: 'Incidentes Recientes', size: 'col-12' },
    ];

    function loadLayout() {
        const savedLayout = localStorage.getItem('dashboardLayout');
        if (savedLayout) {
            dashboardState.layoutConfig = JSON.parse(savedLayout);
        } else {
            dashboardState.layoutConfig = JSON.parse(JSON.stringify(DEFAULT_LAYOUT));
        }
    }

    function saveLayout() {
        localStorage.setItem('dashboardLayout', JSON.stringify(dashboardState.layoutConfig));
    }

    function toggleEditMode() {
        dashboardState.isEditMode = !dashboardState.isEditMode;
        const btn = document.getElementById('toggleEditModeBtn');
        const addBtn = document.getElementById('addWidgetBtn');
        if (dashboardState.isEditMode) {
            btn.innerHTML = `<i class="fa-solid fa-save"></i> Guardar Cambios`;
            btn.classList.add('btn-success');
            addBtn.style.display = 'inline-flex';
        } else {
            btn.innerHTML = `<i class="fa-solid fa-edit"></i> Editar Dashboard`;
            btn.classList.remove('btn-success');
            addBtn.style.display = 'none';
            saveLayout();
        }
        renderDynamicDashboard();
    }

    function deleteWidget(widgetId) {
        if (confirm('¿Está seguro de que desea eliminar este elemento del dashboard?')) {
            dashboardState.layoutConfig = dashboardState.layoutConfig.filter(w => w.id !== widgetId);
            renderDynamicDashboard();
        }
    }

    function downloadChartImage(chartId, title) {
        const chart = chartInstances[chartId];
        if (chart) {
            const image = chart.toBase64Image();
            const link = document.createElement('a');
            link.href = image;
            link.download = `${title.replace(/ /g, '_')}.png`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        } else {
            console.error('No se encontró la instancia del gráfico para descargar:', chartId);
        }
    }
    
    // =============================================================================
    // LÓGICA DE CONEXIÓN CON API Y GESTIÓN DE DATOS (CRUD)
    // =============================================================================
    async function guardarDato(tipo, dato) {
        const id = dato._id;
        if (id) {
            delete dato._id;
        }

        const endpoint = tipo === 'zeroDays' ? 'zero-days' : tipo;
        const url = id ? `${API_BASE_URL}/${endpoint}/${id}` : `${API_BASE_URL}/${endpoint}`;
        const method = id ? 'PUT' : 'POST';

        try {
            const response = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(dato)
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || `Error ${response.status}`);
            }
            
            await fetchAndCacheAllData();
            await mostrarDatos(tipo);

            if (document.getElementById('dashboard').classList.contains('active')) {
               await renderDynamicDashboard();
            }

        } catch (error) {
            console.error(`Error al guardar en '${tipo}':`, error);
            alert(`No se pudo guardar el registro: ${error.message}`);
            throw error;
        }
    }

    async function eliminarRegistro(endpoint, id) {
        if (!confirm('¿Estás seguro de que quieres eliminar este registro?')) return;
        
        const uiType = endpoint.includes('-') ? endpoint.split('-').map((word, index) => index > 0 ? capitalFirstLetter(word) : word).join('') : endpoint;
        
        try {
            const response = await fetch(`${API_BASE_URL}/${endpoint}/${id}`, {
                method: 'DELETE'
            });

            if (!response.ok && response.status !== 204) {
                const errorData = await response.json();
                throw new Error(errorData.message || `Error ${response.status}`);
            }
            
            await fetchAndCacheAllData();
            await mostrarDatos(uiType);

            if (document.getElementById('dashboard').classList.contains('active')) {
               await renderDynamicDashboard();
            }
            console.log(`Registro ${id} de ${endpoint} eliminado con éxito.`);

        } catch (error) {
            console.error(`Error al eliminar en ${endpoint}:`, error);
            alert(`No se pudo eliminar el registro: ${error.message}`);
        }
    }

    async function mostrarDatos(tipo) {
        const endpoint = tipo === 'zeroDays' ? 'zero-days' : tipo;
        const tablaId = tipo === 'cves' ? 'tablaCVEs' : `tabla${capitalFirstLetter(tipo)}`;
        
        const tbody = document.querySelector(`#${tablaId} tbody`);
        if (!tbody) {
            console.error(`Error: No se encontró el cuerpo de la tabla con id: #${tablaId}`);
            return;
        }
        
        const datos = ALL_DATA_CACHE[endpoint] || [];
        tbody.innerHTML = ''; // Limpiar la tabla

        const formatDisplayDate = (isoDate) => isoDate ? new Date(isoDate).toLocaleDateString('es-ES', { timeZone: 'UTC' }) : 'N/A';

        if (datos.length === 0) {
            const row = tbody.insertRow();
            const cell = row.insertCell();
            const colCount = document.querySelector(`#${tablaId} thead th`)?.length || 7;
            cell.colSpan = colCount;
            cell.textContent = 'No hay registros para mostrar.';
            cell.style.textAlign = 'center';
            return;
        }
        
        datos.forEach((dato) => {
            const row = document.createElement('tr');
            let cells = '';
            
            const refLink = dato.url ? ` <a href="${dato.url}" target="_blank" rel="noopener noreferrer" title="${dato.url}"><i class="fa-solid fa-link fa-xs"></i></a>` : '';

            switch (tipo) {
                case 'incidentes':
                    cells = `<td>${formatDisplayDate(dato.fecha)}</td><td>${dato.entidad || ''}${refLink}</td><td><span class="badge badge-country">${dato.pais || 'N/A'}</span></td><td><span class="badge badge-sector">${dato.sector || 'N/A'}</span></td><td>${dato.tipo || ''}</td><td>${dato.actor || 'Desconocido'}</td>`;
                    break;
                case 'exploits':
                    cells = `<td>${formatDisplayDate(dato.fecha)}</td><td>${dato.nombre || ''}${refLink}</td><td>${dato.tipo || ''}</td><td>${dato.plataforma || ''}</td><td>${dato.cve || 'N/A'}</td>`;
                    break;
                case 'zeroDays':
                    cells = `<td>${dato.idZD || 'N/A'}</td><td>${dato.nombre || ''}${refLink}</td><td>${dato.plataforma || ''}</td><td>${formatDisplayDate(dato.fecha)}</td><td><span class="badge ${getSeverityClass(dato.cvss)}">${getSeverityText(dato.cvss)} (${dato.cvss || 'N/A'})</span></td><td><span class="badge ${getBadgeClassForZeroDayEstado(dato.estado)}">${dato.estado || ''}</span></td>`;
                    break;
                case 'cves':
                    cells = `<td>${dato.cveId || ''}${refLink}</td><td>${dato.aplicativo || ''}</td><td>${formatDisplayDate(dato.fecha)}</td><td><span class="badge ${getSeverityClass(dato.cvss)}">${getSeverityText(dato.cvss)} (${dato.cvss || 'N/A'})</span></td><td>${dato.estado || ''}</td>`;
                    break;
                case 'alertas':
                    cells = `<td>${formatDisplayDate(dato.fecha)}</td><td>${dato.titulo || ''}${refLink}</td><td><span class="badge ${getSeverityClass(dato.criticidad, true)}">${dato.criticidad || ''}</span></td><td>${(dato.descripcion || '').substring(0,50)}...</td>`;
                    break;
                case 'fuentes':
                    cells = `<td>${formatDisplayDate(dato.fecha)}</td><td>${dato.nombre || ''}</td><td>${dato.tipo || ''}</td><td>${dato.url ? `<a href="${dato.url}" target="_blank" rel="noopener noreferrer" title="${dato.url}">Link <i class="fa-solid fa-arrow-up-right-from-square fa-xs"></i></a>` : 'N/A'}</td><td>${(dato.descripcion || '').substring(0,50)}...</td>`;
                    break;
                case 'mitigaciones':
                    cells = `<td>${dato.titulo || ''}${refLink}</td><td>${dato.categoria || ''}</td><td><span class="badge ${getSeverityClass(dato.prioridad, true)}">${dato.prioridad || ''}</span></td><td>${(dato.descripcion || '').substring(0,50)}...</td>`;
                    break;
            }
            
            const editButtonHTML = `<button class="btn btn-edit" onclick="handleEditClick('${tipo}', '${dato._id}')"><i class="fa-solid fa-pencil"></i></button>`;
            const deleteButtonHTML = `<button class="btn btn-danger" onclick="eliminarRegistro('${endpoint}', '${dato._id}')"><i class="fa-solid fa-trash"></i></button>`;

            row.innerHTML = `${cells}<td class="actions-cell">${editButtonHTML}${deleteButtonHTML}</td>`;
            tbody.appendChild(row);
        });
    }

    function handleEditClick(type, id) {
        const endpoint = type === 'zeroDays' ? 'zero-days' : type;
        const item = ALL_DATA_CACHE[endpoint]?.find(d => d._id === id);

        if (!item) {
            console.error(`Item with ID ${id} not found for type ${type}`);
            alert("No se pudo encontrar el registro para editar.");
            return;
        }

        const editFunctions = {
            incidentes: populateIncidenteFormForEdit,
            exploits: populateExploitFormForEdit,
            zeroDays: populateZeroDayFormForEdit,
            cves: populateCveFormForEdit,
            alertas: populateAlertaFormForEdit,
            fuentes: populateFuenteFormForEdit,
            mitigaciones: populateMitigacionFormForEdit
        };

        if (editFunctions[type]) {
            editFunctions[type](item);
        }
    }
    
    // =============================================================================
    // INICIALIZACIÓN Y LÓGICA DE UI GENERAL
    // =============================================================================
    function parseCssVariables() {
        const styleSheets = Array.from(document.styleSheets).filter(sheet => { try { return sheet.cssRules; } catch (e) { return false; } });
        for (const sheet of styleSheets) { for (const rule of Array.from(sheet.cssRules)) { if (rule.style && rule.selectorText === ':root') { for (let i = 0; i < rule.style.length; i++) { const name = rule.style[i]; if (name.startsWith('--')) { const value = rule.style.getPropertyValue(name).trim(); if (value.startsWith('#')) {  const hex = value.substring(1); const bigint = parseInt(hex, 16); ROOT_CSS_VARIABLES[name] = { r: (bigint >> 16) & 255, g: (bigint >> 8) & 255, b: bigint & 255, hex: value }; } else { ROOT_CSS_VARIABLES[name] = value; } } } return; } } }
    }
    
    function toggleNavMenu() { document.getElementById('navMenuContainer').classList.toggle('open'); }
    
    function toggleForm(containerId, formIdToReset) {
        const container = document.getElementById(containerId);
        const isVisible = container.style.display === 'block';
        container.style.display = isVisible ? 'none' : 'block';
        if (isVisible) {
             const formPrefix = formIdToReset.replace('Form', '');
             const capitalPrefix = capitalFirstLetter(formPrefix.replace('-',''));
             const cancelBtnId = `cancel${capitalPrefix}EditBtn`;
             if(document.getElementById(cancelBtnId)?.style.display !== 'none'){
                 document.getElementById(cancelBtnId).click();
             }
        } else { container.scrollIntoView({ behavior: 'smooth', block: 'center' }); }
    }

    async function openTab(tabName) {
        document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
        document.getElementById(tabName).classList.add('active');
        
        document.querySelectorAll('#appNavigation .nav-link').forEach(link => link.classList.remove('active'));
        document.querySelector(`#appNavigation .nav-link[data-tab-name="${tabName}"]`)?.classList.add('active');

        document.getElementById('navMenuContainer').classList.remove('open');
        
        if (tabName === 'dashboard') {
             await renderDynamicDashboard();
        } else {
            const tabTypeMap = { 'incidentes': 'incidentes', 'exploits': 'exploits', 'zero-days': 'zeroDays', 'cves': 'cves', 'alertas': 'alertas', 'fuentes': 'fuentes', 'mitigaciones': 'mitigaciones' };
            const dataType = tabTypeMap[tabName];
            if (dataType) { await mostrarDatos(dataType); }
        }
    }

    function navigateToTab(tabName) { openTab(tabName); window.scrollTo({ top: 0, behavior: 'smooth' }); }

    async function fetchAndCacheAllData() {
        console.log("Attempting to fetch data from API...");
        const dataKeys = ['incidentes', 'exploits', 'zero-days', 'cves', 'alertas', 'fuentes', 'mitigaciones'];
        try {
            const promises = dataKeys.map(key => fetch(`${API_BASE_URL}/${key}`).then(res => { 
                if (!res.ok) throw new Error(`Failed to fetch ${key}: ${res.status} ${res.statusText}`); 
                return res.json(); 
            }));
            const results = await Promise.all(promises);
            dataKeys.forEach((key, index) => { ALL_DATA_CACHE[key] = results[index]; });
            console.log("Data cache updated successfully.");
        } catch (error) {
            console.error("Fatal error fetching data:", error);
            alert(`Hubo un problema crítico al cargar los datos. Verifique que el servidor backend (server.js) esté en ejecución y que la URL ${API_BASE_URL} sea correcta. Error: ${error.message}`);
        }
        
        updateGlobalStats();
    }
    
    function updateGlobalStats() {
        document.getElementById('statIncidents').textContent = (ALL_DATA_CACHE.incidentes || []).length;
        document.getElementById('statExploits').textContent = (ALL_DATA_CACHE.exploits || []).length;
        document.getElementById('statZeroDays').textContent = (ALL_DATA_CACHE['zero-days'] || []).length;
        document.getElementById('statCVEs').textContent = (ALL_DATA_CACHE.cves || []).length;
        document.getElementById('statAlerts').textContent = (ALL_DATA_CACHE.alertas || []).length;
        document.getElementById('statFuentes').textContent = (ALL_DATA_CACHE.fuentes || []).length;
        document.getElementById('statMitigaciones').textContent = (ALL_DATA_CACHE.mitigaciones || []).length;
    }

    document.addEventListener('DOMContentLoaded', async function() {
        console.log("DOM fully loaded and parsed. Initializing application.");
        parseCssVariables();
        loadLayout();
        setupWidgetModal();

        await fetchAndCacheAllData();

        document.querySelectorAll('#appNavigation .nav-link').forEach(link => { link.addEventListener('click', (e) => { e.preventDefault(); openTab(e.currentTarget.dataset.tabName); }); });
        window.onclick = (event) => { if (!event.target.matches('.menu-toggle-btn') && !event.target.closest('.dropdown-menu')) { document.getElementById('navMenuContainer').classList.remove('open'); } }

        document.getElementById('applyDashboardFilterBtn').addEventListener('click', renderDynamicDashboard);
        document.getElementById('resetDashboardFilterBtn').addEventListener('click', () => {
            document.getElementById('dashboardStartDate').value = '';
            document.getElementById('dashboardEndDate').value = '';
            renderDynamicDashboard();
        });
        
        document.getElementById('toggleEditModeBtn').addEventListener('click', toggleEditMode);

        document.getElementById('dashboardGrid').addEventListener('click', (e) => {
            const deleteBtn = e.target.closest('.delete-widget-btn');
            if (deleteBtn) {
                deleteWidget(deleteBtn.dataset.widgetId);
                return;
            }

            const editBtn = e.target.closest('.edit-widget-btn');
            if (editBtn) {
                openEditWidgetModal(editBtn.dataset.widgetId);
                return;
            }

            const downloadBtn = e.target.closest('.download-chart-btn');
            if (downloadBtn) {
                downloadChartImage(downloadBtn.dataset.chartId, downloadBtn.dataset.chartTitle);
                return;
            }
        });

        await openTab('dashboard'); 
    });

    function capitalFirstLetter(string) { return string ? string.charAt(0).toUpperCase() + string.slice(1) : ''; }
    
    function cancelEdit(formId, formTitleId, originalTitle, submitBtnId, originalSubmitText) {
        document.getElementById(formId).reset();
        const formPrefix = formId.replace('Form', ''); 
        const idField = document.getElementById(`${formPrefix}EditId`);
        if (idField) idField.value = '';
        if (formId === 'cveForm') { document.getElementById('idCVE').readOnly = false; }
        document.getElementById(formTitleId).textContent = originalTitle;
        const saveButton = document.getElementById(submitBtnId);
        if (saveButton) { saveButton.innerHTML = `<i class="fa-solid fa-save"></i> ${originalSubmitText}`; }
        const capitalPrefix = capitalFirstLetter(formPrefix.replace('-',''));
        const cancelButton = document.getElementById(`cancel${capitalPrefix}EditBtn`);
        if (cancelButton) cancelButton.style.display = 'none';
        const formContainer = document.getElementById(`${formPrefix.replace('-','')}FormContainer`);
        if (formContainer) formContainer.style.display = 'none';
    }

    // --- FORM SUBMISSIONS ---
    document.getElementById('incidenteForm').addEventListener('submit', function(e) { e.preventDefault(); const item = { _id: document.getElementById('incidenteEditId').value || null, fecha: document.getElementById('fechaIncidente').value, tipo: document.getElementById('tipoIncidente').value, entidad: document.getElementById('entidadIncidente').value, pais: document.getElementById('paisIncidente').value, sector: document.getElementById('sectorIncidente').value, descripcion: document.getElementById('descripcionIncidente').value, datosComprometidos: document.getElementById('datosComprometidosIncidente').value, actor: document.getElementById('actorIncidente').value, url: document.getElementById('urlIncidente').value }; guardarDato('incidentes', item).then(() => cancelEdit('incidenteForm', 'incidenteFormTitle', 'Registrar Incidente', 'guardarIncidenteBtn', 'Guardar Incidente')).catch(err => console.error("Save failed", err)); });
    document.getElementById('exploitForm').addEventListener('submit', function(e) { e.preventDefault(); const item = { _id: document.getElementById('exploitEditId').value || null, fecha: document.getElementById('fechaExploit').value, nombre: document.getElementById('nombreExploit').value, tipo: document.getElementById('tipoExploit').value, plataforma: document.getElementById('plataformaExploit').value, cve: document.getElementById('cveExploit').value.toUpperCase().trim(), url: document.getElementById('urlExploit').value }; guardarDato('exploits', item).then(() => cancelEdit('exploitForm', 'exploitFormTitle', 'Registrar Exploit', 'guardarExploitBtn', 'Guardar Exploit')).catch(err => console.error("Save failed", err)); });
    document.getElementById('zeroDayForm').addEventListener('submit', function(e) { e.preventDefault(); const item = { _id: document.getElementById('zeroDayEditId').value || null, idZD: document.getElementById('idZD').value.trim(), fecha: document.getElementById('fechaZD').value, nombre: document.getElementById('nombreZD').value, plataforma: document.getElementById('plataformaZD').value, cvss: parseFloat(document.getElementById('cvssZD').value) || 0, estado: document.getElementById('estadoZD').value, url: document.getElementById('urlZD').value, descripcion: document.getElementById('descripcionZD').value }; guardarDato('zero-days', item).then(() => cancelEdit('zeroDayForm', 'zeroDayFormTitle', 'Registrar Zero Day', 'guardarZeroDayBtn', 'Guardar Zero Day')).catch(err => console.error("Save failed", err)); });
    document.getElementById('cveForm').addEventListener('submit', function(e) { e.preventDefault(); const item = { _id: document.getElementById('cveEditId').value || null, cveId: document.getElementById('idCVE').value.toUpperCase().trim(), fecha: document.getElementById('fechaCVE').value, aplicativo: document.getElementById('aplicativoCVE').value, cvss: parseFloat(document.getElementById('cvssCVE').value) || 0, estado: document.getElementById('estadoCVE').value, descripcion: document.getElementById('descripcionCVE').value, url: document.getElementById('urlCVE').value }; guardarDato('cves', item).then(() => cancelEdit('cveForm', 'cveFormTitle', 'Registrar CVE', 'guardarCveBtn', 'Guardar CVE')).catch(err => console.error("Save failed", err)); });
    document.getElementById('alertaForm').addEventListener('submit', function(e) { e.preventDefault(); const item = { _id: document.getElementById('alertaEditId').value || null, titulo: document.getElementById('tituloAlerta').value, descripcion: document.getElementById('descripcionAlerta').value, criticidad: document.getElementById('criticidadAlerta').value, fecha: document.getElementById('fechaAlerta').value, url: document.getElementById('urlAlerta').value }; guardarDato('alertas', item).then(() => cancelEdit('alertaForm', 'alertaFormTitle', 'Registrar Alerta', 'guardarAlertaBtn', 'Guardar Alerta')).catch(err => console.error("Save failed", err)); });
    document.getElementById('fuenteForm').addEventListener('submit', function(e) { e.preventDefault(); const item = { _id: document.getElementById('fuenteEditId').value || null, fecha: document.getElementById('fechaFuente').value, nombre: document.getElementById('nombreFuente').value, tipo: document.getElementById('tipoFuente').value, url: document.getElementById('urlFuente').value, descripcion: document.getElementById('descripcionFuente').value }; guardarDato('fuentes', item).then(() => cancelEdit('fuenteForm', 'fuenteFormTitle', 'Registrar Fuente', 'guardarFuenteBtn', 'Guardar Fuente')).catch(err => console.error("Save failed", err)); });
    document.getElementById('mitigacionForm').addEventListener('submit', function(e) { e.preventDefault(); const item = { _id: document.getElementById('mitigacionEditId').value || null, fecha: document.getElementById('fechaMitigacion').value, titulo: document.getElementById('tituloMitigacion').value, categoria: document.getElementById('categoriaMitigacion').value, prioridad: document.getElementById('prioridadMitigacion').value, descripcion: document.getElementById('descripcionMitigacion').value, url: document.getElementById('urlMitigacion').value }; guardarDato('mitigaciones', item).then(() => cancelEdit('mitigacionForm', 'mitigacionFormTitle', 'Registrar Mitigación', 'guardarMitigacionBtn', 'Guardar Mitigación')).catch(err => console.error("Save failed", err)); });

    // --- POPULATE FORMS FOR EDIT ---
    const formatInputDate = (isoDate) => isoDate ? new Date(isoDate).toISOString().split('T')[0] : '';
    function populateFormAndShow(formPrefix, capitalPrefix) { const formContainer = document.getElementById(`${formPrefix.replace('-','')}FormContainer`); if (formContainer) { formContainer.style.display = 'block'; formContainer.scrollIntoView({ behavior: 'smooth', block: 'center' }); } document.getElementById(`${formPrefix.replace('-','')}FormTitle`).textContent = `Editar ${capitalPrefix === 'ZeroDay' ? 'Zero Day' : capitalPrefix}`; document.getElementById(`guardar${capitalPrefix}Btn`).innerHTML = `<i class="fa-solid fa-save"></i> Actualizar`; document.getElementById(`cancel${capitalPrefix}EditBtn`).style.display = 'inline-flex'; }
    function populateIncidenteFormForEdit(item) { if (item) { document.getElementById('incidenteEditId').value = item._id; document.getElementById('fechaIncidente').value = formatInputDate(item.fecha); document.getElementById('tipoIncidente').value = item.tipo; document.getElementById('entidadIncidente').value = item.entidad; document.getElementById('paisIncidente').value = item.pais; document.getElementById('sectorIncidente').value = item.sector; document.getElementById('descripcionIncidente').value = item.descripcion; document.getElementById('datosComprometidosIncidente').value = item.datosComprometidos; document.getElementById('actorIncidente').value = item.actor; document.getElementById('urlIncidente').value = item.url || ''; populateFormAndShow('incidente', 'Incidente'); } }
    function populateExploitFormForEdit(item) { if (item) { document.getElementById('exploitEditId').value = item._id; document.getElementById('fechaExploit').value = formatInputDate(item.fecha); document.getElementById('nombreExploit').value = item.nombre; document.getElementById('tipoExploit').value = item.tipo; document.getElementById('plataformaExploit').value = item.plataforma; document.getElementById('cveExploit').value = item.cve; document.getElementById('urlExploit').value = item.url || ''; populateFormAndShow('exploit', 'Exploit'); } }
    function populateZeroDayFormForEdit(item) { if (item) { document.getElementById('zeroDayEditId').value = item._id; document.getElementById('idZD').value = item.idZD; document.getElementById('fechaZD').value = formatInputDate(item.fecha); document.getElementById('nombreZD').value = item.nombre; document.getElementById('plataformaZD').value = item.plataforma; document.getElementById('cvssZD').value = item.cvss; document.getElementById('estadoZD').value = item.estado; document.getElementById('urlZD').value = item.url || ''; document.getElementById('descripcionZD').value = item.descripcion; populateFormAndShow('zeroDay', 'ZeroDay'); } }
    function populateCveFormForEdit(item) { if (item) { document.getElementById('cveEditId').value = item._id; document.getElementById('idCVE').value = item.cveId; document.getElementById('idCVE').readOnly = true; document.getElementById('fechaCVE').value = formatInputDate(item.fecha); document.getElementById('aplicativoCVE').value = item.aplicativo; document.getElementById('cvssCVE').value = item.cvss; document.getElementById('estadoCVE').value = item.estado; document.getElementById('descripcionCVE').value = item.descripcion; document.getElementById('urlCVE').value = item.url || ''; populateFormAndShow('cve', 'Cve'); } }
    function populateAlertaFormForEdit(item) { if (item) { document.getElementById('alertaEditId').value = item._id; document.getElementById('tituloAlerta').value = item.titulo; document.getElementById('fechaAlerta').value = formatInputDate(item.fecha); document.getElementById('descripcionAlerta').value = item.descripcion; document.getElementById('criticidadAlerta').value = item.criticidad; document.getElementById('urlAlerta').value = item.url || ''; populateFormAndShow('alerta', 'Alerta'); } }
    function populateFuenteFormForEdit(item) { if (item) { document.getElementById('fuenteEditId').value = item._id; document.getElementById('fechaFuente').value = formatInputDate(item.fecha); document.getElementById('nombreFuente').value = item.nombre; document.getElementById('tipoFuente').value = item.tipo; document.getElementById('urlFuente').value = item.url || ''; document.getElementById('descripcionFuente').value = item.descripcion; populateFormAndShow('fuente', 'Fuente'); } }
    function populateMitigacionFormForEdit(item) { if (item) { document.getElementById('mitigacionEditId').value = item._id; document.getElementById('fechaMitigacion').value = formatInputDate(item.fecha); document.getElementById('tituloMitigacion').value = item.titulo; document.getElementById('categoriaMitigacion').value = item.categoria; document.getElementById('descripcionMitigacion').value = item.descripcion; document.getElementById('prioridadMitigacion').value = item.prioridad; document.getElementById('urlMitigacion').value = item.url || ''; populateFormAndShow('mitigacion', 'Mitigacion'); } }
    
    // --- UTILITY & SEARCH FUNCTIONS ---
    function searchTable(inputId, tableId, searchColumns) { const input = document.getElementById(inputId); const filter = input.value.toUpperCase(); const table = document.getElementById(tableId); const tr = table.getElementsByTagName("tr"); for (let i = 1; i < tr.length; i++) { let found = false; for (const colIndex of searchColumns) { const td = tr[i].getElementsByTagName("td")[colIndex]; if (td) { const txtValue = td.textContent || td.innerText; if (txtValue.toUpperCase().indexOf(filter) > -1) { found = true; break; } } } tr[i].style.display = found ? "" : "none"; } }
    function buscarIncidentes() { searchTable('searchIncidentes', 'tablaIncidentes', [0, 1, 2, 3, 4, 5]); }
    function buscarExploits() { searchTable('searchExploits', 'tablaExploits', [0, 1, 2, 3, 4]); }
    function buscarZeroDays() { searchTable('searchZeroDays', 'tablaZeroDays', [0, 1, 2, 3, 5]); }
    function buscarCVEs() { searchTable('searchCVEs', 'tablaCVEs', [0, 1, 2, 4]); }
    function buscarAlertas() { searchTable('searchAlertas', 'tablaAlertas', [0, 1, 3]); } 
    function buscarFuentes() { searchTable('searchFuentes', 'tablaFuentes', [0, 1, 2, 4]); }
    function buscarMitigaciones() { searchTable('searchMitigaciones', 'tablaMitigaciones', [0, 1, 3]); }
    
    // =============================================================================
    // DYNAMIC DASHBOARD & CHARTING FUNCTIONS (VERSIÓN CORREGIDA Y ROBUSTA)
    // =============================================================================
    function getFilteredData() {
        const startDateStr = document.getElementById('dashboardStartDate').value;
        const endDateStr = document.getElementById('dashboardEndDate').value;
        
        const dashboardDateEl = document.getElementById('dashboardDate');
        if (startDateStr && endDateStr) {
            dashboardDateEl.textContent = `Mostrando datos desde ${startDateStr} hasta ${endDateStr}.`;
        } else {
            dashboardDateEl.textContent = `Mostrando todos los datos registrados.`;
        }
        
        const filterByDate = (item) => {
            if (!startDateStr || !endDateStr) return true;
            if (!item.fecha) return true; 
            const itemDate = new Date(item.fecha); 
            const startDate = new Date(startDateStr);
            const endDate = new Date(endDateStr);
            endDate.setHours(23, 59, 59, 999);
            return itemDate >= startDate && itemDate <= endDate;
        };
        
        const filteredCache = {};
        for(const key in ALL_DATA_CACHE) {
             filteredCache[key] = (ALL_DATA_CACHE[key] || []).filter(filterByDate);
        }
        return filteredCache;
    }

    async function renderDynamicDashboard() {
        console.log("Rendering dynamic dashboard...");
        const grid = document.getElementById('dashboardGrid');
        grid.innerHTML = ''; 

        Object.values(chartInstances).forEach(chart => chart.destroy());
        chartInstances = {};

        for (const widget of dashboardState.layoutConfig) {
            const card = document.createElement('div');
            card.className = `card ${widget.size}`;
            card.dataset.widgetId = widget.id;

            let headerControlsHTML = '';
            if (dashboardState.isEditMode) {
                headerControlsHTML += `<button class="widget-control-btn edit edit-widget-btn" data-widget-id="${widget.id}" title="Editar Widget"><i class="fa-solid fa-pencil"></i></button>`;
                headerControlsHTML += `<button class="widget-control-btn delete delete-widget-btn" data-widget-id="${widget.id}" title="Eliminar Widget"><i class="fa-solid fa-trash"></i></button>`;
            }
            
            const isChart = widget.type === 'chart' || (widget.type === 'special' && (widget.component === 'timelineChart' || widget.component.includes('Epss')));
            if (isChart) {
                headerControlsHTML = `<button class="widget-control-btn download-chart-btn" data-chart-id="chart-${widget.id}" data-chart-title="${widget.title}" title="Descargar como PNG"><i class="fa-solid fa-camera"></i></button>` + headerControlsHTML;
            }

            card.innerHTML = `
                <div class="card-header">
                    <h2 class="card-title">${widget.title}</h2>
                    <div class="widget-header-controls">${headerControlsHTML}</div>
                </div>
                <div class="card-body" id="body-${widget.id}"></div>
            `;
            grid.appendChild(card);
            
            const cardBody = document.getElementById(`body-${widget.id}`);
            
            if (widget.type === 'chart') {
                if (widget.source.startsWith('corr_')) {
                    const chartType = widget.source.substring(5); // ej: "exploitsByCve"
                    if (chartType === 'exploitsByCve') {
                        renderExploitsByCveChart(widget, cardBody);
                    } else if (chartType === 'vulnerablePlatforms') {
                        renderVulnerablePlatformsChart(widget, cardBody);
                    }
                } else {
                    renderChartWidget(widget, cardBody);
                }
            } else if (widget.type === 'table') {
                if (widget.source.startsWith('corr_')) {
                    const tableType = widget.source.substring(5);
                    if (tableType === 'exploitsWithSeverity') {
                        renderExploitsWithSeverityTable(widget, cardBody);
                    }
                } else {
                    renderTableWidget(widget, cardBody);
                }
            } else if (widget.type === 'special') {
                renderSpecialWidget(widget, cardBody);
            }
        }
        console.log("Dashboard rendered.");
    }

    function renderChartWidget(widget, container) {
        const filteredData = getFilteredData();
        const canvasId = `chart-${widget.id}`;
        container.innerHTML = `<div class="chart-container"><canvas id="${canvasId}"></canvas></div>`;

        const sourceData = filteredData[widget.source] || [];
        const data = sourceData.reduce((acc, curr) => {
            const key = curr[widget.groupBy] || 'Sin categoría';
            acc[key] = (acc[key] || 0) + 1;
            return acc;
        }, {});
        
        const labels = Object.keys(data);
        const values = Object.values(data);
        
        const chartColors = ['#3498db', '#2ecc71', '#f1c40f', '#e74c3c', '#9b59b6', '#34495e', '#1abc9c', '#e67e22'];

        let config = {
            type: widget.chartType,
            data: { labels, datasets: [{ label: `Nº de ${widget.source}`, data: values, backgroundColor: chartColors, borderColor: '#fff', borderWidth: 1 }] },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: (widget.chartType === 'bar' || widget.chartType === 'radar') ? 'top' : 'bottom' } } }
        };
        if (widget.chartType === 'bar') {
            config.options.scales = { y: { beginAtZero: true, ticks: { precision: 0 } } };
            config.options.plugins.legend.display = false;
        }
        if (widget.chartType === 'radar') {
            config.options.scales = { r: { angleLines: { display: true }, suggestedMin: 0, ticks: { precision: 0 } } };
        }
        createOrUpdateChart(canvasId, config);
    }

    function renderTableWidget(widget, container) {
        const filteredData = getFilteredData();
        container.innerHTML = `<div class="table-container"><table id="table-${widget.id}"><thead></thead><tbody></tbody></table></div>`;
        const table = document.getElementById(`table-${widget.id}`);
        const data = (filteredData[widget.source] || []).sort((a,b) => new Date(b.fecha) - new Date(a.fecha)).slice(0, 5);
        if(data.length === 0) { container.innerHTML = `<p>No hay datos para el período seleccionado.</p>`; return; }

        let headers = '';
        let bodyHTML = '';
        switch(widget.source) {
            case 'incidentes':
                headers = `<tr><th>Fecha</th><th>Entidad</th><th>País</th><th>Sector</th><th>Tipo</th></tr>`;
                bodyHTML = data.map(item => `<tr><td>${new Date(item.fecha).toLocaleDateString('es-ES',{timeZone:'UTC'})}</td><td>${item.entidad}</td><td>${item.pais || 'N/A'}</td><td>${item.sector || 'N/A'}</td><td>${item.tipo}</td></tr>`).join('');
                break;
            case 'cves':
                headers = `<tr><th>ID</th><th>Aplicativo</th><th>Severidad</th><th>CVSS</th></tr>`;
                bodyHTML = data.map(item => `<tr><td>${item.cveId}</td><td>${item.aplicativo}</td><td><span class="badge ${getSeverityClass(item.cvss)}">${getSeverityText(item.cvss)}</span></td><td>${item.cvss}</td></tr>`).join('');
                break;
            case 'exploits':
                headers = `<tr><th>Fecha</th><th>Nombre</th><th>Tipo</th><th>Plataforma</th></tr>`;
                bodyHTML = data.map(item => `<tr><td>${new Date(item.fecha).toLocaleDateString('es-ES',{timeZone:'UTC'})}</td><td>${item.nombre}</td><td>${item.tipo}</td><td>${item.plataforma}</td></tr>`).join('');
                break;
            case 'zero-days':
                headers = `<tr><th>ID</th><th>Nombre</th><th>Fecha</th><th>Estado</th><th>CVSS</th></tr>`;
                bodyHTML = data.map(item => `<tr><td>${item.idZD || 'N/A'}</td><td>${item.nombre}</td><td>${new Date(item.fecha).toLocaleDateString('es-ES',{timeZone:'UTC'})}</td><td>${item.estado}</td><td>${item.cvss}</td></tr>`).join('');
                break;
        }
        table.querySelector('thead').innerHTML = headers;
        table.querySelector('tbody').innerHTML = bodyHTML;
    }

    function renderSpecialWidget(widget, container) {
        switch(widget.component) {
            case 'timelineChart':
                container.innerHTML = `<div class="chart-container" style="height: 350px;"><canvas id="chart-${widget.id}"></canvas></div>`;
                renderTimelineChart(`chart-${widget.id}`);
                break;
            case 'dashboardAllAlerts':
                container.innerHTML = `<div class="dashboard-alerts-container" id="alerts-${widget.id}"></div>`;
                renderDashboardAllAlerts(document.getElementById(`alerts-${widget.id}`));
                break;
            case 'cveEpssDashboard':
                renderCveEpssWidget(container, widget);
                break;
            case 'exploitEpssDashboard':
                renderExploitEpssWidget(container, widget);
                break;
        }
    }
    
    function createOrUpdateChart(chartId, chartConfig) {
        const ctx = document.getElementById(chartId)?.getContext('2d');
        if(!ctx) { console.warn(`Canvas with ID ${chartId} not found.`); return; }
        if (chartInstances[chartId]) {
            chartInstances[chartId].destroy(); 
        }
        chartInstances[chartId] = new Chart(ctx, chartConfig);
    }
    
    function getSeverityText(cvss) {
        const score = parseFloat(cvss);
        if (isNaN(score)) return 'N/A';
        if (score >= 9.0) return 'Crítica'; 
        if (score >= 7.0) return 'Alta';
        if (score >= 4.0) return 'Media'; 
        if (score > 0) return 'Baja'; 
        return 'Info';
    }

    function getSeverityClass(level, isAlertOrPriority = false) {
        if (isAlertOrPriority) {
            switch(String(level)?.toLowerCase()) {
                case 'critica': case 'crítica': return 'badge-critical';
                case 'alta': return 'badge-high';
                case 'media': return 'badge-medium';
                case 'baja': return 'badge-low';
                default: return 'badge-info'; 
            }
        } else {
            const score = parseFloat(level);
            if (score >= 9.0) return 'badge-critical';
            if (score >= 7.0) return 'badge-high';
            if (score >= 4.0) return 'badge-medium';
            if (score > 0) return 'badge-low';
            return 'badge-info';
        }
    }

    function getAlertItemClass(criticidad) {
        switch(String(criticidad)?.toLowerCase()) {
            case 'critica': case 'crítica': return 'critical-alert';
            case 'alta': return 'high-alert';
            case 'media': return 'medium-alert';
            case 'baja': return 'low-alert';
            default: return 'info-alert'; 
        }
    }
    
    function getAlertIcon(criticidad) {
        switch(String(criticidad)?.toLowerCase()) {
            case 'critica': case 'crítica': return '🚨';
            case 'alta': return '⚠️';
            case 'media': return '🟠'; 
            case 'baja': return '🟢';
            default: return 'ℹ️'; 
        }
    }

    function getBadgeClassForZeroDayEstado(estado) {
        switch (String(estado)?.toLowerCase()) {
            case 'activo': return 'badge-estado-activo';
            case 'mitigado': return 'badge-estado-mitigado';
            case 'en investigación': case 'investigacion': return 'badge-estado-investigacion';
            case 'prueba de concepto': case 'pruebadeconcepto': return 'badge-estado-poc';
            default: return 'badge-info';
        }
    }

    // =============================================================================
    // WIDGETS ESPECIALES (INCLUYE EPSS Y NUEVOS GRÁFICOS)
    // =============================================================================

    function renderDashboardAllAlerts(container) {
        const alertas = getFilteredData().alertas;
        container.innerHTML = ''; 
        if (!alertas || alertas.length === 0) {
            container.innerHTML = '<p>No hay alertas para el período seleccionado.</p>';
            return;
        }
        const sortedAlerts = [...alertas].sort((a,b) => new Date(b.fecha) - new Date(a.fecha));
        sortedAlerts.slice(0, 10).forEach(alerta => {
            const itemDiv = document.createElement('div');
            itemDiv.className = `alert-dashboard-item ${getAlertItemClass(alerta.criticidad)}`;
            itemDiv.innerHTML = `<div class="alert-icon">${getAlertIcon(alerta.criticidad)}</div><div class="alert-content"><h3>${alerta.titulo}</h3><p>${(alerta.descripcion || '').substring(0, 120)}...</p><span class="alert-date">Fecha: ${new Date(alerta.fecha).toLocaleDateString('es-ES',{timeZone:'UTC'})} | Criticidad: ${alerta.criticidad}</span></div>`;
            container.appendChild(itemDiv);
        });
    }

    function renderTimelineChart(canvasId) {
        const filteredData = getFilteredData();
        const { incidentes, exploits, 'zero-days': zeroDays, cves } = filteredData;
        const { startDateStr, endDateStr } = { 
            startDateStr: document.getElementById('dashboardStartDate').value,
            endDateStr: document.getElementById('dashboardEndDate').value
         };

        const dataPoints = {};
        let labels = [];

        if (startDateStr && endDateStr) {
            let currentDate = new Date(startDateStr + 'T00:00:00Z');
            const endDate = new Date(endDateStr + 'T00:00:00Z');
            while(currentDate <= endDate) {
                const dateString = currentDate.toISOString().split('T')[0];
                dataPoints[dateString] = { incidents: 0, exploits: 0, zeroDays: 0, cves: 0 };
                labels.push(new Date(currentDate));
                currentDate.setUTCDate(currentDate.getUTCDate() + 1);
            }
        } else {
            for (let i = 29; i >= 0; i--) {
                const d = new Date();
                d.setUTCHours(0, 0, 0, 0);
                d.setUTCDate(d.getUTCDate() - i);
                const dateString = d.toISOString().split('T')[0];
                dataPoints[dateString] = { incidents: 0, exploits: 0, zeroDays: 0, cves: 0 };
                labels.push(d);
            }
        }
        
        const processItems = (items, typeKey) => { if (Array.isArray(items)) { items.forEach(item => { if (item?.fecha) { const dateString = new Date(item.fecha).toISOString().split('T')[0]; if (dataPoints.hasOwnProperty(dateString)) { dataPoints[dateString][typeKey]++; } } }); } };
        processItems(incidentes, 'incidents');
        processItems(exploits, 'exploits');
        processItems(zeroDays, 'zeroDays');
        processItems(cves, 'cves');
        const sortedDateStrings = Object.keys(dataPoints).sort((a, b) => new Date(a) - new Date(b));

        createOrUpdateChart(canvasId, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    { label: 'Incidentes', data: sortedDateStrings.map(d => dataPoints[d]?.incidents || 0), borderColor: ROOT_CSS_VARIABLES['--danger']?.hex || '#e74c3c', backgroundColor: (ROOT_CSS_VARIABLES['--danger']?.hex || '#e74c3c') + '1A', tension: 0.3, fill: true }, 
                    { label: 'Exploits', data: sortedDateStrings.map(d => dataPoints[d]?.exploits || 0), borderColor: ROOT_CSS_VARIABLES['--secondary']?.hex || '#3498db', backgroundColor: (ROOT_CSS_VARIABLES['--secondary']?.hex || '#3498db') + '1A', tension: 0.3, fill: true }, 
                    { label: 'ZeroDays', data: sortedDateStrings.map(d => dataPoints[d]?.zeroDays || 0), borderColor: ROOT_CSS_VARIABLES['--success']?.hex || '#2ecc71', backgroundColor: (ROOT_CSS_VARIABLES['--success']?.hex || '#2ecc71') + '1A', tension: 0.3, fill: true }, 
                    { label: 'CVEs', data: sortedDateStrings.map(d => dataPoints[d]?.cves || 0), borderColor: ROOT_CSS_VARIABLES['--warning']?.hex || '#f39c12', backgroundColor: (ROOT_CSS_VARIABLES['--warning']?.hex || '#f39c12') + '1A', tension: 0.3, fill: true }
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                scales: { x: { type: 'time', time: { unit: labels.length > 60 ? 'month' : (labels.length > 7 ? 'week' : 'day'), tooltipFormat: 'dd/MM/yyyy', displayFormats: { day: 'dd MMM', week: 'dd MMM', month: 'MMM yyyy' } }, ticks: { source: 'auto', maxRotation: 0, autoSkip: true } }, y: { beginAtZero: true, ticks: { stepSize: 1, precision: 0 } } },
                plugins: { legend: { position: 'top' }, tooltip: { mode: 'index', intersect: false } },
                interaction: { mode: 'index', intersect: false }
            }
        });
    }

    async function renderCveEpssWidget(container, widget) {
        container.innerHTML = `<div class="epss-dashboard cve">
            <div class="epss-loader" id="loader-${widget.id}">Cargando datos...</div>
            <div id="stats-${widget.id}" style="display: none;"></div>
            <div class="epss-content-grid" id="content-${widget.id}" style="display: none;">
                <div class="chart-container"><canvas id="chart-${widget.id}"></canvas></div>
                <div class="table-container"><h3>CVEs de Alta Prioridad</h3><div id="table-${widget.id}"></div></div>
            </div>
        </div>`;
        const loader = document.getElementById(`loader-${widget.id}`);
        try {
            const cves = getFilteredData().cves || [];
            if (!cves.length) { loader.innerHTML = 'No hay CVEs para analizar en el período seleccionado.'; return; }
            
            loader.textContent = `Enriqueciendo ${cves.length} CVEs con datos de EPSS...`;
            const epssPromises = cves.map(cve => fetch(`${EPSS_API_URL}${cve.cveId}`).then(res => res.ok ? res.json() : null));
            const epssResults = await Promise.all(epssPromises);

            const enrichedData = cves.map((cve, i) => ({ ...cve, epssScore: (epssResults[i]?.data.length > 0) ? parseFloat(epssResults[i].data[0].epss) : 0 }));
            
            const highPriority = enrichedData.filter(c => c.epssScore > 0.5);
            document.getElementById(`stats-${widget.id}`).innerHTML = `<div class="epss-stats-grid">
                <div class="epss-stat-card"><div class="epss-stat-value">${enrichedData.length}</div><div class="epss-stat-label">CVEs Analizados</div></div>
                <div class="epss-stat-card"><div class="epss-stat-value">${highPriority.length}</div><div class="epss-stat-label">Alta Prob. (>50%)</div></div>
            </div>`;
            
            renderScatterChart(document.getElementById(`chart-${widget.id}`), enrichedData, 'cve');
            renderPriorityTable(document.getElementById(`table-${widget.id}`), highPriority.sort((a,b) => b.epssScore - a.epssScore), ['cveId', 'epssScore', 'cvss']);
            
            loader.style.display = 'none';
            document.getElementById(`stats-${widget.id}`).style.display = 'block';
            document.getElementById(`content-${widget.id}`).style.display = 'grid';

        } catch (error) { loader.innerHTML = `<strong>Error:</strong> ${error.message}.`; }
    }

async function renderExploitEpssWidget(container, widget) {
    container.innerHTML = `<div class="epss-dashboard exploit">
        <div class="epss-loader" id="loader-${widget.id}">Cargando y correlacionando datos...</div>
        <div id="stats-${widget.id}" style="display: none;"></div>
        <div class="epss-content-grid" id="content-${widget.id}" style="display: none;">
            <div class="chart-container"><canvas id="chart-${widget.id}"></canvas></div>
            <div class="table-container"><h3>Exploits de Alto Riesgo</h3><div id="table-${widget.id}"></div></div>
        </div>
    </div>`;
    const loader = document.getElementById(`loader-${widget.id}`);

    try {
        const { exploits, cves } = getFilteredData();
        const exploitsWithCVEs = (exploits || []).filter(e => e.cve && e.cve.trim() !== '');
        
        if (!exploitsWithCVEs.length) {
            loader.innerHTML = 'No hay exploits con CVEs asociados en el período seleccionado.';
            return;
        }

        const cveMap = (cves || []).reduce((map, cve) => {
            map[cve.cveId.toUpperCase().trim()] = cve;
            return map;
        }, {});

        loader.textContent = `Analizando ${exploitsWithCVEs.length} exploits (consultando CVSS y EPSS)...`;

        const enrichmentPromises = exploitsWithCVEs.map(async (exploit) => {
            const cveId = exploit.cve.replace(/\s+/g, '-').toUpperCase().trim();
            let cvss = -1; // Usamos -1 como indicador de "no encontrado" o "error"
            let epssScore = 0;

            // --- 1. Obtener CVSS (de la caché local o del backend) ---
            if (cveMap[cveId]) {
                cvss = cveMap[cveId].cvss || 0;
            } else {
                try {
                    const response = await fetch(`${API_BASE_URL}/cve-details/${cveId}`);
                    if (response.ok) {
                        const cveDetails = await response.json();
                        cvss = cveDetails.cvss;
                    } else {
                         console.warn(`[CVSS Fetch] El backend respondió con error ${response.status} para ${cveId}`);
                    }
                } catch (e) {
                    console.error(`[CVSS Fetch] Fallo de red al consultar ${cveId}:`, e.message);
                }
            }

            // --- 2. Obtener EPSS (directamente de la API externa) ---
            try {
                const epssRes = await fetch(`${EPSS_API_URL}${cveId}`);
                if (epssRes.ok) {
                    const epssData = await epssRes.json();
                    epssScore = (epssData?.data.length > 0) ? parseFloat(epssData.data[0].epss) : 0;
                } else {
                    console.warn(`[EPSS Fetch] La API de EPSS respondió con error ${epssRes.status} para ${cveId}`);
                }
            } catch(e) {
                console.error(`[EPSS Fetch] Fallo de red al consultar EPSS para ${cveId}:`, e.message);
            }
            
            // Si el CVSS no se pudo encontrar (-1), lo convertimos a 0 para que el gráfico no falle.
            return { ...exploit, cve: cveId, cvss: cvss < 0 ? 0 : cvss, epssScore };
        });

        const enrichedData = await Promise.all(enrichmentPromises);

        const highPriority = enrichedData.filter(e => e.epssScore > 0.5);
        document.getElementById(`stats-${widget.id}`).innerHTML = `<div class="epss-stats-grid">
            <div class="epss-stat-card"><div class="epss-stat-value">${enrichedData.length}</div><div class="epss-stat-label">Exploits Analizados</div></div>
            <div class="epss-stat-card"><div class="epss-stat-value">${highPriority.length}</div><div class="epss-stat-label">Alto Riesgo (>50%)</div></div>
        </div>`;

        renderScatterChart(document.getElementById(`chart-${widget.id}`), enrichedData, 'exploit');
        renderPriorityTable(document.getElementById(`table-${widget.id}`), highPriority.sort((a,b) => b.epssScore - a.epssScore), ['nombre', 'cve', 'epssScore']);

        loader.style.display = 'none';
        document.getElementById(`stats-${widget.id}`).style.display = 'block';
        document.getElementById(`content-${widget.id}`).style.display = 'grid';

    } catch (error) {
        loader.innerHTML = `<strong>Error al renderizar el widget de análisis de exploits:</strong> ${error.message}.`;
        console.error("Error in renderExploitEpssWidget:", error);
    }
} 
   function renderScatterChart(canvas, data, type) {
        const options = {
            cve: { color: 'var(--primary-cve)', tooltip: c => [c.raw.cveId, `CVSS: ${c.raw.x.toFixed(1)}`, `EPSS: ${(c.raw.y * 100).toFixed(2)}%`] },
            exploit: { color: 'var(--primary-exploit)', tooltip: c => [c.raw.nombre, `CVE: ${c.raw.cve}`, `CVSS: ${c.raw.x > 0 ? c.raw.x.toFixed(1) : 'N/A'}`, `EPSS: ${(c.raw.y * 100).toFixed(2)}%`] }
        };
        const chartId = canvas.id;
        if (chartInstances[chartId]) chartInstances[chartId].destroy();
        chartInstances[chartId] = new Chart(canvas.getContext('2d'), {
            type: 'scatter',
            data: { datasets: [{
                label: 'Items', data: data.map(d => ({...d, x: d.cvss, y: d.epssScore})),
                backgroundColor: options[type].color + 'B3', pointRadius: 6, pointHoverRadius: 9
            }] },
            options: {
                responsive: true, maintainAspectRatio: false,
                scales: { x: { title: { display: true, text: 'Severidad (CVSS)' }, min: 0, max: 10 }, y: { title: { display: true, text: 'Probabilidad (EPSS)' }, min: 0, max: 1, ticks: { callback: v => (v*100).toFixed(0)+'%' } } },
                plugins: { legend: { display: false }, tooltip: { callbacks: { label: options[type].tooltip } } }
            }
        });
    }

    function renderPriorityTable(container, data, columns) {
        if (!data.length) { container.innerHTML = '<p>No hay elementos de alta prioridad.</p>'; return; }
        let tableHTML = '<table><thead><tr>' + columns.map(c => `<th>${c.charAt(0).toUpperCase() + c.slice(1)}</th>`).join('') + '</tr></thead><tbody>';
        data.forEach(item => {
            tableHTML += '<tr>' + columns.map(col => {
                let val = item[col];
                if (col === 'epssScore') val = `${(val * 100).toFixed(1)}%`;
                else if (col === 'cvss') val = `<span class="badge ${getSeverityClass(item.cvss)}">${item.cvss > 0 ? item.cvss.toFixed(1) : 'N/A'}</span>`;
                return `<td>${val || 'N/A'}</td>`;
            }).join('') + '</tr>';
        });
        container.innerHTML = tableHTML + '</tbody></table>';
    }

    function renderExploitsByCveChart(widget, container) {
        const filteredData = getFilteredData();
        const canvasId = `chart-${widget.id}`;
        container.innerHTML = `<div class="chart-container"><canvas id="${canvasId}"></canvas></div>`;
        const exploits = filteredData.exploits || [];

        const cveCounts = exploits.reduce((acc, exploit) => {
            if (exploit.cve && exploit.cve.trim() !== '') {
                acc[exploit.cve] = (acc[exploit.cve] || 0) + 1;
            }
            return acc;
        }, {});

        const sortedCVEs = Object.entries(cveCounts).sort((a, b) => b[1] - a[1]).slice(0, 10); // Top 10

        const labels = sortedCVEs.map(entry => entry[0]);
        const data = sortedCVEs.map(entry => entry[1]);

        createOrUpdateChart(canvasId, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Nº de Exploits Públicos',
                    data: data,
                    backgroundColor: 'rgba(231, 76, 60, 0.7)',
                    borderColor: 'rgba(192, 57, 43, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                indexAxis: 'y', // Gráfico de barras horizontales para mejor lectura de IDs de CVE
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: { x: { beginAtZero: true, ticks: { precision: 0 } } }
            }
        });
    }

    function renderVulnerablePlatformsChart(widget, container) {
        const filteredData = getFilteredData();
        const canvasId = `chart-${widget.id}`;
        container.innerHTML = `<div class="chart-container"><canvas id="${canvasId}"></canvas></div>`;

        const platformCounts = {};
        const countItem = (item, field) => {
            if (item[field] && item[field].trim() !== '') {
                const key = item[field].trim();
                platformCounts[key] = (platformCounts[key] || 0) + 1;
            }
        };

        (filteredData.cves || []).forEach(item => countItem(item, 'aplicativo'));
        (filteredData.exploits || []).forEach(item => countItem(item, 'plataforma'));
        (filteredData['zero-days'] || []).forEach(item => countItem(item, 'plataforma'));

        const sortedPlatforms = Object.entries(platformCounts).sort((a, b) => b[1] - a[1]).slice(0, 10); // Top 10

        const labels = sortedPlatforms.map(entry => entry[0]);
        const data = sortedPlatforms.map(entry => entry[1]);

        createOrUpdateChart(canvasId, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Nº de Vulnerabilidades/Exploits',
                    data: data,
                    backgroundColor: 'rgba(44, 62, 80, 0.7)',
                    borderColor: 'rgba(52, 73, 94, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }
            }
        });
    }

    async function renderExploitsWithSeverityTable(widget, container) {
    const filteredData = getFilteredData();
    container.innerHTML = `<div class="table-container"><table id="table-${widget.id}"><thead></thead><tbody></tbody></table></div>`;
    const table = document.getElementById(`table-${widget.id}`);
    const exploits = filteredData.exploits || [];
    const cves = filteredData.cves || [];

    if (exploits.length === 0) {
        container.innerHTML = `<p>No hay exploits para mostrar en el período seleccionado.</p>`;
        return;
    }

    const cveCvssMap = cves.reduce((map, cve) => {
        map[cve.cveId.toUpperCase().trim()] = cve.cvss;
        return map;
    }, {});
    
    // 1. Enriquecimiento inicial y preparación de peticiones
    const enrichmentPromises = exploits.map(async (exploit) => {
        const cveId = exploit.cve ? exploit.cve.toUpperCase().trim() : null;
        let cvss = 0;

        if (cveId) {
            if (cveCvssMap[cveId] !== undefined) {
                cvss = cveCvssMap[cveId];
            } else {
                // Si no está en local, consulta la API
                try {
                    const response = await fetch(`${API_BASE_URL}/cve-details/${cveId}`);
                    if (response.ok) {
                        const cveDetails = await response.json();
                        cvss = cveDetails.cvss;
                        // Opcional: añadir a la caché local para futuras búsquedas rápidas
                        cveCvssMap[cveId] = cvss;
                    }
                } catch (e) {
                    console.warn(`Could not fetch CVSS for ${cveId}`, e);
                }
            }
        }
        return { ...exploit, cve: cveId, cvss };
    });
    
    const enrichedExploits = await Promise.all(enrichmentPromises);

    // 2. Renderizar la tabla con los datos ya enriquecidos y ordenados
    const sortedExploits = enrichedExploits.sort((a, b) => b.cvss - a.cvss);

    const headers = `<tr><th>Nombre del Exploit</th><th>CVE Asociado</th><th>Severidad (CVSS)</th></tr>`;
    const bodyHTML = sortedExploits.map(item => `
        <tr>
            <td>${item.nombre}</td>
            <td>${item.cve || 'N/A'}</td>
            <td><span class="badge ${getSeverityClass(item.cvss)}">${getSeverityText(item.cvss)} (${item.cvss || 'N/A'})</span></td>
        </tr>`).join('');

    table.querySelector('thead').innerHTML = headers;
    table.querySelector('tbody').innerHTML = bodyHTML;
}
    // =============================================================================
    // MODAL LOGIC (PARA EDICIÓN Y CREACIÓN)
    // =============================================================================
    function setupWidgetModal() {
        const modal = document.getElementById('widgetModal');
        const btn = document.getElementById('addWidgetBtn');
        const span = modal.querySelector('.close-modal');

        btn.onclick = () => { openAddWidgetModal(); };
        span.onclick = () => { modal.style.display = 'none'; };
        window.onclick = (event) => { if (event.target == modal) { modal.style.display = 'none'; } };

        document.getElementById('widgetType').addEventListener('change', (e) => {
            const type = e.target.value;
            document.querySelectorAll('.form-section').forEach(el => el.style.display = 'none');
            if (type === 'chart') document.getElementById('chartOptions').style.display = 'block';
            else if (type === 'table') document.getElementById('tableOptions').style.display = 'block';
            else if (type === 'special') document.getElementById('specialOptions').style.display = 'block';
        });

        document.getElementById('chartDataSource').addEventListener('change', (e) => {
            const selectedValue = e.target.value;
            const isCorrelated = selectedValue.startsWith('corr_');
            
            // Ocultar/mostrar campos irrelevantes para gráficos de correlación
            document.getElementById('chartGroupBy').style.display = isCorrelated ? 'none' : 'block';
            document.getElementById('chartGroupBy').previousElementSibling.style.display = isCorrelated ? 'none' : 'block';
            document.getElementById('chartType').style.display = isCorrelated ? 'none' : 'block';
            document.getElementById('chartType').previousElementSibling.style.display = isCorrelated ? 'none' : 'block';
            
            if (isCorrelated) {
                const key = selectedValue.substring(5);
                if (SPECIAL_CHARTS_AND_TABLES[key]) {
                    document.getElementById('widgetTitle').value = SPECIAL_CHARTS_AND_TABLES[key].defaultTitle;
                }
            } else {
                 populateGroupBySelect(selectedValue);
            }
        });

        document.getElementById('specialComponentSource').addEventListener('change', (e) => {
            const key = e.target.value;
            if (key && SPECIAL_COMPONENTS[key]) document.getElementById('widgetTitle').value = SPECIAL_COMPONENTS[key].defaultTitle;
        });

        document.getElementById('widgetForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const widgetId = document.getElementById('widgetEditId').value;
            const newConfig = {
                title: document.getElementById('widgetTitle').value,
                type: document.getElementById('widgetType').value,
                size: document.getElementById('widgetSize').value,
            };

            if (newConfig.type === 'chart') {
                const chartSource = document.getElementById('chartDataSource').value;
                if (chartSource.startsWith('corr_')) {
                    newConfig.source = chartSource; 
                    newConfig.chartType = 'bar'; // Forzar a bar por defecto para los especiales
                } else {
                    newConfig.chartType = document.getElementById('chartType').value;
                    newConfig.source = chartSource;
                    newConfig.groupBy = document.getElementById('chartGroupBy').value;
                }
            } else if (newConfig.type === 'table') {
                const tableSource = document.getElementById('tableDataSource').value;
                newConfig.source = tableSource; 
            } else if (newConfig.type === 'special') {
                newConfig.component = document.getElementById('specialComponentSource').value;
            }
            
            if (widgetId) { 
                const index = dashboardState.layoutConfig.findIndex(w => w.id === widgetId);
                if (index > -1) {
                    dashboardState.layoutConfig[index] = { ...dashboardState.layoutConfig[index], ...newConfig };
                }
            } else {
                newConfig.id = `widget-${Date.now()}`;
                dashboardState.layoutConfig.push(newConfig);
            }
            
            renderDynamicDashboard();
            modal.style.display = 'none';
        });
    }

    function openAddWidgetModal() {
        const modal = document.getElementById('widgetModal');
        document.getElementById('widgetForm').reset();
        document.getElementById('widgetEditId').value = '';
        document.getElementById('widgetModalTitle').textContent = 'Añadir Nuevo Elemento';
        document.getElementById('saveWidgetBtn').innerHTML = `<i class="fa-solid fa-plus"></i> Añadir Elemento`;
        document.querySelectorAll('.form-section').forEach(el => el.style.display = 'none');
        populateModalDropdowns();
        modal.style.display = 'block';
    }

    function openEditWidgetModal(widgetId) {
        const widget = dashboardState.layoutConfig.find(w => w.id === widgetId);
        if (!widget) return;
        
        const modal = document.getElementById('widgetModal');
        document.getElementById('widgetForm').reset();
        populateModalDropdowns();
        
        document.getElementById('widgetEditId').value = widget.id;
        document.getElementById('widgetModalTitle').textContent = 'Editar Elemento del Dashboard';
        document.getElementById('saveWidgetBtn').innerHTML = `<i class="fa-solid fa-save"></i> Guardar Cambios`;
        
        document.getElementById('widgetTitle').value = widget.title;
        document.getElementById('widgetSize').value = widget.size;
        document.getElementById('widgetType').value = widget.type;
        
        document.querySelectorAll('.form-section').forEach(el => el.style.display = 'none');
        
        if (widget.type === 'chart') {
            document.getElementById('chartOptions').style.display = 'block';
            document.getElementById('chartDataSource').value = widget.source;
            
            const isCorrelated = widget.source.startsWith('corr_');
            document.getElementById('chartGroupBy').style.display = isCorrelated ? 'none' : 'block';
            document.getElementById('chartGroupBy').previousElementSibling.style.display = isCorrelated ? 'none' : 'block';
            document.getElementById('chartType').style.display = isCorrelated ? 'none' : 'block';
            document.getElementById('chartType').previousElementSibling.style.display = isCorrelated ? 'none' : 'block';

            if (!isCorrelated) {
                document.getElementById('chartType').value = widget.chartType;
                populateGroupBySelect(widget.source);
                document.getElementById('chartGroupBy').value = widget.groupBy;
            }
        } else if (widget.type === 'table') {
            document.getElementById('tableOptions').style.display = 'block';
            document.getElementById('tableDataSource').value = widget.source;
        } else if (widget.type === 'special') {
            document.getElementById('specialOptions').style.display = 'block';
            document.getElementById('specialComponentSource').value = widget.component;
        }
        
        modal.style.display = 'block';
    }

    function populateModalDropdowns() {
        const chartDataSourceSelect = document.getElementById('chartDataSource');
        const tableDataSourceSelect = document.getElementById('tableDataSource');
        const specialComponentSelect = document.getElementById('specialComponentSource');
        
        chartDataSourceSelect.innerHTML = '';
        tableDataSourceSelect.innerHTML = '';
        specialComponentSelect.innerHTML = '';

        // --- Llenar Gráficos ---
        const simpleChartsGroup = document.createElement('optgroup');
        simpleChartsGroup.label = 'Gráficos Simples (1 Fuente)';
        Object.entries(DATA_SOURCES).forEach(([key, value]) => simpleChartsGroup.appendChild(new Option(value.label, key)));
        chartDataSourceSelect.appendChild(simpleChartsGroup);

        const correlatedChartsGroup = document.createElement('optgroup');
        correlatedChartsGroup.label = 'Gráficos de Correlación';
        Object.entries(SPECIAL_CHARTS_AND_TABLES).filter(([, val]) => val.type === 'chart').forEach(([key, value]) => {
            correlatedChartsGroup.appendChild(new Option(value.label, `corr_${key}`));
        });
        chartDataSourceSelect.appendChild(correlatedChartsGroup);

        // --- Llenar Tablas ---
        const simpleTablesGroup = document.createElement('optgroup');
        simpleTablesGroup.label = 'Tablas Simples (Últimos 5)';
        ['incidentes', 'cves', 'exploits', 'zero-days'].forEach(key => simpleTablesGroup.appendChild(new Option(DATA_SOURCES[key].label, key)));
        tableDataSourceSelect.appendChild(simpleTablesGroup);

        const correlatedTablesGroup = document.createElement('optgroup');
        correlatedTablesGroup.label = 'Tablas Correlacionadas';
        Object.entries(SPECIAL_CHARTS_AND_TABLES).filter(([, val]) => val.type === 'table').forEach(([key, value]) => {
            correlatedTablesGroup.appendChild(new Option(value.label, `corr_${key}`));
        });
        tableDataSourceSelect.appendChild(correlatedTablesGroup);
        
        // --- Llenar Componentes Especiales ---
        Object.entries(SPECIAL_COMPONENTS).forEach(([key, value]) => specialComponentSelect.add(new Option(value.label, key)));
        
        populateGroupBySelect(chartDataSourceSelect.value);
    }
    
    function populateGroupBySelect(sourceKey) {
        const groupBySelect = document.getElementById('chartGroupBy');
        groupBySelect.innerHTML = '';
        if (sourceKey && DATA_SOURCES[sourceKey]) {
            Object.entries(DATA_SOURCES[sourceKey].fields).forEach(([fieldKey, fieldLabel]) => {
                groupBySelect.add(new Option(fieldLabel, fieldKey));
            });
        }
    }
    
    // =============================================================================
    // EXPORT & REPORTING FUNCTIONS
    // =============================================================================
    function exportarExcel() {
        const workbook = XLSX.utils.book_new();
        const dataKeys = { 'incidentes': 'Incidentes', 'exploits': 'Exploits', 'zero-days': 'ZeroDays', 'cves': 'CVEs', 'alertas': 'Alertas', 'fuentes': 'Fuentes_Intel', 'mitigaciones': 'Mitigaciones' };
        for (const key in dataKeys) {
            const sheetName = dataKeys[key]; const data = ALL_DATA_CACHE[key] || [];
            if (data.length > 0) { const cleanedData = data.map(item => { const { _id, __v, createdAt, updatedAt, ...rest } = item; return rest; }); const ws = XLSX.utils.json_to_sheet(cleanedData); XLSX.utils.book_append_sheet(workbook, ws, sheetName); }
        }
        XLSX.writeFile(workbook, 'OSINT_Reporte_Completo_API.xlsx');
    }

    function handlePdfExportClick() {
        const startDateStr = document.getElementById('reportStartDate').value; const endDateStr = document.getElementById('reportEndDate').value;
        if (!startDateStr || !endDateStr) { alert('Por favor, seleccione una fecha de inicio y una fecha de fin para el reporte.'); return; }
        if (new Date(startDateStr) > new Date(endDateStr)) { alert('La fecha de inicio no puede ser posterior a la fecha de fin.'); return; }
        generarReportePDF(startDateStr, endDateStr);
    }
    
    async function generarReportePDF(startDateStr, endDateStr) {
        if (typeof window.jspdf === 'undefined' || typeof window.jspdf.jsPDF === 'undefined') {
            alert('Error: La librería principal jsPDF no se cargó correctamente.');
            return;
        }
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('p', 'pt', 'a4');
        if (typeof doc.autoTable !== 'function') {
            alert('Error: El plugin jsPDF-AutoTable no se cargó correctamente.');
            return;
        }

        const pageHeight = doc.internal.pageSize.height;
        const pageWidth = doc.internal.pageSize.width;
        const margin = 45;
        let yPos = 0;

        const COLOR_PRIMARY_PURPLE = '#6A3093';
        const COLOR_BLACK = '#1c1c1c';
        const COLOR_WHITE = '#FFFFFF';
        const COLOR_GREY_TEXT = '#333333';
        const COLOR_LIGHT_GREY_BG = '#F8F9FA';
        const COLOR_LINK = '#2574A9';

        const FONT_H1 = 22;
        const FONT_H2 = 14;
        const FONT_H3 = 11;
        const FONT_NORMAL = 10;
        const FONT_SMALL = 8;

        const autoTableOptions = {
            theme: 'striped',
            headStyles: { fillColor: COLOR_BLACK, textColor: COLOR_WHITE, fontSize: FONT_SMALL },
            styles: { fontSize: FONT_SMALL, cellPadding: 4, valign: 'middle' },
            margin: { left: margin, right: margin }
        };

        const imgElement = document.getElementById('fondo-pdf');
        let backgroundImageData = null;

        if (imgElement && imgElement.complete && imgElement.naturalWidth !== 0) {
            try {
                const canvas = document.createElement('canvas');
                canvas.width = imgElement.naturalWidth;
                canvas.height = imgElement.naturalHeight;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(imgElement, 0, 0);
                backgroundImageData = canvas.toDataURL('image/jpeg');
            } catch (e) {
                console.error("Error al convertir la imagen para el PDF:", e);
                backgroundImageData = null;
            }
        } else {
            console.error("La imagen de fondo con id 'fondo-pdf' no se encontró o no se pudo cargar.");
        }

        const startDate = new Date(startDateStr);
        const endDate = new Date(endDateStr);
        endDate.setHours(23, 59, 59, 999);
        
        const filterByDate = (item) => {
            if (!item.fecha) return false;
            const itemDate = new Date(item.fecha);
            return itemDate >= startDate && itemDate <= endDate;
        };

        const incidentesData = (ALL_DATA_CACHE.incidentes || []).filter(filterByDate);
        const exploitsData = (ALL_DATA_CACHE.exploits || []).filter(filterByDate);
        const zeroDaysData = (ALL_DATA_CACHE['zero-days'] || []).filter(filterByDate);
        const cvesData = (ALL_DATA_CACHE.cves || []).filter(filterByDate);
        const alertasData = (ALL_DATA_CACHE.alertas || []).filter(filterByDate);
        const mitigacionesData = (ALL_DATA_CACHE.mitigaciones || []).filter(filterByDate);
        const fuentesData = (ALL_DATA_CACHE.fuentes || []).filter(filterByDate);

        const addPageFooter = () => {
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(FONT_SMALL);
                doc.setTextColor(COLOR_GREY_TEXT);
                const footerText = `Este reporte es clasificado como TLP:CLEAR (https://first.org/tlp/)`;
                doc.text(footerText, margin, pageHeight - 20);
                doc.text(`Página ${i} de ${pageCount}`, pageWidth - margin, pageHeight - 20, { align: 'right' });
            }
        };

        const checkAndAddPage = (neededHeight) => {
            if (yPos + neededHeight > pageHeight - margin - 20) {
                doc.addPage();
                yPos = margin;
            }
        };

        const addSectionTitle = (title) => {
            checkAndAddPage(115); 
            yPos += 20;
            doc.setFillColor(COLOR_PRIMARY_PURPLE);
            doc.rect(0, yPos, pageWidth, 25, 'F');
            doc.setFontSize(FONT_H2);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(COLOR_WHITE);
            doc.text(title.toUpperCase(), margin, yPos + 17);
            yPos += 25 + 20;
        };

        const addIntroductoryText = (text) => {
            checkAndAddPage(60);
            doc.setFontSize(FONT_NORMAL);
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(COLOR_BLACK);
            const textLines = doc.splitTextToSize(text, pageWidth - margin * 2);
            doc.text(textLines, margin, yPos);
            yPos += doc.getTextDimensions(textLines).h + 20;
        };
        
        const addNoDataMessage = (message = 'No se registraron datos para esta sección en el período seleccionado.') => {
            checkAndAddPage(30);
            doc.setFontSize(FONT_NORMAL);
            doc.setFont('helvetica', 'italic');
            doc.setTextColor(COLOR_GREY_TEXT);
            doc.text(message, margin, yPos);
            yPos += doc.getTextDimensions(message).h + 20;
        };

        const getTopItems = (data, key, count = 2) => {
            const counts = data.reduce((acc, item) => {
                const value = item[key];
                if (value && typeof value === 'string' && value.trim() && value.trim().toLowerCase() !== 'desconocido') {
                    acc[value.trim()] = (acc[value.trim()] || 0) + 1;
                }
                return acc;
            }, {});
            return Object.entries(counts).sort((a, b) => b[1] - a[1]).slice(0, count).map(e => e[0]);
        };

        const getSeverityTextForCVSS = (cvss) => {
            const score = parseFloat(cvss);
            if (isNaN(score)) return 'N/A';
            if (score >= 9.0) return 'Crítico';
            if (score >= 7.0) return 'Alto';
            if (score >= 4.0) return 'Medio';
            if (score > 0) return 'Bajo';
            return 'Info';
        };

        const formatDate = (dateString) => {
            if (!dateString) return 'Fecha no especificada';
            const date = new Date(dateString);
            if (!(date instanceof Date && !isNaN(date))) return dateString;
            return date.toLocaleDateString('es-ES', { day: 'numeric', month: 'long', year: 'numeric', timeZone: 'UTC' });
        };

        const renderTextItem = (config) => {
            const availableWidth = pageWidth - margin * 2;
            checkAndAddPage(config.neededHeight || 80);
            doc.setFontSize(FONT_H3);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(COLOR_PRIMARY_PURPLE);
            const titleLines = doc.splitTextToSize(config.title, availableWidth);
            doc.text(titleLines, margin, yPos);
            yPos += doc.getTextDimensions(titleLines).h + 5;

            doc.setFont('helvetica', 'normal');
            doc.setFontSize(FONT_NORMAL);
            doc.setTextColor(COLOR_GREY_TEXT);

            config.details.forEach(detail => {
                if (detail.value) {
                    const detailText = detail.label + detail.value;
                    const detailLines = doc.splitTextToSize(detailText, availableWidth);
                    doc.text(detailLines, margin, yPos);
                    yPos += doc.getTextDimensions(detailLines).h + 5;
                }
            });
            
            if (config.url) {
                yPos += 5;
                checkAndAddPage(15);
                doc.setTextColor(COLOR_LINK);
                doc.textWithLink('Visitar URL', margin, yPos, { url: config.url });
                doc.setTextColor(COLOR_GREY_TEXT);
                yPos += 15;
            }

            yPos += 5;

            if (config.description) {
                const descLines = doc.splitTextToSize(`${config.description}`, availableWidth);
                doc.text(descLines, margin, yPos);
                yPos += doc.getTextDimensions(descLines).h;
            }

            yPos += 25;
        };

        const drawMetricsCards = (startY) => {
            const metrics = [
                { label: 'Incidentes', value: incidentesData.length },
                { label: 'Exploits', value: exploitsData.length },
                { label: 'Zero-Days', value: zeroDaysData.length },
                { label: 'CVEs Nuevos', value: cvesData.length },
                { label: 'Alertas', value: alertasData.length },
                { label: 'Mitigaciones', value: mitigacionesData.length },
            ];
            const numColumns = 3;
            const cardGap = 15;
            const availableWidth = pageWidth - (margin * 2) - (cardGap * (numColumns - 1));
            const cardWidth = availableWidth / numColumns;
            const cardHeight = 60;
            metrics.forEach((metric, index) => {
                const col = index % numColumns;
                const row = Math.floor(index / numColumns);
                const cardX = margin + col * (cardWidth + cardGap);
                const cardY = startY + row * (cardHeight + cardGap);
                doc.setFillColor(COLOR_LIGHT_GREY_BG);
                doc.setDrawColor('#EAECEE');
                doc.roundedRect(cardX, cardY, cardWidth, cardHeight, 5, 5, 'FD');
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(28);
                doc.setTextColor(COLOR_GREY_TEXT);
                doc.text(String(metric.value), cardX + cardWidth / 2, cardY + 35, { align: 'center' });
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(10);
                doc.setTextColor(COLOR_GREY_TEXT);
                doc.text(metric.label, cardX + cardWidth / 2, cardY + 50, { align: 'center' });
            });
            const numRows = Math.ceil(metrics.length / numColumns);
            return startY + (numRows * cardHeight) + ((numRows - 1) * cardGap);
        };

        if (backgroundImageData) {
            doc.addImage(backgroundImageData, 'JPEG', 0, 0, pageWidth, 250);
        } else {
            doc.setFillColor(COLOR_BLACK);
            doc.rect(0, 0, pageWidth, 250, 'F');
        }

        doc.setFontSize(FONT_H1);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(COLOR_WHITE);
        doc.text('CYBER THREAT INTELLIGENCE BRIEF', margin, 100);
        doc.setFontSize(48);
        doc.text('ACCENTURE', margin, 155);

        yPos = 205;

        const reportMonthName = startDate.toLocaleDateString('es-ES', { month: 'long', timeZone: 'UTC' });
        const capitalizedMonth = reportMonthName.charAt(0).toUpperCase() + reportMonthName.slice(1);
        const reportYear = startDate.getFullYear();
        const reportPeriodText = `${capitalizedMonth} ${reportYear}`;

        doc.setFillColor(COLOR_BLACK);
        doc.rect(margin, yPos, 150, 25, 'F');
        doc.setFontSize(FONT_H3);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(COLOR_WHITE);
        doc.text(reportPeriodText, margin + 10, yPos + 17);

        yPos += 25;
        yPos += 35;
        yPos = drawMetricsCards(yPos);
        yPos += 10;

        addSectionTitle('RESUMEN EJECUTIVO');
        const criticalVulns = cvesData.filter(cve => (cve.cvss || 0) >= 9.0);
        const topSectors = getTopItems(incidentesData, 'sector');
        const topActors = getTopItems(incidentesData, 'actor');
        let summaryParagraph = `Análisis correspondiente al mes de ${reportMonthName} de ${reportYear}. Durante este tiempo, se publicaron ${cvesData.length} nuevas vulnerabilidades, de las cuales ${criticalVulns.length} se calificaron como críticas (CVSS 9.0+). Se registraron ${incidentesData.length} incidentes relevantes, con especial afectación al sector ${topSectors.length > 0 ? topSectors.join(' y ') : 'diversos'}. Los grupos de amenaza más destacados fueron ${topActors.length > 0 ? topActors.join(', ') : 'varios'}. Además, se descubrieron ${zeroDaysData.length} nuevas vulnerabilidades de día cero y se publicaron ${exploitsData.length} exploits con prueba de concepto.`;
        addIntroductoryText(summaryParagraph);

        addSectionTitle('Incidentes');
        addIntroductoryText('El conocimiento y la vigilancia de los ciber incidentes es fundamental para la seguridad de cualquier organización. La respuesta ante estos incidentes y su posterior análisis post mortem son cruciales para el proceso de fortalecimiento de los sistemas. Al mantenerse informadas sobre los últimos ataques, las organizaciones pueden identificar y mitigar posibles amenazas.');
        if (incidentesData.length > 0) {
            [...incidentesData].sort((a, b) => new Date(b.fecha) - new Date(a.fecha)).forEach(item => renderTextItem({
                title: `${item.tipo || 'N/A'} - ${item.entidad || 'Entidad no especificada'}`,
                details: [
                    { label: 'Fecha: ', value: formatDate(item.fecha) },
                    { label: 'Actor de Amenazas: ', value: item.actor || 'Desconocido' },
                    { label: 'País y Sector: ', value: `${item.pais || 'N/A'} | ${item.sector || 'N/A'}` },
                    { label: 'Datos Comprometidos: ', value: item.datosComprometidos || 'N/A' }
                ],
                description: item.descripcion || 'Sin descripción.',
                url: item.url
            }));
        } else { 
            addNoDataMessage();
        }

        addSectionTitle('Exploits Publicados');
        addIntroductoryText('Los exploit son puertas traseras que los atacantes pueden utilizar permitiendo el robo de datos, la instalación de malware, la toma de control de sistemas y múltiples ataques a sistemas informáticos. Al comprender estos exploit, la amenaza que representan y cómo funcionan, las empresas pueden tomar medidas proactivas para protegerse de ataques cibernéticos.');
        if (exploitsData.length > 0) {
            const sortedExploits = [...exploitsData].sort((a,b) => new Date(b.fecha) - new Date(a.fecha));
            doc.autoTable({ ...autoTableOptions, theme: 'grid', startY: yPos,
                head: [['Fecha', 'Nombre', 'Tipo', 'Plataforma', 'CVE Asociado', 'URL']],
                body: sortedExploits.map(e => [ formatDate(e.fecha), e.nombre || 'N/A', e.tipo || 'N/A', e.plataforma, e.cve || 'N/A', '' ]),
                columnStyles: { 0: { cellWidth: 80 }, 1: { cellWidth: 'auto' }, 5: { cellWidth: 40, halign: 'center' } },
                didDrawCell: (data) => {
                    if (data.column.index === 5 && data.row.section === 'body') {
                        const exploit = sortedExploits[data.row.index];
                        if (exploit && exploit.url) {
                            doc.setTextColor(COLOR_LINK);
                            doc.textWithLink('Ver', data.cell.x + data.cell.width / 2, data.cell.y + data.cell.height / 2 + 4, { url: exploit.url, align: 'center' });
                        }
                    }
                }
            });
            yPos = doc.lastAutoTable.finalY + 20;
        } else { 
            addNoDataMessage();
        }

        addSectionTitle('Zero-Days');
        addIntroductoryText('El conocimiento de los "zero days" o vulnerabilidades de día cero es fundamental en el ámbito de la ciberseguridad. Estas vulnerabilidades son fallos de seguridad en software o hardware que son desconocidos para los fabricantes y, por lo tanto, no tienen un parche o solución disponible en el momento de su descubrimiento.');
        if (zeroDaysData.length > 0) {
            [...zeroDaysData].sort((a, b) => new Date(b.fecha) - new Date(a.fecha)).forEach(item => renderTextItem({
                title: `Zero Day: ${item.nombre || 'N/A'} (ID: ${item.idZD || 'N/A'})`,
                details: [
                    { label: 'Fecha Detección: ', value: formatDate(item.fecha) },
                    { label: 'Plataforma Afectada: ', value: item.plataforma || 'N/A' },
                    { label: 'CVSS y Estado: ', value: `${item.cvss || 'N/A'} | ${item.estado || 'N/A'}` }
                ],
                description: item.descripcion || 'Sin descripción.',
                url: item.url
            }));
        } else { 
            addNoDataMessage();
        }

        addSectionTitle('Vulnerabilidades');
        addIntroductoryText('Las Vulnerabilidades Comunes Enumeradas (CVE) proporcionan detalles sobre vulnerabilidades de seguridad en sistemas y software, permitiendo a las organizaciones identificar y mitigar posibles amenazas. Las CVE aquí listadas son sumamente relevantes para la seguridad de los sistemas, recomendamos realizar las mitigaciones necesarias para evitar la exposición a estas vulnerabilidades.');
        if (cvesData.length > 0) {
            const sortedCves = [...cvesData].sort((a,b) => new Date(b.fecha) - new Date(a.fecha));
            doc.autoTable({ ...autoTableOptions, startY: yPos,
                head: [['ID CVE', 'Aplicativo', 'Fecha Pub.','Descripción', 'CVSS (Severidad)', 'URL']],
                body: sortedCves.map(c => [ c.cveId || 'N/A', c.aplicativo || 'N/A', formatDate(c.fecha), c.descripcion || 'N/A' , `${c.cvss || 'N/A'} (${getSeverityTextForCVSS(c.cvss)})`, '' ]),
                columnStyles: {2: { cellWidth: 70 }, 3: { cellWidth: 'auto' }, 4: { cellWidth: 70 }, 5: { cellWidth: 40, halign: 'center' } },
                didDrawCell: (data) => {
                    if (data.column.index === 5 && data.row.section === 'body') {
                        const cve = sortedCves[data.row.index];
                        if (cve && cve.url) {
                            doc.setTextColor(COLOR_LINK);
                            doc.textWithLink('Ver', data.cell.x + data.cell.width / 2, data.cell.y + data.cell.height / 2 + 4, { url: cve.url, align: 'center' });
                        }
                    }
                }
            });
            yPos = doc.lastAutoTable.finalY + 20;
        } else { 
            addNoDataMessage();
        }
        
        addSectionTitle('Alertas CTI');
        addIntroductoryText('Las alertas de Cyber Threat Intelligence son notificaciones que informan sobre amenazas cibernéticas identificadas, como vulnerabilidades o ataques activos. La importancia de estas alertas es su capacidad para comunicar información crítica de manera segura y eficiente, asegurando que solo las partes adecuadas tengan acceso a la información necesaria para protegerse contra amenazas cibernéticas.');
        if (alertasData.length > 0) {
            [...alertasData].sort((a,b) => new Date(b.fecha) - new Date(a.fecha)).forEach(item => renderTextItem({
                title: `${item.titulo || 'Sin título'} (Criticidad: ${item.criticidad || 'N/A'})`,
                details: [{ label: 'Fecha: ', value: formatDate(item.fecha) }],
                description: item.descripcion || 'Sin descripción.',
                url: item.url
            }));
        } else { 
            addNoDataMessage();
        }

        addSectionTitle('Recomendaciones para las Organizaciones');
        addIntroductoryText('La inteligencia de amenazas (CTI) permite transformar datos en acciones defensivas proactivas, reduciendo la superficie de ataque y fortaleciendo la resiliencia frente a un panorama de amenazas cada vez más sofisticado y dirigido.');
        if (mitigacionesData.length > 0) {
            const priorityOrder = { 'Alta': 1, 'Media': 2, 'Baja': 3 };
            [...mitigacionesData].sort((a,b) => (priorityOrder[a.prioridad] || 4) - (priorityOrder[b.prioridad] || 4)).forEach((item, index) => renderTextItem({
                title: `${item.titulo || 'Recomendación sin título'}`,
                details: [{ label: 'Categoría y Prioridad: ', value: `${item.categoria || 'N/A'} | ${item.prioridad || 'N/A'}` }],
                description: item.descripcion || 'Sin descripción.',
                url: item.url
            }));
        } else { 
            addNoDataMessage('No se han definido mitigaciones específicas en el período seleccionado.');
        }
        
        addSectionTitle('Fuentes de Inteligencia');
        addIntroductoryText('En el último mes, nuestro equipo de CTI ha realizado un exhaustivo trabajo de recopilación y análisis de fuentes abiertas, utilizando diversas herramientas y metodologías de OSINT. Nuestro objetivo ha sido identificar y evaluar los riesgos latentes que amenazan la red abierta.');
        if (fuentesData.length > 0) {
            [...fuentesData].sort((a,b) => new Date(b.fecha) - new Date(a.fecha)).forEach(f => {
                renderTextItem({
                    title: f.nombre || 'Fuente sin nombre',
                    details: [{ label: 'Tipo: ', value: f.tipo || 'N/A' }],
                    description: f.descripcion,
                    url: f.url
                });
            });
        } else { 
            addNoDataMessage();
        }
        
        addSectionTitle('Equipo de CTI');
        addIntroductoryText('El contenido de este boletin, sus recomendaciones, alertas y la evaluación del riesgo que estas amenazas representa para las organizaciones interesadas fue proporcionado por el equipo de Cyber Threat Intelligence del Clan de Cyber Resilience de Accenture Buenos Aires.');

        addPageFooter();
        doc.save(`Cyber_Threat_Intelligence_Brief_${capitalizedMonth}_${reportYear}.pdf`);
    }

    function generarReporteCompletoHTML() {
        const startDateStr = document.getElementById('reportStartDate').value;
        const endDateStr = document.getElementById('reportEndDate').value;
        const previewDiv = document.getElementById('previewReporte');

        if (!startDateStr || !endDateStr) {
            previewDiv.innerHTML = `<p style="color: red; font-weight: bold; text-align: center;">Por favor, seleccione una fecha de inicio y una fecha de fin para previsualizar el reporte.</p>`;
            return;
        }
        if (new Date(startDateStr) > new Date(endDateStr)) {
            previewDiv.innerHTML = `<p style="color: red; font-weight: bold; text-align: center;">La fecha de inicio no puede ser posterior a la fecha de fin.</p>`;
            return;
        }

        const startDate = new Date(startDateStr);
        const endDate = new Date(endDateStr);
        endDate.setHours(23, 59, 59, 999);
        
        const filterByDate = (item) => {
            if (!item.fecha) return false;
            const itemDate = new Date(item.fecha);
            return itemDate >= startDate && itemDate <= endDate;
        };

        const incidentesData = (ALL_DATA_CACHE.incidentes || []).filter(filterByDate);
        const exploitsData = (ALL_DATA_CACHE.exploits || []).filter(filterByDate);
        const zeroDaysData = (ALL_DATA_CACHE['zero-days'] || []).filter(filterByDate);
        const cvesData = (ALL_DATA_CACHE.cves || []).filter(filterByDate);
        const alertasData = (ALL_DATA_CACHE.alertas || []).filter(filterByDate);
        const mitigacionesData = (ALL_DATA_CACHE.mitigaciones || []).filter(filterByDate);
        const fuentesData = (ALL_DATA_CACHE.fuentes || []).filter(filterByDate);
        
        const formatDate = (dateString) => {
            if (!dateString) return 'Fecha no especificada';
            const date = new Date(dateString);
            return date.toLocaleDateString('es-ES', { day: 'numeric', month: 'long', year: 'numeric', timeZone: 'UTC' });
        };
        const getSeverityTextForCVSS = (cvss) => {
            const score = parseFloat(cvss);
            if (isNaN(score)) return 'N/A';
            if (score >= 9.0) return 'Crítico';
            if (score >= 7.0) return 'Alto';
            if (score >= 4.0) return 'Medio';
            if (score > 0) return 'Bajo';
            return 'Info';
        };
        const getTopItems = (data, key, count = 2) => {
            const counts = data.reduce((acc, item) => {
                const value = item[key];
                if (value && typeof value === 'string' && value.trim() && value.trim().toLowerCase() !== 'desconocido') {
                    acc[value.trim()] = (acc[value.trim()] || 0) + 1;
                }
                return acc;
            }, {});
            return Object.entries(counts).sort((a, b) => b[1] - a[1]).slice(0, count).map(e => e[0]);
        };
        
        const styles = {
            container: `padding: 20px; border: 1px solid #ccc; background-color: #fff; font-family: 'Helvetica', 'Arial', sans-serif; color: #333;`,
            h1: `font-size: 22px; color: #6A3093; border-bottom: 2px solid #6A3093; padding-bottom: 5px; margin-bottom: 20px; font-weight: bold;`,
            h2: `font-size: 14px; color: #6A3093; margin-top: 30px; margin-bottom: 15px; font-weight: bold; text-transform: uppercase; border-bottom: 1px solid #eaeaea; padding-bottom: 8px;`,
            introText: `font-size: 12px; color: #555; margin-bottom: 20px; line-height: 1.5;`,
            item: `border-left: 4px solid #6A3093; padding: 15px; margin-bottom: 15px; background-color: #fdfdfd; box-shadow: 0 1px 3px rgba(0,0,0,0.05);`,
            itemTitle: `font-size: 13px; color: #333; font-weight: bold; margin: 0 0 10px 0;`,
            itemDetail: `font-size: 11px; color: #444; margin-bottom: 5px;`,
            itemDesc: `font-size: 12px; color: #444; margin-top: 10px;`,
            table: `width: 100%; border-collapse: collapse; font-size: 11px; margin-bottom: 20px;`,
            th: `background-color: #1c1c1c; color: white; padding: 8px; text-align: left;`,
            td: `border: 1px solid #ddd; padding: 8px; vertical-align: top;`,
            metricContainer: `display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 30px;`,
            metricCard: `flex: 1; min-width: 120px; background-color: #F8F9FA; border: 1px solid #EAECEE; border-radius: 5px; padding: 15px; text-align: center;`,
            metricValue: `font-size: 28px; font-weight: bold; color: #333;`,
            metricLabel: `font-size: 11px; color: #555; margin-top: 5px;`,
            noData: `font-style: italic; color: #777;`,
            urlLink: `display: block; margin-top: 8px; font-size: 11px;`
        };
        const urlFormatter = (url) => {
             if (!url) return '';
             return `<a href="${url}" target="_blank" rel="noopener noreferrer" style="${styles.urlLink}">Ver referencia</a>`;
        };
        
        let reporteHTML = `<div style="${styles.container}">`;
        const reportMonthName = startDate.toLocaleDateString('es-ES', { month: 'long', timeZone: 'UTC' });
        const capitalizedMonth = reportMonthName.charAt(0).toUpperCase() + reportMonthName.slice(1);
        const reportYear = startDate.getFullYear();
        reporteHTML += `<h1 style="${styles.h1}">Cyber Threat Intelligence Brief (${capitalizedMonth} ${reportYear})</h1>`;

        const metrics = [
            { label: 'Incidentes', value: incidentesData.length }, { label: 'Exploits', value: exploitsData.length },
            { label: 'Zero-Days', value: zeroDaysData.length }, { label: 'CVEs Nuevos', value: cvesData.length },
            { label: 'Alertas', value: alertasData.length }, { label: 'Mitigaciones', value: mitigacionesData.length }
        ];
        reporteHTML += `<div style="${styles.metricContainer}">`;
        metrics.forEach(metric => {
            reporteHTML += `<div style="${styles.metricCard}"><div style="${styles.metricValue}">${metric.value}</div><div style="${styles.metricLabel}">${metric.label}</div></div>`;
        });
        reporteHTML += `</div>`;
        
        const criticalVulns = cvesData.filter(cve => (cve.cvss || 0) >= 9.0);
        const topSectors = getTopItems(incidentesData, 'sector');
        const topActors = getTopItems(incidentesData, 'actor');
        let summaryParagraph = `Análisis correspondiente al período. Se publicaron ${cvesData.length} nuevas vulnerabilidades, de las cuales ${criticalVulns.length} se calificaron como críticas (CVSS 9.0+). Se registraron ${incidentesData.length} incidentes relevantes, con especial afectación al sector ${topSectors.length > 0 ? topSectors.join(' y ') : 'diversos'}. Los grupos de amenaza más destacados fueron ${topActors.length > 0 ? topActors.join(', ') : 'varios'}. Además, se descubrieron ${zeroDaysData.length} nuevas vulnerabilidades de día cero y se publicaron ${exploitsData.length} exploits con prueba de concepto.`;
        reporteHTML += `<h2 style="${styles.h2}">Resumen Ejecutivo</h2><p style="${styles.introText}">${summaryParagraph}</p>`;

        const renderSection = (title, intro, data, renderer) => {
            reporteHTML += `<h2 style="${styles.h2}">${title}</h2><p style="${styles.introText}">${intro}</p>`;
            if (data.length > 0) { renderer(data); } 
            else { reporteHTML += `<p style="${styles.noData}">No hay datos para esta sección en el período seleccionado.</p>`; }
        };

        renderSection('Incidentes', 'El conocimiento y la vigilancia de los ciber incidentes es fundamental...', incidentesData, (data) => {
            [...data].sort((a,b) => new Date(b.fecha) - new Date(a.fecha)).forEach(item => {
                reporteHTML += `<div style="${styles.item}"><h3 style="${styles.itemTitle}">${item.tipo || 'N/A'} - ${item.entidad || 'Entidad no especificada'}</h3><p style="${styles.itemDetail}"><strong>Fecha:</strong> ${formatDate(item.fecha)} | <strong>Actor:</strong> ${item.actor || 'Desconocido'}</p><p style="${styles.itemDetail}"><strong>País y Sector:</strong> ${item.pais || 'N/A'} | ${item.sector || 'N/A'}</p><p style="${styles.itemDesc}">${item.descripcion || 'Sin descripción.'}</p>${urlFormatter(item.url)}</div>`;
            });
        });

        renderSection('Exploits Publicados', 'Los exploit son puertas traseras que los atacantes pueden utilizar...', exploitsData, (data) => {
            reporteHTML += `<table style="${styles.table}"><thead><tr><th style="${styles.th}">Fecha</th><th style="${styles.th}">Nombre</th><th style="${styles.th}">Tipo</th><th style="${styles.th}">Plataforma</th></tr></thead><tbody>`;
            [...data].sort((a,b) => new Date(b.fecha) - new Date(a.fecha)).forEach(e => {
                reporteHTML += `<tr><td style="${styles.td}">${formatDate(e.fecha)}</td><td style="${styles.td}">${e.nombre || 'N/A'} ${urlFormatter(e.url)}</td><td style="${styles.td}">${e.tipo || 'N/A'}</td><td style="${styles.td}">${e.plataforma}</td></tr>`;
            });
            reporteHTML += '</tbody></table>';
        });

        renderSection('Zero-Days', 'El conocimiento de los "zero days" es fundamental...', zeroDaysData, (data) => {
            [...data].sort((a,b) => new Date(b.fecha) - new Date(a.fecha)).forEach(item => {
                reporteHTML += `<div style="${styles.item}"><h3 style="${styles.itemTitle}">Zero Day: ${item.nombre || 'N/A'} (ID: ${item.idZD || 'N/A'})</h3><p style="${styles.itemDetail}"><strong>Fecha Detección:</strong> ${formatDate(item.fecha)} | <strong>Plataforma:</strong> ${item.plataforma || 'N/A'}</p><p style="${styles.itemDetail}"><strong>CVSS y Estado:</strong> ${item.cvss || 'N/A'} | ${item.estado || 'N/A'}</p><p style="${styles.itemDesc}">${item.descripcion || 'Sin descripción.'}</p>${urlFormatter(item.url)}</div>`;
            });
        });

        renderSection('Vulnerabilidades', 'Las Vulnerabilidades Comunes Enumeradas (CVE) proporcionan detalles...', cvesData, (data) => {
            reporteHTML += `<table style="${styles.table}"><thead><tr><th style="${styles.th}">ID CVE</th><th style="${styles.th}">Nombre</th><th style="${styles.th}">Descripción</th><th style="${styles.th}">CVSS (Severidad)</th></tr></thead><tbody>`;
            [...data].sort((a,b) => new Date(b.fecha) - new Date(a.fecha)).forEach(c => {
                reporteHTML += `<tr><td style="${styles.td}">${c.cveId || 'N/A'} ${urlFormatter(c.url)}</td><td style="${styles.td}">${c.aplicativo || 'N/A'}</td><td style="${styles.td}">${c.descripcion || 'N/A'}</td><td style="${styles.td}">${c.cvss || 'N/A'} (${getSeverityTextForCVSS(c.cvss)})</td></tr>`;
            });
            reporteHTML += '</tbody></table>';
        });
        
        renderSection('Alertas CTI', 'Las alertas de Cyber Threat Intelligence son notificaciones...', alertasData, (data) => {
             [...data].sort((a,b) => new Date(b.fecha) - new Date(a.fecha)).forEach(item => {
                reporteHTML += `<div style="${styles.item}"><h3 style="${styles.itemTitle}">${item.titulo || 'Sin título'} (Criticidad: ${item.criticidad || 'N/A'})</h3><p style="${styles.itemDetail}"><strong>Fecha:</strong> ${formatDate(item.fecha)}</p><p style="${styles.itemDesc}">${item.descripcion || 'Sin descripción.'}</p>${urlFormatter(item.url)}</div>`;
            });
        });

        renderSection('Recomendaciones para las Organizaciones', 'La inteligencia de amenazas (CTI) permite transformar datos...', mitigacionesData, (data) => {
            const priorityOrder = { 'Alta': 1, 'Media': 2, 'Baja': 3 };
            [...data].sort((a,b) => (priorityOrder[a.prioridad] || 4) - (priorityOrder[b.prioridad] || 4)).forEach(item => {
                reporteHTML += `<div style="${styles.item}"><h3 style="${styles.itemTitle}">${item.titulo || 'Recomendación sin título'}</h3><p style="${styles.itemDetail}"><strong>Categoría y Prioridad:</strong> ${item.categoria || 'N/A'} | ${item.prioridad || 'N/A'}</p><p style="${styles.itemDesc}">${item.descripcion || 'Sin descripción.'}</p>${urlFormatter(item.url)}</div>`;
            });
        });

        renderSection('Fuentes de Inteligencia', 'Nuestro equipo de CTI ha realizado un exhaustivo trabajo...', fuentesData, (data) => {
            [...data].sort((a,b) => new Date(b.fecha) - new Date(a.fecha)).forEach(f => {
                reporteHTML += `<div style="${styles.item}"><h3 style="${styles.itemTitle}">${f.nombre || 'Fuente sin nombre'}</h3><p style="${styles.itemDetail}"><strong>Tipo:</strong> ${f.tipo || 'N/A'}</p><p style="${styles.itemDesc}">${f.descripcion || ''}</p>${urlFormatter(f.url)}</div>`;
            });
        });

        reporteHTML += `</div>`;
        previewDiv.innerHTML = reporteHTML;
    }

    function descargarCorreoHTML() {
        const startDateStr = document.getElementById('reportStartDate').value;
        const endDateStr = document.getElementById('reportEndDate').value;

        if (!startDateStr || !endDateStr) {
            alert('Por favor, seleccione una fecha de inicio y una fecha de fin para generar el correo.');
            return;
        }
        if (new Date(startDateStr) > new Date(endDateStr)) {
            alert('La fecha de inicio no puede ser posterior a la fecha de fin.');
            return;
        }

        const sDateParts = startDateStr.split('-').map(Number);
        const sDate = new Date(Date.UTC(sDateParts[0], sDateParts[1] - 1, sDateParts[2]));
        const eDateParts = endDateStr.split('-');
        const eDate = new Date(Date.UTC(eDateParts[0], eDateParts[1] - 1, eDateParts[2], 23, 59, 59, 999));

        const filterByDate = item => {
            if (!item.fecha) return false;
            const itemDate = new Date(item.fecha);
            return itemDate >= sDate && itemDate <= eDate;
        };
        
        const data = {};
        for (const key in ALL_DATA_CACHE) {
            data[key.replace('-', '')] = (ALL_DATA_CACHE[key] || []).filter(filterByDate);
        }
        
        const emailHtml = generarPlantillaCorreo(data, sDate);
        descargarArchivoHTML(emailHtml, startDateStr, endDateStr);
    }

    function generarPlantillaCorreo(data, startDate) {
        const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
        const reportMonth = monthNames[startDate.getUTCMonth()];
        const reportYear = startDate.getUTCFullYear();
        
        const criticalCvesCount = data.cves.filter(c => c.cvss >= 9.0).length;
        const topSectors = [...new Set(data.incidentes.map(i => i.sector).filter(Boolean))].slice(0, 2).join(' y ');
        const topActors = [...new Set(data.incidentes.map(i => i.actor).filter(a => a && a.toLowerCase() !== 'desconocido'))].slice(0, 2).join(', ');

        let template = obtenerPlantillaString();

        template = template.replace(/\[Mes\]/g, reportMonth);
        template = template.replace(/\[Año\]/g, reportYear);
        template = template.replace('[Número de CVEs]', data.cves.length);
        template = template.replace('[Número de CVEs Críticos]', criticalCvesCount);
        template = template.replace('[Número de Incidentes]', data.incidentes.length);
        template = template.replace('[Sectores más Afectados]', topSectors || 'diversos');
        template = template.replace('[Actores de Amenaza Destacados]', topActors || 'varios');
        template = template.replace('[Número de Zero-Days]', data.zerodays.length);
        template = template.replace('[Número de Exploits]', data.exploits.length);
        
        return template;
    }

    function descargarArchivoHTML(htmlContent, startDate, endDate) {
        const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        const fileName = `Boletin_CTI_${startDate.replace(/-/g, '')}_al_${endDate.replace(/-/g, '')}.html`;
        link.download = fileName;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    function obtenerPlantillaString() {
        return `
        <!DOCTYPE html>
        <html lang="es">
        <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Cyber Threat Intelligence Brief | [Mes] [Año]</title>
        </head>
        <body style="margin: 0; padding: 0; background-color: #f4f4f4; font-family: Arial, sans-serif;">

        <table border="0" cellpadding="0" cellspacing="0" width="100%">
            <tr>
                <td style="padding: 20px 0 30px 0;" align="center">
                    <table align="center" border="0" cellpadding="0" cellspacing="0" width="700" style="border-collapse: collapse; background-color: #ffffff; border: 1px solid #e0e6ed; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                        <tr>
                            <td align="left" style="padding: 30px 30px 20px 30px; background-color: #6A3093; color: #FFFFFF;">
                                <h1 style="margin: 0; font-size: 24px; font-family: 'Roboto', Arial, sans-serif;">Cyber Threat Intelligence Brief</h1>
                                <p style="margin: 5px 0 0; font-size: 16px; font-family: 'Roboto', Arial, sans-serif; color: #FFFFFF;">Informe de [Mes] [Año]</p>
                            </td>
                        </tr>
                        <tr>
                            <td style="padding: 30px 30px 20px 30px;">
                                <p style="margin: 0; font-size: 16px; line-height: 1.6; color: #333333;">
                                    Estimados, compartimos el resumen ejecutivo de la actividad de amenazas correspondiente al último período. El informe completo se encuentra adjunto.
                                </p>
                            </td>
                        </tr>
                        <tr>
                            <td style="padding: 0 30px 30px 30px;">
                                <h2 style="font-size: 20px; color: #1c1c1c; margin: 0 0 15px 0; border-bottom: 2px solid #e0e6ed; padding-bottom: 10px;">Resumen Ejecutivo</h2>
                                <div style="background-color: #F8F9FA; padding: 20px; border-left: 4px solid #6A3093;">
                                    <p style="margin: 0; font-size: 16px; line-height: 1.6; color: #333333;">
                                        Análisis correspondiente al mes de <strong>[Mes] de [Año]</strong>. Durante este tiempo, se publicaron <strong>[Número de CVEs]</strong> nuevas vulnerabilidades, de las cuales <strong>[Número de CVEs Críticos]</strong> se calificaron como críticas (CVSS 9.0+). Se registraron <strong>[Número de Incidentes]</strong> incidentes relevantes, con especial afectación al sector <strong>[Sectores más Afectados]</strong>. Los grupos de amenaza más destacados fueron <strong>[Actores de Amenaza Destacados]</strong>.
                                        <br><br>
                                        Además, se descubrieron <strong>[Número de Zero-Days]</strong> nuevas vulnerabilidades de día cero y se publicaron <strong>[Número de Exploits]</strong> exploits con prueba de concepto.
                                    </p>
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td align="center" style="padding: 30px 30px 40px 30px; background-color: #F8F9FA;">
                                <p style="margin: 0; font-size: 16px; line-height: 1.6; color: #333333;">
                                    Para un análisis exhaustivo y el listado completo de todos los eventos, por favor revise el informe PDF completo adjunto.
                                </p>
                            </td>
                        </tr>
                        <tr>
                            <td style="padding: 20px 30px 20px 30px; text-align: center; color: #888888; font-size: 12px; background-color: #e9ecef;">
                                <p style="margin: 0;">
                                    Este reporte es clasificado como TLP:CLEAR (<a href="https://first.org/tlp/" style="color: #2574A9; text-decoration: none;">https://first.org/tlp/</a>)
                                </p>
                            </td>
                        </tr>
                    </table>
                </td>
            </tr>
        </table>
        </body>
        </html>
        `;
    }

    async function handleExcelImport(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = async (e) => {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array', cellDates: true });

                const sheetToEndpointMap = {
                    'Incidentes': 'incidentes', 'Exploits': 'exploits', 'ZeroDays': 'zero-days',
                    'CVEs': 'cves', 'Alertas': 'alertas', 'Fuentes_Intel': 'fuentes', 'Mitigaciones': 'mitigaciones'
                };
                
                let importSummary = [];

                for (const sheetName of workbook.SheetNames) {
                    if (sheetToEndpointMap[sheetName]) {
                        const endpoint = sheetToEndpointMap[sheetName];
                        const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName]);

                        if(jsonData && jsonData.length > 0) {
                            const importedCount = await importarRegistros(endpoint, jsonData);
                            importSummary.push(`${importedCount} registros importados a la sección '${sheetName}'.`);
                        }
                    }
                }
                
                await fetchAndCacheAllData();
                
                if (document.getElementById('dashboard').classList.contains('active')) {
                    await renderDynamicDashboard();
                }
                
                if (importSummary.length > 0) {
                    alert('Importación completada:\n\n' + importSummary.join('\n'));
                } else {
                    alert('No se encontraron hojas con nombres válidos o datos para importar en el archivo seleccionado.');
                }

            } catch (error) {
                console.error('Error al importar el archivo Excel:', error);
                alert('Ocurrió un error al procesar el archivo. Verifique que el formato sea correcto y revise la consola para más detalles.');
            } finally {
                event.target.value = '';
            }
        };
        reader.readAsArrayBuffer(file);
    }

    async function importarRegistros(endpoint, registros) {
        let successCount = 0;
        for (const registro of registros) {
            try {
                const response = await fetch(`${API_BASE_URL}/${endpoint}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(registro)
                });

                if (response.ok) {
                    successCount++;
                } else {
                    const errorData = await response.json();
                    console.warn(`Error al importar registro a '${endpoint}':`, errorData.message, registro);
                }
            } catch (error) {
                console.error(`Error de red o conexión al importar a '${endpoint}':`, error, registro);
            }
        }
        return successCount;
    }
</script>
</body>
</html>