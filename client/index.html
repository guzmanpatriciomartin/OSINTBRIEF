<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OSINT BRIEF</title>

    <!-- PWA Metadata -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#3498db">
    <meta name="mobile-web-app-capable" content="yes">

    <!-- Service Worker Registration (ensure sw.js and manifest.json exist) -->
    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('sw.js')
            .then(registration => console.log('ServiceWorker registration successful'))
            .catch(err => console.log('ServiceWorker registration failed (expected on file:///): ', err));
        });
      }
    </script>

    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">


    <style>
        :root {
            --primary: #2c3e50; 
            --secondary: #3498db; 
            --danger: #e74c3c; 
            --warning: #f39c12; 
            --success: #2ecc71; 
            --info: #5dade2; 
            --light: #ecf0f1; 
            --dark: #34495e; 
            --bg-color: #f4f7f9;
            --purple-gradient-start: #6a3093;
            --purple-gradient-end: #a044ff;
            --border-color: #e0e6ed;
            --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            --border-radius: 8px;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            font-family: 'Roboto', sans-serif; 
            background-color: var(--bg-color); 
            color: var(--dark); 
            line-height: 1.6; 
            margin: 0;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .app-container { display: flex; flex-direction: column; min-height: 100vh; }
        .main-content-area { flex-grow: 1; padding: 25px; }
        .container { 
            max-width: 1400px; 
            margin: 0 auto; 
            background: white; 
            padding: 25px; 
            box-shadow: var(--card-shadow);
            border-radius: var(--border-radius); 
            border: 1px solid var(--border-color);
        }
        h1, h2, h3 { color: var(--primary); font-weight: 500;}
        h2 { font-size: 1.5rem; }
        h3 { font-size: 1.2rem; }

        .form-group { margin-bottom: 18px; }
        label { display: block; margin-bottom: 6px; font-weight: 500; color: #555; font-size: 0.875rem;}
        input[type="text"], input[type="date"], input[type="number"], input[type="url"], textarea, select { 
            width: 100%; 
            padding: 12px; 
            border: 1px solid var(--border-color); 
            border-radius: var(--border-radius); 
            font-size: 0.95rem; 
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
            background-color: #fff;
        }
        input[type="text"]:focus, input[type="date"]:focus, input[type="number"]:focus, input[type="url"]:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--secondary);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }
        textarea { resize: vertical; min-height: 100px; }

        button, .btn { 
            background: var(--secondary); 
            color: white; 
            border: none; 
            padding: 10px 18px; 
            border-radius: var(--border-radius); 
            cursor: pointer; 
            margin-right: 10px; 
            font-size: 0.9rem; 
            font-weight: 500;
            transition: background-color 0.2s ease, transform 0.1s ease; 
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        button:hover, .btn:hover { background: #2980b9; transform: translateY(-1px); }
        button:active, .btn:active { transform: translateY(0); }
        .btn-danger { background-color: var(--danger); }
        .btn-danger:hover { background-color: #c0392b; }
        .btn-edit { background-color: var(--warning); color: white; }
        .btn-edit:hover { background-color: #d68910; }
        .btn-success { background-color: var(--success); }
        .btn-success:hover { background-color: #27ae60; }
        
     .app-header {
        background-color: var(--primary);
        padding: 15px 25px;
        color: white;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
        .app-header h1 { font-size: 1.6em; margin:0; color: white; font-weight: 700;}

        .dropdown-menu-container { position: relative; }
        .menu-toggle-btn { background: rgba(255,255,255,0.2); color: white; padding: 8px 12px; border-radius: var(--border-radius); font-size: 1em; }
        .menu-toggle-btn:hover { background: rgba(255,255,255,0.3); }
        .dropdown-menu {
            display: none;
            position: absolute;
            right: 0;
            top: calc(100% + 5px);
            background-color: var(--primary);
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
            z-index: 1000;
            border-radius: var(--border-radius);
            min-width: 220px;
            padding: 8px;
            overflow: hidden;
        }
        .dropdown-menu a {
            color: var(--light);
            padding: 10px 15px;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 0.95em;
            border-radius: 6px;
            transition: background-color 0.2s ease, color 0.2s ease;
        }
        .dropdown-menu a i { 
            color: var(--light); 
            opacity: 0.7; 
            transition: color 0.2s ease;
        }
        .dropdown-menu a:hover { 
            background-color: var(--dark); 
            color: white; 
        }
        .dropdown-menu a:hover i { color: white; opacity: 1; }
        .dropdown-menu a.active { background-color: var(--secondary); color: white; font-weight: 500; }
        .dropdown-menu a.active i { color: white; opacity: 1; }
        .dropdown-menu-container.open .dropdown-menu { display: block; }

        .tab-content { display: none; background-color: transparent; padding: 0; }
        .tab-content.active { display: block; }
        
        .dashboard-header { 
            background: var(--primary);
            color: white; 
            padding: 25px; 
            border-radius: 12px; 
            margin-bottom: 25px; 
            box-shadow: var(--card-shadow); 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            flex-wrap: wrap; 
        }
        .header-text h1 { font-size: 24px; font-weight: 700; margin-bottom: 5px; color: white; }
        .header-text p { opacity: 0.9; font-size: 13px; }
        .header-stats { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 10px; } 
        .stat-box { background: rgba(255, 255, 255, 0.15); padding: 8px 10px; border-radius: 8px; text-align: center; min-width: 75px; cursor: pointer; transition: transform 0.2s ease, background-color 0.2s ease; } 
        .stat-box:hover { transform: translateY(-3px); background: rgba(255, 255, 255, 0.25); }
        .stat-value { font-size: 18px; font-weight: 700; margin-bottom: 2px; } 
        .stat-label { font-size: 9px; opacity: 0.8; text-transform: uppercase; } 
        .critical { color: var(--danger); } .high { color: var(--warning); } .medium { color: #f1c40f; } .low { color: var(--success); } .info-stat { color: var(--info); }
        
        .dashboard-controls {
            background: white; padding: 20px; border-radius: var(--border-radius);
            margin-bottom: 25px; box-shadow: var(--card-shadow); border: 1px solid var(--border-color);
            display: flex; align-items: center; flex-wrap: wrap; gap: 15px;
        }
        .dashboard-controls .form-group { margin-bottom: 0; }

        .grid { display: grid; grid-template-columns: repeat(12, 1fr); gap: 25px; margin-bottom: 25px; }
        .card { background: white; border-radius: 12px; padding: 20px; box-shadow: var(--card-shadow); border: 1px solid var(--border-color); }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid var(--border-color); padding-bottom: 15px; }
        .card-title { font-size: 1.1rem; font-weight: 500; color: var(--primary); }
        .chart-container { position: relative; min-height: 280px; width: 100%; }
        .col-6 { grid-column: span 6; } .col-4 { grid-column: span 4; } .col-8 { grid-column: span 8; } .col-12 { grid-column: span 12; }
        
        .dashboard-alerts-container { max-height: 400px; overflow-y: auto; padding-right: 10px; } 
        .alert-dashboard-item { border-left-width: 4px; border-left-style: solid; padding: 12px 18px; margin-bottom: 12px; border-radius: var(--border-radius); display: flex; align-items: flex-start; transition: box-shadow .2s ease; }
        .alert-dashboard-item:hover { box-shadow: var(--card-shadow); }
        .alert-dashboard-item.critical-alert { background-color: #ffebee; border-left-color: var(--danger); }
        .alert-dashboard-item.high-alert { background-color: #fff3e0; border-left-color: var(--warning); }
        .alert-dashboard-item.medium-alert { background-color: #fff8e1; border-left-color: #f1c40f; }
        .alert-dashboard-item.low-alert { background-color: #e8f5e9; border-left-color: var(--success); }
        .alert-dashboard-item.info-alert { background-color: #e3f2fd; border-left-color: var(--info); }

        .alert-icon { font-size: 20px; margin-right: 15px; line-height: 1.2; }
        .alert-content h3 { font-size: 1rem; margin-bottom: 3px; color: var(--dark); font-weight: 500; } 
        .alert-content p { font-size: 0.875rem; color: #666; margin: 0; }
        .alert-content .alert-date { font-size: 0.75rem; color: #777; margin-top: 5px; display: block; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 0.9rem; }
        th, td { padding: 12px 15px; text-align: left; vertical-align: middle;}
        thead tr { border-bottom: 2px solid var(--primary); }
        th { background-color: transparent; font-weight: 500; color: var(--primary); text-transform: uppercase; font-size: 0.8rem; }
        tbody tr { border-bottom: 1px solid var(--border-color); }
        tbody tr:last-of-type { border-bottom: none; }
        tbody tr:hover { background-color: #f8fafc; }
        td.actions-cell { white-space: nowrap; width: 1%; text-align: right; } 
        .actions-cell button { margin-right: 5px !important; padding: 6px 10px; font-size: 0.8rem; } 
        .actions-cell button:last-child { margin-right: 0 !important; }
        
        .badge { display: inline-block; padding: 4px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: 500; margin-right: 5px; text-transform: capitalize; border: 1px solid transparent;}
        .badge-critical { background-color: #ffebee; color: var(--danger); border-color: var(--danger); } 
        .badge-high { background-color: #fff3e0; color: var(--warning); border-color: var(--warning); }
        .badge-medium { background-color: #fff8e1; color: #f39c12; border-color: #f39c12; } 
        .badge-low { background-color: #e8f5e9; color: var(--success); border-color: var(--success); }
        .badge-info { background-color: #e3f2fd; color: var(--info); border-color: var(--info); }
        .badge-country { background-color: var(--primary); color: white; }
        .badge-sector { background-color: var(--secondary); color: white; }
        .badge-estado-activo { background-color: var(--danger); color: white; }
        .badge-estado-mitigado { background-color: var(--success); color: white; }
        .badge-estado-investigacion { background-color: var(--warning); color: var(--dark); }
        .badge-estado-poc { background-color: var(--info); color: white; }
        
        .form-container {
            border: 1px solid var(--border-color); padding: 25px; border-radius: var(--border-radius); margin-bottom: 25px;
            background-color: #fdfdfe; display: none;
        }
        .toggle-form-btn-container { margin-bottom: 25px; }
        .toggle-form-btn { background-color: var(--primary); }
        .toggle-form-btn:hover { background-color: var(--dark); }

        footer { text-align: center; margin-top: 40px; padding: 25px; color: #777; font-size: 0.85rem; border-top: 1px solid var(--border-color); background-color: var(--light); }
        .search-box { margin-bottom: 20px; } 
        .search-box input { max-width: 400px; padding: 12px; border: 1px solid var(--border-color); border-radius: var(--border-radius); }
        .action-buttons { margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap;}

        .form-row { display: flex; gap: 20px; } 
        .form-row .form-group { flex: 1; }
        .form-title-action { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .form-title-action h2 { margin: 0; }
        .form-title-action button { margin-right: 0; }


        @media (max-width: 992px) { 
            .grid { grid-template-columns: repeat(6, 1fr); } 
            .col-12, .col-8, .col-6, .col-4 { grid-column: span 6; }
        }
        @media (max-width: 768px) {
            .main-content-area { padding: 15px; }
            .container { padding: 15px; }
            .app-header h1 { font-size: 1.2em; }
            .menu-toggle-btn { font-size: 0.9em; padding: 6px 10px; }
            .dashboard-header, .dashboard-controls { flex-direction: column; align-items: stretch;}
            .header-stats { flex-direction: row; gap: 6px; margin-top: 15px; align-items: stretch; width: 100%; justify-content: space-around;}
            .stat-box { min-width: 0; flex-basis: calc(33.33% - 8px); padding: 6px;} 
            .stat-value { font-size: 16px; }
            .stat-label { font-size: 8px;}
            .grid { grid-template-columns: 1fr; gap: 15px; } 
            .col-12, .col-8, .col-6, .col-4 { grid-column: span 1; }
            .form-row { flex-direction: column; gap:0; }
        }
         @media (max-width: 480px) {
            .header-stats { gap: 5px; }
            .stat-box { flex-basis: calc(50% - 5px); } 
         }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="app-header">
            <h1><i class="fa-solid fa-shield-halved" style="margin-right: 10px;"></i>OSINT Brief</h1>
            <img id="fondo-pdf" src="fondo.jpg" style="display: none;" />
            <div class="dropdown-menu-container" id="navMenuContainer">
                <button class="menu-toggle-btn" onclick="toggleNavMenu()">☰ Menú</button>
                <nav class="dropdown-menu" id="appNavigation">
                    <a href="#" class="nav-link active" data-tab-name="dashboard"><i class="fa-fw fa-solid fa-chart-pie"></i>Dashboard</a>
                    <a href="#" class="nav-link" data-tab-name="incidentes"><i class="fa-fw fa-solid fa-triangle-exclamation"></i>Incidentes</a>
                    <a href="#" class="nav-link" data-tab-name="exploits"><i class="fa-fw fa-solid fa-code-branch"></i>Exploits</a>
                    <a href="#" class="nav-link" data-tab-name="zero-days"><i class="fa-fw fa-solid fa-star"></i>Zero Days</a>
                    <a href="#" class="nav-link" data-tab-name="cves"><i class="fa-fw fa-solid fa-bug"></i>CVEs</a>
                    <a href="#" class="nav-link" data-tab-name="alertas"><i class="fa-fw fa-solid fa-bell"></i>Alertas</a>
                    <a href="#" class="nav-link" data-tab-name="fuentes"><i class="fa-fw fa-solid fa-book-journal-whills"></i>Fuentes Intel</a>
                    <a href="#" class="nav-link" data-tab-name="mitigaciones"><i class="fa-fw fa-solid fa-shield-virus"></i>Mitigaciones</a>
                    <a href="#" class="nav-link" data-tab-name="reporte"><i class="fa-fw fa-solid fa-file-export"></i>Exportar</a>
                </nav>
            </div>
        </header>

        <div class="main-content-area">
            <!-- Dashboard Tab -->
            <div id="dashboard" class="tab-content active">
                <div style="background: transparent; box-shadow: none; padding:0;">
                    <header class="dashboard-header">
                        <div class="header-text">
                            <h1>Dashboard de Inteligencia de Amenazas</h1>
                            <p id="dashboardDate">Mostrando todos los datos registrados.</p>
                        </div>
                        <div class="header-stats">
                            <div class="stat-box" onclick="navigateToTab('incidentes')"><div class="stat-value critical" id="statIncidents">0</div><div class="stat-label">Incidentes</div></div>
                            <div class="stat-box" onclick="navigateToTab('exploits')"><div class="stat-value high" id="statExploits">0</div><div class="stat-label">Exploits</div></div>
                            <div class="stat-box" onclick="navigateToTab('zero-days')"><div class="stat-value medium" id="statZeroDays">0</div><div class="stat-label">ZeroDays</div></div>
                            <div class="stat-box" onclick="navigateToTab('cves')"><div class="stat-value" id="statCVEs">0</div><div class="stat-label">CVEs</div></div>
                            <div class="stat-box" onclick="navigateToTab('alertas')"><div class="stat-value info-stat" id="statAlerts">0</div><div class="stat-label">Alertas</div></div>
                            <div class="stat-box" onclick="navigateToTab('fuentes')"><div class="stat-value" id="statFuentes">0</div><div class="stat-label">Fuentes</div></div>
                            <div class="stat-box" onclick="navigateToTab('mitigaciones')"><div class="stat-value" id="statMitigaciones">0</div><div class="stat-label">Mitigaciones</div></div>
                        </div>
                    </header>
                    
                    <div class="dashboard-controls">
                        <div class="form-group">
                            <label for="dashboardStartDate">Fecha de Inicio:</label>
                            <input type="date" id="dashboardStartDate">
                        </div>
                        <div class="form-group">
                            <label for="dashboardEndDate">Fecha de Fin:</label>
                            <input type="date" id="dashboardEndDate">
                        </div>
                        <button id="applyDashboardFilterBtn" class="btn-success"><i class="fa-solid fa-filter"></i>Aplicar Filtro</button>
                        <button id="resetDashboardFilterBtn"><i class="fa-solid fa-arrows-rotate"></i>Resetear</button>
                    </div>

                    <div class="grid">
                        <div class="card col-12"><div class="card-header"><h2 class="card-title"><i class="fa-solid fa-timeline" style="margin-right: 10px; color: var(--secondary)"></i>Línea de Tiempo de Amenazas</h2></div><div class="chart-container" style="height: 350px;"><canvas id="timelineChart"></canvas></div></div>
                        <div class="card col-6"><div class="card-header"><h2 class="card-title"><i class="fa-solid fa-bell" style="margin-right: 10px; color: var(--secondary)"></i>Últimas Alertas Registradas</h2></div><div class="dashboard-alerts-container" id="dashboardAllAlertsContainer"><p>No hay alertas registradas.</p></div></div>
                        <div class="card col-6"><div class="card-header"><h2 class="card-title"><i class="fa-solid fa-chart-column" style="margin-right: 10px; color: var(--secondary)"></i>Alertas por Criticidad</h2></div><div class="chart-container"><canvas id="alertsBySeverityChart"></canvas></div></div>
                        <div class="card col-4"><div class="card-header"><h2 class="card-title"><i class="fa-solid fa-chart-pie" style="margin-right: 10px; color: var(--secondary)"></i>Incidentes por Tipo</h2></div><div class="chart-container"><canvas id="incidentsTypeChart"></canvas></div></div>
                        <div class="card col-4"><div class="card-header"><h2 class="card-title"><i class="fa-solid fa-chart-pie" style="margin-right: 10px; color: var(--secondary)"></i>Incidentes por Sector</h2></div><div class="chart-container"><canvas id="incidentsSectorChart"></canvas></div></div>
                        <div class="card col-4"><div class="card-header"><h2 class="card-title"><i class="fa-solid fa-building-shield" style="margin-right: 10px; color: var(--secondary)"></i>Top 5 Entidades Afectadas</h2></div><div class="chart-container"><canvas id="topAffectedEntitiesChart"></canvas></div></div>
                        <div class="card col-4"><div class="card-header"><h2 class="card-title"><i class="fa-solid fa-radar" style="margin-right: 10px; color: var(--secondary)"></i>CVEs Recientes (Radar)</h2></div><div class="chart-container"><canvas id="severityChart"></canvas></div></div>
                        <div class="card col-4"><div class="card-header"><h2 class="card-title"><i class="fa-solid fa-chart-pie" style="margin-right: 10px; color: var(--secondary)"></i>CVEs por Estado</h2></div><div class="chart-container"><canvas id="cvesByStatusChart"></canvas></div></div>
                        <div class="card col-4"><div class="card-header"><h2 class="card-title"><i class="fa-solid fa-chart-pie" style="margin-right: 10px; color: var(--secondary)"></i>Zero Days por Estado</h2></div><div class="chart-container"><canvas id="zeroDaysByStatusChart"></canvas></div></div>
                        <div class="card col-6"><div class="card-header"><h2 class="card-title"><i class="fa-solid fa-chart-pie" style="margin-right: 10px; color: var(--secondary)"></i>Exploits por Tipo</h2></div><div class="chart-container"><canvas id="exploitsByTypeChart"></canvas></div></div>
                        <div class="card col-6"><div class="card-header"><h2 class="card-title"><i class="fa-solid fa-laptop-code" style="margin-right: 10px; color: var(--secondary)"></i>Top 5 Plataformas (Exploits)</h2></div><div class="chart-container"><canvas id="topPlatformsExploitsChart"></canvas></div></div>
                        <div class="card col-4"><div class="card-header"><h2 class="card-title"><i class="fa-solid fa-chart-pie" style="margin-right: 10px; color: var(--secondary)"></i>Fuentes de Intel por Tipo</h2></div><div class="chart-container"><canvas id="fuentesByTypeChart"></canvas></div></div>
                        <div class="card col-4"><div class="card-header"><h2 class="card-title"><i class="fa-solid fa-chart-column" style="margin-right: 10px; color: var(--secondary)"></i>Mitigaciones por Categoría</h2></div><div class="chart-container"><canvas id="mitigacionesByCatChart"></canvas></div></div>
                        <div class="card col-4"><div class="card-header"><h2 class="card-title"><i class="fa-solid fa-chart-pie" style="margin-right: 10px; color: var(--secondary)"></i>Mitigaciones por Prioridad</h2></div><div class="chart-container"><canvas id="mitigacionesByPrioChart"></canvas></div></div>
                        <div class="card col-12"><div class="card-header"><h2 class="card-title"><i class="fa-solid fa-bug-slash" style="margin-right: 10px; color: var(--secondary)"></i>Últimas Vulnerabilidades (CVEs)</h2></div><table id="dashboardCVEsTable"><thead><tr><th>ID</th><th>Aplicativo</th><th>Severidad</th><th>Estado</th><th>CVSS</th></tr></thead><tbody></tbody></table></div>
                        <div class="card col-12"><div class="card-header"><h2 class="card-title"><i class="fa-solid fa-server" style="margin-right: 10px; color: var(--secondary)"></i>Incidentes Detectados Recientes</h2></div><table id="dashboardIncidentsTable"><thead><tr><th>Fecha</th><th>Entidad</th><th>País</th><th>Sector</th><th>Tipo</th><th>Descripción</th></tr></thead><tbody></tbody></table></div>
                        <div class="card col-6"><div class="card-header"><h2 class="card-title"><i class="fa-solid fa-star" style="margin-right: 10px; color: var(--secondary)"></i>ZeroDays Recientes</h2></div><table id="dashboardZeroDaysTable"><thead><tr><th>ID</th><th>Nombre</th><th>Plataforma</th><th>Fecha</th><th>Estado</th><th>CVSS</th></tr></thead><tbody></tbody></table></div>
                        <div class="card col-6"><div class="card-header"><h2 class="card-title"><i class="fa-solid fa-terminal" style="margin-right: 10px; color: var(--secondary)"></i>Exploits Recientes</h2></div><table id="dashboardExploitsTable"><thead><tr><th>Fecha</th><th>Nombre</th><th>Tipo</th><th>Plataforma</th></tr></thead><tbody></tbody></table></div>
                    </div>
                </div>
            </div>

            <!-- Formulario de Incidentes -->
            <div id="incidentes" class="tab-content"><div class="container">
                <div class="toggle-form-btn-container"><button class="toggle-form-btn" onclick="toggleForm('incidenteFormContainer', 'incidenteForm')"><i class="fa-solid fa-plus"></i>Registrar Nuevo Incidente</button></div>
                <div id="incidenteFormContainer" class="form-container">
                    <div class="form-title-action">
                        <h2 id="incidenteFormTitle">Registrar Incidente</h2>
                        <button class="btn-danger" id="cancelIncidenteEditBtn" style="display:none;" onclick="cancelEdit('incidenteForm', 'incidenteFormTitle', 'Registrar Incidente', 'guardarIncidenteBtn', 'Guardar Incidente')"><i class="fa-solid fa-times"></i> Cancelar</button>
                    </div>
                    <form id="incidenteForm">
                        <input type="hidden" id="incidenteEditId">
                        <div class="form-row">
                            <div class="form-group"><label for="fechaIncidente">Fecha:</label><input type="date" id="fechaIncidente" required></div>
                            <div class="form-group"><label for="tipoIncidente">Tipo:</label><select id="tipoIncidente" required><option value="DataBreach">Data Breach</option><option value="Ransomware">Ransomware</option><option value="CyberAttack">Cyber Attack (General)</option><option value="DataLeak">Data Leak</option><option value="Phishing">Phishing</option><option value="Defacement">Website Defacement</option><option value="Botnet">Botnet Activity</option><option value="SupplyChain">Supply Chain Attack</option></select></div>
                        </div>
                        <div class="form-group"><label for="entidadIncidente">Entidad Afectada:</label><input type="text" id="entidadIncidente" required></div>
                        <div class="form-row">
                            <div class="form-group"><label for="paisIncidente">País:</label><input type="text" id="paisIncidente" placeholder="Ej: Argentina"></div>
                            <div class="form-group"><label for="sectorIncidente">Sector:</label><input type="text" id="sectorIncidente" placeholder="Ej: Energía, Agro, Salud"></div>
                        </div>
                        <div class="form-group"><label for="descripcionIncidente">Descripción:</label><textarea id="descripcionIncidente" required></textarea></div>
                        <div class="form-group"><label for="datosComprometidosIncidente">Datos Comprometidos:</label><input type="text" id="datosComprometidosIncidente"></div>
                        <div class="form-group"><label for="actorIncidente">Actor de Amenazas:</label><input type="text" id="actorIncidente"></div>
                        <div class="form-group"><label for="urlIncidente">URL de Referencia (Opcional):</label><input type="url" id="urlIncidente"></div>
                        <button type="submit" id="guardarIncidenteBtn"><i class="fa-solid fa-save"></i> Guardar Incidente</button>
                    </form>
                </div>
                <div class="search-box"><input type="text" id="searchIncidentes" placeholder="Buscar incidentes..." onkeyup="buscarIncidentes()"></div>
                <h2>Incidentes Registrados</h2>
                <table id="tablaIncidentes"><thead><tr><th>Fecha</th><th>Entidad</th><th>País</th><th>Sector</th><th>Tipo</th><th>Actor</th><th class="actions-cell">Acciones</th></tr></thead><tbody></tbody></table>
            </div></div>

            <!-- Formulario de Exploits -->
            <div id="exploits" class="tab-content"><div class="container">
                <div class="toggle-form-btn-container"><button class="toggle-form-btn" onclick="toggleForm('exploitFormContainer', 'exploitForm')"><i class="fa-solid fa-plus"></i>Registrar Nuevo Exploit</button></div>
                <div id="exploitFormContainer" class="form-container">
                    <div class="form-title-action">
                        <h2 id="exploitFormTitle">Registrar Exploit</h2>
                        <button class="btn-danger" id="cancelExploitEditBtn" style="display:none;" onclick="cancelEdit('exploitForm', 'exploitFormTitle', 'Registrar Exploit', 'guardarExploitBtn', 'Guardar Exploit')"><i class="fa-solid fa-times"></i> Cancelar</button>
                    </div>
                    <form id="exploitForm">
                        <input type="hidden" id="exploitEditId">
                        <div class="form-row">
                            <div class="form-group"><label for="fechaExploit">Fecha Publicación/Descubrimiento:</label><input type="date" id="fechaExploit" required></div>
                            <div class="form-group"><label for="tipoExploit">Tipo:</label><select id="tipoExploit" required><option value="Network">Network</option><option value="Local">Local</option><option value="RemoteCodeExecution">Remote Code Execution</option><option value="PrivilegeEscalation">Privilege Escalation</option><option value="WebApplication">Web Application</option><option value="DoS">Denial of Service</option><option value="XSS">XSS</option></select></div>
                        </div>
                        <div class="form-group"><label for="nombreExploit">Nombre/Descripción Exploit:</label><input type="text" id="nombreExploit" required placeholder="Ej: XSS en Label Studio"></div>
                        <div class="form-group"><label for="plataformaExploit">Plataforma Afectada:</label><input type="text" id="plataformaExploit" required placeholder="Ej: Label Studio, FortiManager 7.6.0"></div>
                        <div class="form-group"><label for="cveExploit">CVE Asociado (opcional):</label><input type="text" id="cveExploit" placeholder="Ej: CVE-2023-12345"></div>
                        <div class="form-group"><label for="urlExploit">URL de Referencia (Opcional):</label><input type="url" id="urlExploit"></div>
                        <button type="submit" id="guardarExploitBtn"><i class="fa-solid fa-save"></i> Guardar Exploit</button>
                    </form>
                </div>
                <div class="search-box"><input type="text" id="searchExploits" placeholder="Buscar exploits..." onkeyup="buscarExploits()"></div>
                <h2>Exploits Registrados</h2>
                <table id="tablaExploits"><thead><tr><th>Fecha</th><th>Nombre</th><th>Tipo</th><th>Plataforma</th><th>CVE</th><th class="actions-cell">Acciones</th></tr></thead><tbody></tbody></table>
            </div></div>

            <!-- Formulario de Zero Days -->
            <div id="zero-days" class="tab-content"><div class="container">
                <div class="toggle-form-btn-container"><button class="toggle-form-btn" onclick="toggleForm('zeroDayFormContainer', 'zeroDayForm')"><i class="fa-solid fa-plus"></i>Registrar Nuevo Zero Day</button></div>
                 <div id="zeroDayFormContainer" class="form-container">
                    <div class="form-title-action">
                        <h2 id="zeroDayFormTitle">Registrar Zero Day</h2>
                        <button class="btn-danger" id="cancelZeroDayEditBtn" style="display:none;" onclick="cancelEdit('zeroDayForm', 'zeroDayFormTitle', 'Registrar Zero Day', 'guardarZeroDayBtn', 'Guardar Zero Day')"><i class="fa-solid fa-times"></i> Cancelar</button>
                    </div>
                    <form id="zeroDayForm">
                        <input type="hidden" id="zeroDayEditId">
                        <div class="form-row">
                            <div class="form-group"><label for="idZD">ID Zero-Day (Ej: ZDI-ID, interno):</label><input type="text" id="idZD" placeholder="Ej: ZDI-2025-001"></div>
                            <div class="form-group"><label for="fechaZD">Fecha Detección:</label><input type="date" id="fechaZD" required></div>
                        </div>
                        <div class="form-group"><label for="nombreZD">Nombre/Vulnerabilidad:</label><input type="text" id="nombreZD" required placeholder="Ej: Windows Kernel Privilege Escalation"></div>
                        <div class="form-group"><label for="plataformaZD">Plataforma/Software Afectado:</label><input type="text" id="plataformaZD" required placeholder="Ej: Microsoft Windows, Apache Struts"></div>
                        <div class="form-row">
                            <div class="form-group"><label for="cvssZD">CVSS (Estimado):</label><input type="number" id="cvssZD" step="0.1" min="0" max="10" required></div>
                            <div class="form-group"><label for="estadoZD">Estado:</label><select id="estadoZD" required><option value="Activo">Activo</option><option value="Mitigado">Mitigado</option><option value="Investigacion">En Investigación</option><option value="PruebaDeConcepto">Prueba de Concepto</option></select></div>
                        </div>
                        <div class="form-group"><label for="urlZD">URL de Referencia (Opcional):</label><input type="url" id="urlZD" placeholder="https://example.com/zero-day-info"></div>
                        <div class="form-group"><label for="descripcionZD">Descripción Adicional/Requisitos:</label><textarea id="descripcionZD"></textarea></div>
                        <button type="submit" id="guardarZeroDayBtn"><i class="fa-solid fa-save"></i> Guardar Zero Day</button>
                    </form>
                </div>
                <div class="search-box"><input type="text" id="searchZeroDays" placeholder="Buscar zero days..." onkeyup="buscarZeroDays()"></div>
                <h2>Zero Days Registrados</h2>
                <table id="tablaZeroDays"><thead><tr><th>ID</th><th>Nombre</th><th>Plataforma</th><th>Fecha</th><th>CVSS</th><th>Estado</th><th class="actions-cell">Acciones</th></tr></thead><tbody></tbody></table>
            </div></div>

            <!-- Formulario de CVEs -->
            <div id="cves" class="tab-content"><div class="container">
                <div class="toggle-form-btn-container"><button class="toggle-form-btn" onclick="toggleForm('cveFormContainer', 'cveForm')"><i class="fa-solid fa-plus"></i>Registrar Nuevo CVE</button></div>
                <div id="cveFormContainer" class="form-container">
                    <div class="form-title-action">
                        <h2 id="cveFormTitle">Registrar CVE</h2>
                        <button class="btn-danger" id="cancelCveEditBtn" style="display:none;" onclick="cancelEdit('cveForm', 'cveFormTitle', 'Registrar CVE', 'guardarCveBtn', 'Guardar CVE')"><i class="fa-solid fa-times"></i> Cancelar</button>
                    </div>
                    <form id="cveForm">
                        <input type="hidden" id="cveEditId">
                        <div class="form-row">
                            <div class="form-group"><label for="idCVE">ID CVE:</label><input type="text" id="idCVE" required placeholder="Ej: CVE-2023-12345"></div>
                            <div class="form-group"><label for="fechaCVE">Fecha Publicación:</label><input type="date" id="fechaCVE" required></div>
                        </div>
                        <div class="form-group"><label for="aplicativoCVE">Aplicativo/Producto Afectado:</label><input type="text" id="aplicativoCVE" required></div>
                        <div class="form-row">
                            <div class="form-group"><label for="cvssCVE">CVSS 3.x:</label><input type="number" id="cvssCVE" step="0.1" min="0" max="10" required></div>
                            <div class="form-group"><label for="estadoCVE">Estado:</label><select id="estadoCVE"><option value="Publicado">Publicado</option><option value="ExplotadoActivamente">Explotado Activamente</option><option value="PruebaDeConcepto">Prueba de Concepto Disponible</option><option value="Parcheado">Parcheado</option><option value="Analisis">En Análisis</option></select></div>
                        </div>
                        <div class="form-group"><label for="descripcionCVE">Descripción Breve:</label><textarea id="descripcionCVE" required></textarea></div>
                        <div class="form-group"><label for="urlCVE">URL de Referencia (Opcional):</label><input type="url" id="urlCVE"></div>
                        <button type="submit" id="guardarCveBtn"><i class="fa-solid fa-save"></i> Guardar CVE</button>
                    </form>
                </div>
                <div class="search-box"><input type="text" id="searchCVEs" placeholder="Buscar CVEs..." onkeyup="buscarCVEs()"></div>
                <h2>CVEs Registrados</h2>
                <table id="tablaCVEs"><thead><tr><th>ID</th><th>Aplicativo</th><th>Fecha Pub.</th><th>CVSS</th><th>Estado</th><th class="actions-cell">Acciones</th></tr></thead><tbody></tbody></table>
            </div></div>

            <!-- Formulario de Alertas -->
            <div id="alertas" class="tab-content"><div class="container">
                <div class="toggle-form-btn-container"><button class="toggle-form-btn" onclick="toggleForm('alertaFormContainer', 'alertaForm')"><i class="fa-solid fa-plus"></i>Registrar Nueva Alerta</button></div>
                <div id="alertaFormContainer" class="form-container">
                    <div class="form-title-action">
                        <h2 id="alertaFormTitle">Registrar Alerta de Seguridad</h2>
                        <button class="btn-danger" id="cancelAlertaEditBtn" style="display:none;" onclick="cancelEdit('alertaForm', 'alertaFormTitle', 'Registrar Alerta', 'guardarAlertaBtn', 'Guardar Alerta')"><i class="fa-solid fa-times"></i> Cancelar</button>
                    </div>
                    <form id="alertaForm">
                        <input type="hidden" id="alertaEditId">
                        <div class="form-row">
                            <div class="form-group"><label for="tituloAlerta">Título de la Alerta:</label><input type="text" id="tituloAlerta" required></div>
                            <div class="form-group"><label for="fechaAlerta">Fecha de Alerta:</label><input type="date" id="fechaAlerta" required></div>
                        </div>
                        <div class="form-group"><label for="descripcionAlerta">Descripción Detallada:</label><textarea id="descripcionAlerta" required></textarea></div>
                        <div class="form-group"><label for="criticidadAlerta">Criticidad:</label><select id="criticidadAlerta" required><option value="Informacional">Informacional</option><option value="Baja">Baja</option><option value="Media">Media</option><option value="Alta">Alta</option><option value="Critica">Crítica</option></select></div>
                        <div class="form-group"><label for="urlAlerta">URL de Referencia (Opcional):</label><input type="url" id="urlAlerta"></div>
                        <button type="submit" id="guardarAlertaBtn"><i class="fa-solid fa-save"></i> Guardar Alerta</button>
                    </form>
                </div>
                <div class="search-box"><input type="text" id="searchAlertas" placeholder="Buscar alertas..." onkeyup="buscarAlertas()"></div>
                <h2>Alertas Registradas</h2>
                <table id="tablaAlertas"><thead><tr><th>Fecha</th><th>Título</th><th>Criticidad</th><th>Descripción</th><th class="actions-cell">Acciones</th></tr></thead><tbody></tbody></table>
            </div></div>

            <!-- Formulario de Fuentes de Inteligencia -->
            <div id="fuentes" class="tab-content"><div class="container">
                <div class="toggle-form-btn-container"><button class="toggle-form-btn" onclick="toggleForm('fuenteFormContainer', 'fuenteForm')"><i class="fa-solid fa-plus"></i>Registrar Nueva Fuente</button></div>
                 <div id="fuenteFormContainer" class="form-container">
                    <div class="form-title-action">
                        <h2 id="fuenteFormTitle">Registrar Fuente de Inteligencia</h2>
                        <button class="btn-danger" id="cancelFuenteEditBtn" style="display:none;" onclick="cancelEdit('fuenteForm', 'fuenteFormTitle', 'Registrar Fuente', 'guardarFuenteBtn', 'Guardar Fuente')"><i class="fa-solid fa-times"></i> Cancelar</button>
                    </div>
                    <form id="fuenteForm">
                        <input type="hidden" id="fuenteEditId">
                        <div class="form-row">
                            <div class="form-group"><label for="nombreFuente">Nombre de la Fuente:</label><input type="text" id="nombreFuente" required placeholder="Ej: FortiGuard Labs, MITRE ATT&CK"></div>
                            <div class="form-group"><label for="fechaFuente">Fecha:</label><input type="date" id="fechaFuente" required></div>
                        </div>
                        <div class="form-group"><label for="tipoFuente">Tipo de Fuente:</label><select id="tipoFuente"><option value="OSINT">OSINT</option><option value="VendorReport">Vendor Report</option><option value="ThreatFeed">Threat Feed</option><option value="Forum">Security Forum</option><option value="Internal">Internal Research</option></select></div>
                        <div class="form-group"><label for="urlFuente">URL:</label><input type="url" id="urlFuente"></div>
                        <div class="form-group"><label for="descripcionFuente">Descripción/Notas:</label><textarea id="descripcionFuente" placeholder="Ej: Detección de campañas de ransomware, Tácticas y técnicas de grupos de amenazas"></textarea></div>
                        <button type="submit" id="guardarFuenteBtn"><i class="fa-solid fa-save"></i> Guardar Fuente</button>
                    </form>
                </div>
                <div class="search-box"><input type="text" id="searchFuentes" placeholder="Buscar fuentes..." onkeyup="buscarFuentes()"></div>
                <h2>Fuentes de Inteligencia Registradas</h2>
                <table id="tablaFuentes"><thead><tr><th>Fecha</th><th>Nombre</th><th>Tipo</th><th>URL</th><th>Descripción</th><th class="actions-cell">Acciones</th></tr></thead><tbody></tbody></table>
            </div></div>

            <!-- Formulario de Mitigaciones -->
            <div id="mitigaciones" class="tab-content"><div class="container">
                <div class="toggle-form-btn-container"><button class="toggle-form-btn" onclick="toggleForm('mitigacionFormContainer', 'mitigacionForm')"><i class="fa-solid fa-plus"></i>Registrar Nueva Mitigación</button></div>
                <div id="mitigacionFormContainer" class="form-container">
                    <div class="form-title-action">
                        <h2 id="mitigacionFormTitle">Registrar Mitigación/Recomendación</h2>
                        <button class="btn-danger" id="cancelMitigacionEditBtn" style="display:none;" onclick="cancelEdit('mitigacionForm', 'mitigacionFormTitle', 'Registrar Mitigación', 'guardarMitigacionBtn', 'Guardar Mitigación')"><i class="fa-solid fa-times"></i> Cancelar</button>
                    </div>
                    <form id="mitigacionForm">
                        <input type="hidden" id="mitigacionEditId">
                        <div class="form-group"><label for="tituloMitigacion">Título de la Mitigación:</label><input type="text" id="tituloMitigacion" required placeholder="Ej: Actualizaciones y Parches Críticos"></div>
                        <div class="form-row">
                            <div class="form-group"><label for="fechaMitigacion">Fecha:</label><input type="date" id="fechaMitigacion" required></div>
                            <div class="form-group"><label for="categoriaMitigacion">Categoría:</label><select id="categoriaMitigacion"><option value="Parches">Parches y Actualizaciones</option><option value="Configuracion">Configuración Segura</option><option value="Deteccion">Detección y Respuesta</option><option value="Concientizacion">Concientización</option><option value="ProteccionRansomware">Protección contra Ransomware</option><option value="ProteccionPhishing">Protección contra Phishing</option></select></div>
                        </div>
                        <div class="form-group"><label for="descripcionMitigacion">Descripción Detallada:</label><textarea id="descripcionMitigacion" required></textarea></div>
                        <div class="form-group"><label for="prioridadMitigacion">Prioridad:</label><select id="prioridadMitigacion"><option value="Alta">Alta</option><option value="Media">Media</option><option value="Baja">Baja</option></select></div>
                        <div class="form-group"><label for="urlMitigacion">URL de Referencia (Opcional):</label><input type="url" id="urlMitigacion"></div>
                        <button type="submit" id="guardarMitigacionBtn"><i class="fa-solid fa-save"></i> Guardar Mitigación</button>
                    </form>
                </div>
                <div class="search-box"><input type="text" id="searchMitigaciones" placeholder="Buscar mitigaciones..." onkeyup="buscarMitigaciones()"></div>
                <h2>Mitigaciones Registradas</h2>
                <table id="tablaMitigaciones"><thead><tr><th>Título</th><th>Categoría</th><th>Prioridad</th><th>Descripción</th><th class="actions-cell">Acciones</th></tr></thead><tbody></tbody></table>
            </div></div>
            
            <!-- Exportar -->
            <div id="reporte" class="tab-content"><div class="container">
                <h2>Exportar Datos</h2>
                
                <h3 style="margin-top: 20px;">Seleccionar Período para Reporte</h3>
                <div class="form-row" style="margin-bottom: 20px;">
                    <div class="form-group">
                        <label for="reportStartDate">Fecha de Inicio:</label>
                        <input type="date" id="reportStartDate">
                    </div>
                    <div class="form-group">
                        <label for="reportEndDate">Fecha de Fin:</label>
                        <input type="date" id="reportEndDate">
                    </div>
                </div>

                <div class="action-buttons">
                    <button onclick="handlePdfExportClick()"><i class="fa-solid fa-file-pdf"></i>Exportar a PDF (Brief)</button>
                    <button onclick="exportarExcel()"><i class="fa-solid fa-file-excel"></i>Exportar a Excel</button>
                    <button onclick="document.getElementById('excelImporter').click()"><i class="fa-solid fa-file-import"></i>Importar desde Excel</button>
                    <input type="file" id="excelImporter" style="display:none" onchange="handleExcelImport(event)" accept=".xlsx, .xls">
                    <button onclick="generarReporteCompletoHTML()"><i class="fa-solid fa-eye"></i>Previsualizar Reporte</button>
                </div>
                <div id="previewReporte" style="margin-top: 20px; padding: 15px; border: 1px solid #ddd; background: #f9f9f9; max-height: 600px; overflow-y: auto;">Presione "Previsualizar Reporte HTML" para ver.</div>
            </div></div>
        </div> <!-- End Main Content Area -->

        <footer>Report builder app © <span id="currentYear"></span> | Datos obtenidos desde API.</footer>
    </div> 
<script>
    // =============================================================================
    // CONFIGURACIÓN INICIAL Y VARIABLES GLOBALES
    // =============================================================================
    const API_BASE_URL = 'http://localhost:3000/api';
    let ALL_DATA_CACHE = {}; // Caché para todos los datos, para no llamar a la API constantemente.
    let chartInstances = {}; 
    const ROOT_CSS_VARIABLES = {};
    document.getElementById('currentYear').textContent = new Date().getFullYear();

    // =============================================================================
    // LÓGICA DE CONEXIÓN CON API Y GESTIÓN DE DATOS (CRUD)
    // =============================================================================

    async function guardarDato(tipo, dato) {
        const id = dato._id; 
        if (id) {
            delete dato._id;
        }

        const url = id ? `${API_BASE_URL}/${tipo}/${id}` : `${API_BASE_URL}/${tipo}`;
        const method = id ? 'PUT' : 'POST';

        try {
            const response = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(dato)
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || `Error ${response.status}`);
            }
            
            await fetchAndCacheAllData();
            const uiType = tipo === 'zero-days' ? 'zeroDays' : tipo;
            await mostrarDatos(uiType);

            if (document.getElementById('dashboard').classList.contains('active')) {
                await renderDashboard();
            }

        } catch (error) {
            console.error(`Error al guardar en '${tipo}':`, error);
            alert(`No se pudo guardar el registro: ${error.message}`);
            throw error;
        }
    }

    async function eliminarRegistro(tipo, id) {
        if (!confirm('¿Estás seguro de que quieres eliminar este registro?')) return;

        try {
            const response = await fetch(`${API_BASE_URL}/${tipo}/${id}`, {
                method: 'DELETE'
            });

            if (!response.ok && response.status !== 204) {
                const errorData = await response.json();
                throw new Error(errorData.message || `Error ${response.status}`);
            }
            
            await fetchAndCacheAllData();
            const uiType = tipo === 'zero-days' ? 'zeroDays' : tipo;
            await mostrarDatos(uiType);

            if (document.getElementById('dashboard').classList.contains('active')) {
               await renderDashboard();
            }
            console.log(`Registro ${id} de ${tipo} eliminado con éxito.`);

        } catch (error) {
            console.error(`Error al eliminar en ${tipo}:`, error);
            alert(`No se pudo eliminar el registro: ${error.message}`);
        }
    }

   async function mostrarDatos(tipo) {
    const endpoint = tipo === 'zeroDays' ? 'zero-days' : tipo;
    const tablaId = tipo === 'cves' ? 'tablaCVEs' : `tabla${capitalFirstLetter(tipo)}`;
    
    const tbody = document.querySelector(`#${tablaId} tbody`);
    if (!tbody) {
        console.error(`Error: No se encontró el cuerpo de la tabla con id: #${tablaId}`);
        return;
    }
    
    const datos = ALL_DATA_CACHE[endpoint] || [];
    tbody.innerHTML = '';

    const formatDisplayDate = (isoDate) => isoDate ? new Date(isoDate).toLocaleDateString('es-ES', { timeZone: 'UTC' }) : 'N/A';

    datos.forEach((dato) => {
        const row = document.createElement('tr');
        let cells = '';
        
        const itemIdentifier = dato._id;
        const refLink = dato.url ? ` <a href="${dato.url}" target="_blank" rel="noopener noreferrer" title="${dato.url}"><i class="fa-solid fa-link fa-xs"></i></a>` : '';

        switch (tipo) {
            case 'incidentes':
                cells = `<td>${formatDisplayDate(dato.fecha)}</td><td>${dato.entidad || ''}${refLink}</td><td><span class="badge badge-country">${dato.pais || 'N/A'}</span></td><td><span class="badge badge-sector">${dato.sector || 'N/A'}</span></td><td>${dato.tipo || ''}</td><td>${dato.actor || 'Desconocido'}</td>`;
                break;
            case 'exploits':
                cells = `<td>${formatDisplayDate(dato.fecha)}</td><td>${dato.nombre || ''}${refLink}</td><td>${dato.tipo || ''}</td><td>${dato.plataforma || ''}</td><td>${dato.cve || 'N/A'}</td>`;
                break;
            case 'zeroDays':
                cells = `<td>${dato.idZD || 'N/A'}</td><td>${dato.nombre || ''}${refLink}</td><td>${dato.plataforma || ''}</td><td>${formatDisplayDate(dato.fecha)}</td><td><span class="badge ${getSeverityClass(dato.cvss)}">${getSeverityText(dato.cvss)} (${dato.cvss || 'N/A'})</span></td><td><span class="badge ${getBadgeClassForZeroDayEstado(dato.estado)}">${dato.estado || ''}</span></td>`;
                break;
            case 'cves':
                cells = `<td>${dato.cveId || ''}${refLink}</td><td>${dato.aplicativo || ''}</td><td>${formatDisplayDate(dato.fecha)}</td><td><span class="badge ${getSeverityClass(dato.cvss)}">${getSeverityText(dato.cvss)} (${dato.cvss || 'N/A'})</span></td><td>${dato.estado || ''}</td>`;
                break;
            case 'alertas':
                cells = `<td>${formatDisplayDate(dato.fecha)}</td><td>${dato.titulo || ''}${refLink}</td><td><span class="badge ${getSeverityClass(dato.criticidad, true)}">${dato.criticidad || ''}</span></td><td>${(dato.descripcion || '').substring(0,50)}...</td>`;
                break;
            case 'fuentes':
                cells = `<td>${formatDisplayDate(dato.fecha)}</td><td>${dato.nombre || ''}</td><td>${dato.tipo || ''}</td><td>${dato.url ? `<a href="${dato.url}" target="_blank" rel="noopener noreferrer" title="${dato.url}">Link <i class="fa-solid fa-arrow-up-right-from-square fa-xs"></i></a>` : 'N/A'}</td><td>${(dato.descripcion || '').substring(0,50)}...</td>`;
                break;
            case 'mitigaciones':
                cells = `<td>${dato.titulo || ''}${refLink}</td><td>${dato.categoria || ''}</td><td><span class="badge ${getSeverityClass(dato.prioridad, true)}">${dato.prioridad || ''}</span></td><td>${(dato.descripcion || '').substring(0,50)}...</td>`;
                break;
        }
        
        const editButtonHTML = `<button class="btn btn-edit" data-id="${itemIdentifier}" data-type="${tipo}" onclick="handleEditClick(this)"><i class="fa-solid fa-pencil"></i></button>`;
        const deleteButtonHTML = `<button class="btn btn-danger" onclick="eliminarRegistro('${endpoint}', '${itemIdentifier}')"><i class="fa-solid fa-trash"></i></button>`;

        row.innerHTML = `${cells}<td class="actions-cell">${editButtonHTML}${deleteButtonHTML}</td>`;
        tbody.appendChild(row);
    });
}
    // =============================================================================
    // MANEJADORES DE EVENTOS PARA BOTONES DE ACCIÓN
    // =============================================================================

    function handleEditClick(button) {
        const id = button.dataset.id;
        const type = button.dataset.type;
        const endpoint = type === 'zeroDays' ? 'zero-days' : type;
        
        const item = ALL_DATA_CACHE[endpoint]?.find(d => d._id === id);

        if (!item) {
            console.error(`Item with ID ${id} not found for type ${type}`);
            alert("No se pudo encontrar el registro para editar.");
            return;
        }

        const editFunctions = {
            incidentes: populateIncidenteFormForEdit,
            exploits: populateExploitFormForEdit,
            zeroDays: populateZeroDayFormForEdit,
            cves: populateCveFormForEdit,
            alertas: populateAlertaFormForEdit,
            fuentes: populateFuenteFormForEdit,
            mitigaciones: populateMitigacionFormForEdit
        };

        if (editFunctions[type]) {
            editFunctions[type](item);
        }
    }
    
    // =============================================================================
    // LÓGICA GENERAL DE LA APLICACIÓN (UI, NAVEGACIÓN, INICIALIZACIÓN)
    // =============================================================================
    
    function parseCssVariables() {
        const styleSheets = Array.from(document.styleSheets).filter(sheet => { try { return sheet.cssRules; } catch (e) { return false; } });
        for (const sheet of styleSheets) { for (const rule of Array.from(sheet.cssRules)) { if (rule.style && rule.selectorText === ':root') { for (let i = 0; i < rule.style.length; i++) { const name = rule.style[i]; if (name.startsWith('--')) { const value = rule.style.getPropertyValue(name).trim(); if (value.startsWith('#')) {  const hex = value.substring(1); const bigint = parseInt(hex, 16); ROOT_CSS_VARIABLES[name] = { r: (bigint >> 16) & 255, g: (bigint >> 8) & 255, b: bigint & 255, hex: value }; } else { ROOT_CSS_VARIABLES[name] = value; } } } return; } } }
    }
    
    function toggleNavMenu() { document.getElementById('navMenuContainer').classList.toggle('open'); }
    
    function toggleForm(containerId, formIdToReset) {
        const container = document.getElementById(containerId);
        const isVisible = container.style.display === 'block';
        container.style.display = isVisible ? 'none' : 'block';
        if (isVisible) {
             const formPrefix = formIdToReset.replace('Form', '');
             const capitalPrefix = capitalFirstLetter(formPrefix.replace('-',''));
             const cancelBtnId = `cancel${capitalPrefix}EditBtn`;
             if(document.getElementById(cancelBtnId) && document.getElementById(cancelBtnId).style.display !== 'none'){
                 document.getElementById(cancelBtnId).click();
             }
        } else { container.scrollIntoView({ behavior: 'smooth', block: 'center' }); }
    }

    async function openTab(tabName) {
        document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
        document.getElementById(tabName).classList.add('active');
        
        document.querySelectorAll('#appNavigation .nav-link').forEach(link => link.classList.remove('active'));
        const navLink = document.querySelector(`#appNavigation .nav-link[data-tab-name="${tabName}"]`);
        if (navLink) navLink.classList.add('active');

        document.getElementById('navMenuContainer').classList.remove('open');
        
        const tabTypeMap = { 'incidentes': 'incidentes', 'exploits': 'exploits', 'zero-days': 'zeroDays', 'cves': 'cves', 'alertas': 'alertas', 'fuentes': 'fuentes', 'mitigaciones': 'mitigaciones' };
        const dataType = tabTypeMap[tabName];
        
        if (tabName === 'dashboard') { await renderDashboard(); } 
        else if (dataType) { await mostrarDatos(dataType); }
    }

    function navigateToTab(tabName) { openTab(tabName); window.scrollTo({ top: 0, behavior: 'smooth' }); }

    async function fetchAndCacheAllData() {
        try {
            const dataKeys = ['incidentes', 'exploits', 'zero-days', 'cves', 'alertas', 'fuentes', 'mitigaciones'];
            const promises = dataKeys.map(key => fetch(`${API_BASE_URL}/${key}`).then(res => { if (!res.ok) throw new Error(`Failed to fetch ${key}`); return res.json(); }));
            const results = await Promise.all(promises);
            dataKeys.forEach((key, index) => { ALL_DATA_CACHE[key] = results[index]; });
            console.log("Data cache updated from server.");
        } catch (error) {
            console.error("Error caching data:", error);
            alert("Hubo un problema al cargar los datos iniciales desde el servidor. Verifique que el servidor backend (`server.js`) esté en ejecución y que la base de datos MongoDB esté accesible.");
        }
    }

    document.addEventListener('DOMContentLoaded', async function() {
        parseCssVariables();
        await fetchAndCacheAllData();

        document.querySelectorAll('#appNavigation .nav-link').forEach(link => { link.addEventListener('click', function(e) { e.preventDefault(); openTab(this.dataset.tabName); }); });
        window.onclick = function(event) { if (!event.target.matches('.menu-toggle-btn') && !event.target.closest('.dropdown-menu')) { document.getElementById('navMenuContainer').classList.remove('open'); } }

        document.getElementById('applyDashboardFilterBtn').addEventListener('click', () => renderDashboard());
        document.getElementById('resetDashboardFilterBtn').addEventListener('click', () => {
            document.getElementById('dashboardStartDate').value = '';
            document.getElementById('dashboardEndDate').value = '';
            renderDashboard();
        });

        await openTab('dashboard'); 
    });

    function capitalFirstLetter(string) { return string ? string.charAt(0).toUpperCase() + string.slice(1) : ''; }
    
    function cancelEdit(formId, formTitleId, originalTitle, submitBtnId, originalSubmitText) {
        document.getElementById(formId).reset();
        const formPrefix = formId.replace('Form', ''); 
        const idField = document.getElementById(`${formPrefix}EditId`);
        if (idField) idField.value = '';
        
        if (formId === 'cveForm') { document.getElementById('idCVE').readOnly = false; }

        document.getElementById(formTitleId).textContent = originalTitle;
        const saveButton = document.getElementById(submitBtnId);
        if (saveButton) {
            saveButton.innerHTML = `<i class="fa-solid fa-save"></i> ${originalSubmitText}`;
        }
        
        const capitalPrefix = capitalFirstLetter(formPrefix.replace('-',''));
        const cancelButton = document.getElementById(`cancel${capitalPrefix}EditBtn`);
        if (cancelButton) cancelButton.style.display = 'none';

        const formContainer = document.getElementById(`${formPrefix.replace('-','')}FormContainer`);
        if (formContainer) formContainer.style.display = 'none';
    }

    // --- FORM SUBMISSIONS ---
    document.getElementById('incidenteForm').addEventListener('submit', function(e) { 
        e.preventDefault(); 
        const item = { _id: document.getElementById('incidenteEditId').value || null, fecha: document.getElementById('fechaIncidente').value, tipo: document.getElementById('tipoIncidente').value, entidad: document.getElementById('entidadIncidente').value, pais: document.getElementById('paisIncidente').value, sector: document.getElementById('sectorIncidente').value, descripcion: document.getElementById('descripcionIncidente').value, datosComprometidos: document.getElementById('datosComprometidosIncidente').value, actor: document.getElementById('actorIncidente').value, url: document.getElementById('urlIncidente').value }; 
        guardarDato('incidentes', item)
            .then(() => cancelEdit('incidenteForm', 'incidenteFormTitle', 'Registrar Incidente', 'guardarIncidenteBtn', 'Guardar Incidente'))
            .catch(err => console.error("El guardado falló, el formulario no se resetea.", err));
    });
    
    document.getElementById('exploitForm').addEventListener('submit', function(e) { 
        e.preventDefault(); 
        const item = { _id: document.getElementById('exploitEditId').value || null, fecha: document.getElementById('fechaExploit').value, nombre: document.getElementById('nombreExploit').value, tipo: document.getElementById('tipoExploit').value, plataforma: document.getElementById('plataformaExploit').value, cve: document.getElementById('cveExploit').value.toUpperCase().trim(), url: document.getElementById('urlExploit').value }; 
        guardarDato('exploits', item)
            .then(() => cancelEdit('exploitForm', 'exploitFormTitle', 'Registrar Exploit', 'guardarExploitBtn', 'Guardar Exploit'))
            .catch(err => console.error("El guardado falló, el formulario no se resetea.", err));
    });
    
    document.getElementById('zeroDayForm').addEventListener('submit', function(e) { 
        e.preventDefault(); 
        const item = { _id: document.getElementById('zeroDayEditId').value || null, idZD: document.getElementById('idZD').value.trim(), fecha: document.getElementById('fechaZD').value, nombre: document.getElementById('nombreZD').value, plataforma: document.getElementById('plataformaZD').value, cvss: parseFloat(document.getElementById('cvssZD').value) || 0, estado: document.getElementById('estadoZD').value, url: document.getElementById('urlZD').value, descripcion: document.getElementById('descripcionZD').value }; 
        guardarDato('zero-days', item)
            .then(() => cancelEdit('zeroDayForm', 'zeroDayFormTitle', 'Registrar Zero Day', 'guardarZeroDayBtn', 'Guardar Zero Day'))
            .catch(err => console.error("El guardado falló, el formulario no se resetea.", err));
    });
    
    document.getElementById('cveForm').addEventListener('submit', function(e) { 
        e.preventDefault(); 
        const item = { _id: document.getElementById('cveEditId').value || null, cveId: document.getElementById('idCVE').value.toUpperCase().trim(), fecha: document.getElementById('fechaCVE').value, aplicativo: document.getElementById('aplicativoCVE').value, cvss: parseFloat(document.getElementById('cvssCVE').value) || 0, estado: document.getElementById('estadoCVE').value, descripcion: document.getElementById('descripcionCVE').value, url: document.getElementById('urlCVE').value }; 
        guardarDato('cves', item)
            .then(() => cancelEdit('cveForm', 'cveFormTitle', 'Registrar CVE', 'guardarCveBtn', 'Guardar CVE'))
            .catch(err => console.error("El guardado falló, el formulario no se resetea.", err));
    });
    
    document.getElementById('alertaForm').addEventListener('submit', function(e) { 
        e.preventDefault(); 
        const item = { _id: document.getElementById('alertaEditId').value || null, titulo: document.getElementById('tituloAlerta').value, descripcion: document.getElementById('descripcionAlerta').value, criticidad: document.getElementById('criticidadAlerta').value, fecha: document.getElementById('fechaAlerta').value, url: document.getElementById('urlAlerta').value }; 
        guardarDato('alertas', item)
            .then(() => cancelEdit('alertaForm', 'alertaFormTitle', 'Registrar Alerta', 'guardarAlertaBtn', 'Guardar Alerta'))
            .catch(err => console.error("El guardado falló, el formulario no se resetea.", err));
    });
    
    document.getElementById('fuenteForm').addEventListener('submit', function(e) { 
        e.preventDefault(); 
        const item = { _id: document.getElementById('fuenteEditId').value || null, fecha: document.getElementById('fechaFuente').value, nombre: document.getElementById('nombreFuente').value, tipo: document.getElementById('tipoFuente').value, url: document.getElementById('urlFuente').value, descripcion: document.getElementById('descripcionFuente').value }; 
        guardarDato('fuentes', item)
            .then(() => cancelEdit('fuenteForm', 'fuenteFormTitle', 'Registrar Fuente', 'guardarFuenteBtn', 'Guardar Fuente'))
            .catch(err => console.error("El guardado falló, el formulario no se resetea.", err));
    });
    
    document.getElementById('mitigacionForm').addEventListener('submit', function(e) { 
        e.preventDefault(); 
        const item = { _id: document.getElementById('mitigacionEditId').value || null, fecha: document.getElementById('fechaMitigacion').value, titulo: document.getElementById('tituloMitigacion').value, categoria: document.getElementById('categoriaMitigacion').value, prioridad: document.getElementById('prioridadMitigacion').value, descripcion: document.getElementById('descripcionMitigacion').value, url: document.getElementById('urlMitigacion').value }; 
        guardarDato('mitigaciones', item)
            .then(() => cancelEdit('mitigacionForm', 'mitigacionFormTitle', 'Registrar Mitigación', 'guardarMitigacionBtn', 'Guardar Mitigación'))
            .catch(err => console.error("El guardado falló, el formulario no se resetea.", err));
    });

    // --- POPULATE FORMS FOR EDIT ---
    const formatInputDate = (isoDate) => isoDate ? new Date(isoDate).toISOString().split('T')[0] : '';
    
    function populateFormAndShow(formPrefix, capitalPrefix) {
        const formContainer = document.getElementById(`${formPrefix.replace('-','')}FormContainer`);
        if (formContainer) {
            formContainer.style.display = 'block';
            formContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
        document.getElementById(`${formPrefix.replace('-','')}FormTitle`).textContent = `Editar ${capitalPrefix === 'ZeroDay' ? 'Zero Day' : capitalPrefix}`;
        document.getElementById(`guardar${capitalPrefix}Btn`).innerHTML = `<i class="fa-solid fa-save"></i> Actualizar`;
        document.getElementById(`cancel${capitalPrefix}EditBtn`).style.display = 'inline-flex';
    }

    function populateIncidenteFormForEdit(item) { if (item) { document.getElementById('incidenteEditId').value = item._id; document.getElementById('fechaIncidente').value = formatInputDate(item.fecha); document.getElementById('tipoIncidente').value = item.tipo; document.getElementById('entidadIncidente').value = item.entidad; document.getElementById('paisIncidente').value = item.pais; document.getElementById('sectorIncidente').value = item.sector; document.getElementById('descripcionIncidente').value = item.descripcion; document.getElementById('datosComprometidosIncidente').value = item.datosComprometidos; document.getElementById('actorIncidente').value = item.actor; document.getElementById('urlIncidente').value = item.url || ''; populateFormAndShow('incidente', 'Incidente'); } }
    function populateExploitFormForEdit(item) { if (item) { document.getElementById('exploitEditId').value = item._id; document.getElementById('fechaExploit').value = formatInputDate(item.fecha); document.getElementById('nombreExploit').value = item.nombre; document.getElementById('tipoExploit').value = item.tipo; document.getElementById('plataformaExploit').value = item.plataforma; document.getElementById('cveExploit').value = item.cve; document.getElementById('urlExploit').value = item.url || ''; populateFormAndShow('exploit', 'Exploit'); } }
    function populateZeroDayFormForEdit(item) { if (item) { document.getElementById('zeroDayEditId').value = item._id; document.getElementById('idZD').value = item.idZD; document.getElementById('fechaZD').value = formatInputDate(item.fecha); document.getElementById('nombreZD').value = item.nombre; document.getElementById('plataformaZD').value = item.plataforma; document.getElementById('cvssZD').value = item.cvss; document.getElementById('estadoZD').value = item.estado; document.getElementById('urlZD').value = item.url || ''; document.getElementById('descripcionZD').value = item.descripcion; populateFormAndShow('zeroDay', 'ZeroDay'); } }
    function populateCveFormForEdit(item) { if (item) { document.getElementById('cveEditId').value = item._id; document.getElementById('idCVE').value = item.cveId; document.getElementById('idCVE').readOnly = true; document.getElementById('fechaCVE').value = formatInputDate(item.fecha); document.getElementById('aplicativoCVE').value = item.aplicativo; document.getElementById('cvssCVE').value = item.cvss; document.getElementById('estadoCVE').value = item.estado; document.getElementById('descripcionCVE').value = item.descripcion; document.getElementById('urlCVE').value = item.url || ''; populateFormAndShow('cve', 'Cve'); } }
    function populateAlertaFormForEdit(item) { if (item) { document.getElementById('alertaEditId').value = item._id; document.getElementById('tituloAlerta').value = item.titulo; document.getElementById('fechaAlerta').value = formatInputDate(item.fecha); document.getElementById('descripcionAlerta').value = item.descripcion; document.getElementById('criticidadAlerta').value = item.criticidad; document.getElementById('urlAlerta').value = item.url || ''; populateFormAndShow('alerta', 'Alerta'); } }
    function populateFuenteFormForEdit(item) { if (item) { document.getElementById('fuenteEditId').value = item._id; document.getElementById('fechaFuente').value = formatInputDate(item.fecha); document.getElementById('nombreFuente').value = item.nombre; document.getElementById('tipoFuente').value = item.tipo; document.getElementById('urlFuente').value = item.url || ''; document.getElementById('descripcionFuente').value = item.descripcion; populateFormAndShow('fuente', 'Fuente'); } }
    function populateMitigacionFormForEdit(item) { if (item) { document.getElementById('mitigacionEditId').value = item._id; document.getElementById('fechaMitigacion').value = formatInputDate(item.fecha); document.getElementById('tituloMitigacion').value = item.titulo; document.getElementById('categoriaMitigacion').value = item.categoria; document.getElementById('descripcionMitigacion').value = item.descripcion; document.getElementById('prioridadMitigacion').value = item.prioridad; document.getElementById('urlMitigacion').value = item.url || ''; populateFormAndShow('mitigacion', 'Mitigacion'); } }
    
    // --- UTILITY & SEARCH FUNCTIONS ---
    function getBadgeClassForZeroDayEstado(estado) { switch (String(estado)?.toLowerCase()) { case 'activo': return 'badge-estado-activo'; case 'mitigado': return 'badge-estado-mitigado'; case 'en investigación': case 'investigacion': return 'badge-estado-investigacion'; case 'prueba de concepto': case 'pruebadeconcepto': return 'badge-estado-poc'; default: return 'badge-info'; } }
    function searchTable(inputId, tableId, searchColumns) { const input = document.getElementById(inputId); const filter = input.value.toUpperCase(); const table = document.getElementById(tableId); const tr = table.getElementsByTagName("tr"); for (let i = 1; i < tr.length; i++) { let found = false; for (const colIndex of searchColumns) { const td = tr[i].getElementsByTagName("td")[colIndex]; if (td) { const txtValue = td.textContent || td.innerText; if (txtValue.toUpperCase().indexOf(filter) > -1) { found = true; break; } } } tr[i].style.display = found ? "" : "none"; } }
    function buscarIncidentes() { searchTable('searchIncidentes', 'tablaIncidentes', [0, 1, 2, 3, 4, 5]); }
    function buscarExploits() { searchTable('searchExploits', 'tablaExploits', [0, 1, 2, 3, 4]); }
    function buscarZeroDays() { searchTable('searchZeroDays', 'tablaZeroDays', [0, 1, 2, 3, 5]); }
    function buscarCVEs() { searchTable('searchCVEs', 'tablaCVEs', [0, 1, 2, 4]); }
    function buscarAlertas() { searchTable('searchAlertas', 'tablaAlertas', [0, 1, 3]); } 
    function buscarFuentes() { searchTable('searchFuentes', 'tablaFuentes', [0, 1, 2, 4]); }
    function buscarMitigaciones() { searchTable('searchMitigaciones', 'tablaMitigaciones', [0, 1, 3]); }

    // =============================================================================
    // DASHBOARD & CHARTING FUNCTIONS
    // =============================================================================

    async function renderDashboard() { 
        const startDateStr = document.getElementById('dashboardStartDate').value;
        const endDateStr = document.getElementById('dashboardEndDate').value;
        
        const dashboardDateEl = document.getElementById('dashboardDate');
        if (startDateStr && endDateStr) {
            dashboardDateEl.textContent = `Mostrando datos desde ${startDateStr} hasta ${endDateStr}.`;
        } else {
            dashboardDateEl.textContent = `Mostrando todos los datos registrados.`;
        }
        
        await fetchAndCacheAllData();

        const filterByDate = (item) => {
            if (!startDateStr || !endDateStr) return true;
            if (!item.fecha) return false;
            const itemDate = new Date(item.fecha); 
            const startDate = new Date(startDateStr);
            const endDate = new Date(endDateStr);
            endDate.setHours(23, 59, 59, 999);
            return itemDate >= startDate && itemDate <= endDate;
        };
        
        const incidentes = (ALL_DATA_CACHE.incidentes || []).filter(filterByDate);
        const exploits = (ALL_DATA_CACHE.exploits || []).filter(filterByDate);
        const zeroDays = (ALL_DATA_CACHE['zero-days'] || []).filter(filterByDate);
        const cves = (ALL_DATA_CACHE.cves || []).filter(filterByDate);
        const alertas = (ALL_DATA_CACHE.alertas || []).filter(filterByDate);
        const fuentes = (ALL_DATA_CACHE.fuentes || []); // Total count is not filtered
        const mitigaciones = (ALL_DATA_CACHE.mitigaciones || []); // Total count is not filtered

        document.getElementById('statIncidents').textContent = (ALL_DATA_CACHE.incidentes || []).length;
        document.getElementById('statExploits').textContent = (ALL_DATA_CACHE.exploits || []).length;
        document.getElementById('statZeroDays').textContent = (ALL_DATA_CACHE['zero-days'] || []).length;
        document.getElementById('statCVEs').textContent = (ALL_DATA_CACHE.cves || []).length;
        document.getElementById('statAlerts').textContent = (ALL_DATA_CACHE.alertas || []).length;
        document.getElementById('statFuentes').textContent = fuentes.length;
        document.getElementById('statMitigaciones').textContent = mitigaciones.length;
        
        renderTimelineChart(incidentes, exploits, zeroDays, cves, startDateStr, endDateStr);
        renderDashboardAllAlerts(alertas);
        renderAlertsBySeverityChart(alertas);
        renderIncidentsTypeChart(incidentes);
        renderIncidentsSectorChart(incidentes);
        renderTopAffectedEntitiesChart(incidentes);
        renderSeverityChart(cves);
        renderCVEsByStatusChart(cves);
        renderZeroDaysByStatusChart(zeroDays);
        renderExploitsByTypeChart(exploits);
        renderTopPlatformsChart(exploits, 'topPlatformsExploitsChart', 'Exploits');
        renderFuentesByTypeChart(fuentes.filter(filterByDate)); // Chart is filtered
        renderMitigacionesByCatChart(mitigaciones.filter(filterByDate)); // Chart is filtered
        renderMitigacionesByPrioChart(mitigaciones.filter(filterByDate)); // Chart is filtered
        renderDashboardCVETable(cves);
        renderDashboardIncidentsTable(incidentes);
        renderDashboardZeroDaysTable(zeroDays);
        renderDashboardExploitsTable(exploits);
    }

    function createOrUpdateChart(chartId, chartConfig) {
        const ctx = document.getElementById(chartId)?.getContext('2d');
        if(!ctx) { console.warn(`Canvas with ID ${chartId} not found.`); return; }
        if (chartInstances[chartId]) {
            chartInstances[chartId].destroy(); 
        }
        chartInstances[chartId] = new Chart(ctx, chartConfig);
    }
    
    function getSeverityText(cvss) {
        const score = parseFloat(cvss);
        if (isNaN(score)) return 'N/A';
        if (score >= 9.0) return 'Crítica'; 
        if (score >= 7.0) return 'Alta';
        if (score >= 4.0) return 'Media'; 
        if (score > 0) return 'Baja'; 
        return 'Info';
    }

    function getSeverityClass(level, isAlertOrPriority = false) {
        if (isAlertOrPriority) {
            switch(String(level)?.toLowerCase()) {
                case 'critica': case 'crítica': return 'badge-critical';
                case 'alta': return 'badge-high';
                case 'media': return 'badge-medium';
                case 'baja': return 'badge-low';
                default: return 'badge-info'; 
            }
        } else {
            const score = parseFloat(level);
            if (score >= 9.0) return 'badge-critical';
            if (score >= 7.0) return 'badge-high';
            if (score >= 4.0) return 'badge-medium';
            if (score > 0) return 'badge-low';
            return 'badge-info';
        }
    }

    function getAlertItemClass(criticidad) {
        switch(String(criticidad)?.toLowerCase()) {
            case 'critica': case 'crítica': return 'critical-alert';
            case 'alta': return 'high-alert';
            case 'media': return 'medium-alert';
            case 'baja': return 'low-alert';
            default: return 'info-alert'; 
        }
    }
    
    function getAlertIcon(criticidad) {
        switch(String(criticidad)?.toLowerCase()) {
            case 'critica': case 'crítica': return '🚨';
            case 'alta': return '⚠️';
            case 'media': return '🟠'; 
            case 'baja': return '🟢';
            default: return 'ℹ️'; 
        }
    }
    
    function renderDashboardAllAlerts(alertas) {
        const container = document.getElementById('dashboardAllAlertsContainer');
        container.innerHTML = ''; 
        if (alertas.length === 0) {
            container.innerHTML = '<p>No hay alertas para el período seleccionado.</p>';
            return;
        }
        const sortedAlerts = [...alertas].sort((a,b) => new Date(b.fecha) - new Date(a.fecha));

        sortedAlerts.slice(0, 10).forEach(alerta => {
            const itemDiv = document.createElement('div');
            itemDiv.className = `alert-dashboard-item ${getAlertItemClass(alerta.criticidad)}`;
            itemDiv.innerHTML = `<div class="alert-icon">${getAlertIcon(alerta.criticidad)}</div><div class="alert-content"><h3>${alerta.titulo}</h3><p>${(alerta.descripcion || '').substring(0, 120)}...</p><span class="alert-date">Fecha: ${new Date(alerta.fecha).toLocaleDateString('es-ES',{timeZone:'UTC'})} | Criticidad: ${alerta.criticidad}</span></div>`;
            container.appendChild(itemDiv);
        });
    }

    function renderDashboardCVETable(cves) {
        const tbody = document.querySelector('#dashboardCVEsTable tbody'); tbody.innerHTML = '';
        const recentCVEs = cves.sort((a,b) => new Date(b.fecha) - new Date(a.fecha)).slice(0, 5);
        if (recentCVEs.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5">No hay CVEs para el período seleccionado.</td></tr>';
            return;
        }
        recentCVEs.forEach(cve => { const row = tbody.insertRow(); row.innerHTML = `<td>${cve.cveId}</td><td>${cve.aplicativo}</td><td><span class="badge ${getSeverityClass(cve.cvss)}">${getSeverityText(cve.cvss)}</span></td><td>${cve.estado}</td><td class="${getSeverityClass(cve.cvss)}">${cve.cvss}</td>`; });
    }

    function renderDashboardIncidentsTable(incidentes) {
        const tbody = document.querySelector('#dashboardIncidentsTable tbody'); tbody.innerHTML = '';
        const recentItems = incidentes.sort((a,b) => new Date(b.fecha) - new Date(a.fecha)).slice(0, 5);
        if (recentItems.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6">No hay incidentes para el período seleccionado.</td></tr>';
            return;
        }
        recentItems.forEach(item => { const row = tbody.insertRow(); row.innerHTML = `<td>${new Date(item.fecha).toLocaleDateString('es-ES',{timeZone:'UTC'})}</td><td>${item.entidad}</td><td><span class="badge badge-country">${item.pais || 'N/A'}</span></td><td><span class="badge badge-sector">${item.sector || 'N/A'}</span></td><td>${item.tipo}</td><td>${(item.descripcion || '').substring(0,30)}...</td>`; });
    }

    function renderDashboardZeroDaysTable(zeroDays) {
        const tbody = document.querySelector('#dashboardZeroDaysTable tbody'); tbody.innerHTML = '';
        const recentItems = zeroDays.sort((a,b) => new Date(b.fecha) - new Date(a.fecha)).slice(0, 5);
        if (recentItems.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6">No hay Zero Days para el período seleccionado.</td></tr>';
            return;
        }
        recentItems.forEach(item => { const row = tbody.insertRow(); row.innerHTML = `<td>${item.idZD || 'N/A'}</td><td>${item.nombre}</td><td>${item.plataforma}</td><td>${new Date(item.fecha).toLocaleDateString('es-ES',{timeZone:'UTC'})}</td><td><span class="badge ${getBadgeClassForZeroDayEstado(item.estado)}">${item.estado}</span></td><td class="${getSeverityClass(item.cvss)}">${item.cvss}</td>`; });
    }

    function renderDashboardExploitsTable(exploits) {
        const tbody = document.querySelector('#dashboardExploitsTable tbody'); tbody.innerHTML = '';
        const recentItems = exploits.sort((a,b) => new Date(b.fecha) - new Date(a.fecha)).slice(0, 5);
        if (recentItems.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4">No hay exploits para el período seleccionado.</td></tr>';
            return;
        }
        recentItems.forEach(item => { const row = tbody.insertRow(); row.innerHTML = `<td>${new Date(item.fecha).toLocaleDateString('es-ES',{timeZone:'UTC'})}</td><td>${item.nombre}</td><td>${item.tipo}</td><td>${item.plataforma}</td>`; });
    }
    
    function renderIncidentsTypeChart(incidentes) { const data = incidentes.reduce((acc, curr) => { acc[curr.tipo] = (acc[curr.tipo] || 0) + 1; return acc; }, {}); createOrUpdateChart('incidentsTypeChart', { type: 'doughnut', data: { labels: Object.keys(data), datasets: [{ data: Object.values(data), backgroundColor: ['#e74c3c', '#f39c12', '#3498db', '#2ecc71', '#9b59b6', '#1abc9c'], borderWidth: 1 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } } }); }
    function renderIncidentsSectorChart(incidentes) { const data = incidentes.reduce((acc, curr) => { if(curr.sector) acc[curr.sector] = (acc[curr.sector] || 0) + 1; return acc; }, {}); createOrUpdateChart('incidentsSectorChart', { type: 'pie', data: { labels: Object.keys(data), datasets: [{ data: Object.values(data), backgroundColor: ['#34495e', '#e67e22', '#27ae60', '#2980b9', '#8e44ad'], borderWidth: 1 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' } } } }); }
    function getTopNItems(items, key, n = 5) { const counts = {}; items.forEach(item => { if(item[key]) counts[item[key]] = (counts[item[key]] || 0) + 1; }); return Object.entries(counts).sort(([, a], [, b]) => b - a).slice(0, n).reduce((obj, [k, v]) => ({ ...obj, [k]: v }), {}); }
    function renderTopAffectedEntitiesChart(incidentes) { const topEntities = getTopNItems(incidentes, 'entidad', 5); createOrUpdateChart('topAffectedEntitiesChart', { type: 'bar', data: { labels: Object.keys(topEntities), datasets: [{ label: 'Nº de Incidentes', data: Object.values(topEntities), backgroundColor: ROOT_CSS_VARIABLES['--primary']?.hex + 'AA', borderColor: ROOT_CSS_VARIABLES['--primary']?.hex, borderWidth: 1 }] }, options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', scales: { x: { beginAtZero: true, ticks: { stepSize: 1 } } }, plugins: { legend: { display: false } } } }); }
    function renderAlertsBySeverityChart(alertas) { const severities = { "Informacional": 0, "Baja": 0, "Media": 0, "Alta": 0, "Critica": 0 }; alertas.forEach(alerta => { let crit = alerta.criticidad === "Crítica" ? "Critica" : alerta.criticidad; if(severities.hasOwnProperty(crit)) severities[crit]++; }); const labels = Object.keys(severities); const data = Object.values(severities); const backgroundColors = labels.map(label => { switch(label.toLowerCase()){ case 'critica': return ROOT_CSS_VARIABLES['--danger']?.hex; case 'alta': return ROOT_CSS_VARIABLES['--warning']?.hex; case 'media': return '#f1c40f'; case 'baja': return ROOT_CSS_VARIABLES['--success']?.hex; default: return ROOT_CSS_VARIABLES['--info']?.hex;} }); createOrUpdateChart('alertsBySeverityChart', { type: 'bar', data: { labels, datasets: [{ label: 'Nº de Alertas', data, backgroundColor: backgroundColors }] }, options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } } }); }
    function renderCVEsByStatusChart(cves) { const statuses = cves.reduce((acc, curr) => { acc[curr.estado] = (acc[curr.estado] || 0) + 1; return acc; }, {}); createOrUpdateChart('cvesByStatusChart', { type: 'doughnut', data: { labels: Object.keys(statuses), datasets: [{ data: Object.values(statuses), backgroundColor: [ROOT_CSS_VARIABLES['--info']?.hex, ROOT_CSS_VARIABLES['--danger']?.hex, ROOT_CSS_VARIABLES['--warning']?.hex, ROOT_CSS_VARIABLES['--success']?.hex], borderWidth: 1 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } } }); }
    function renderZeroDaysByStatusChart(zeroDays) { const statuses = zeroDays.reduce((acc, curr) => { acc[curr.estado] = (acc[curr.estado] || 0) + 1; return acc; }, {}); const statusColors = { 'Activo': ROOT_CSS_VARIABLES['--danger']?.hex, 'Mitigado': ROOT_CSS_VARIABLES['--success']?.hex, 'En Investigación': ROOT_CSS_VARIABLES['--warning']?.hex, 'Prueba de Concepto': ROOT_CSS_VARIABLES['--info']?.hex }; createOrUpdateChart('zeroDaysByStatusChart', { type: 'pie', data: { labels: Object.keys(statuses), datasets: [{ data: Object.values(statuses), backgroundColor: Object.keys(statuses).map(status => statusColors[status] || '#bdc3c7'), borderWidth: 1 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' } } } }); }
    function renderExploitsByTypeChart(exploits) { const types = exploits.reduce((acc, curr) => { acc[curr.tipo] = (acc[curr.tipo] || 0) + 1; return acc; }, {}); createOrUpdateChart('exploitsByTypeChart', { type: 'doughnut', data: { labels: Object.keys(types), datasets: [{ data: Object.values(types), backgroundColor: ['#e67e22', '#16a085', '#2980b9', '#8e44ad', '#d35400', '#27ae60', '#c0392b'], borderWidth: 1 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } } }); }
    function renderTopPlatformsChart(items, chartId, label) { const topPlatforms = getTopNItems(items, 'plataforma', 5); createOrUpdateChart(chartId, { type: 'bar', data: { labels: Object.keys(topPlatforms), datasets: [{ label: `Nº de ${label}`, data: Object.values(topPlatforms), backgroundColor: ROOT_CSS_VARIABLES['--secondary']?.hex + 'AA', borderColor: ROOT_CSS_VARIABLES['--secondary']?.hex, borderWidth: 1 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }, plugins: { legend: { display: false } } } }); }
    function renderFuentesByTypeChart(fuentes) { const types = fuentes.reduce((acc, curr) => { acc[curr.tipo] = (acc[curr.tipo] || 0) + 1; return acc; }, {}); createOrUpdateChart('fuentesByTypeChart', { type: 'pie', data: { labels: Object.keys(types), datasets: [{ data: Object.values(types), backgroundColor: [ROOT_CSS_VARIABLES['--dark']?.hex, ROOT_CSS_VARIABLES['--info']?.hex, ROOT_CSS_VARIABLES['--primary']?.hex, '#7f8c8d'], borderWidth: 1 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' } } } }); }
    function renderMitigacionesByCatChart(mitigaciones) { const categories = mitigaciones.reduce((acc, curr) => { acc[curr.categoria] = (acc[curr.categoria] || 0) + 1; return acc; }, {}); createOrUpdateChart('mitigacionesByCatChart', { type: 'bar', data: { labels: Object.keys(categories), datasets: [{ label: 'Nº de Mitigaciones', data: Object.values(categories), backgroundColor: ROOT_CSS_VARIABLES['--success']?.hex + 'AA', borderColor: ROOT_CSS_VARIABLES['--success']?.hex, borderWidth: 1 }] }, options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', scales: { x: { beginAtZero: true, ticks: { stepSize: 1 } } }, plugins: { legend: { display: false } } } }); }
    function renderMitigacionesByPrioChart(mitigaciones) { const priorities = { 'Alta': 0, 'Media': 0, 'Baja': 0 }; mitigaciones.forEach(m => { if (priorities.hasOwnProperty(m.prioridad)) priorities[m.prioridad]++; }); const priorityColors = { 'Alta': ROOT_CSS_VARIABLES['--danger']?.hex, 'Media': ROOT_CSS_VARIABLES['--warning']?.hex, 'Baja': ROOT_CSS_VARIABLES['--success']?.hex }; createOrUpdateChart('mitigacionesByPrioChart', { type: 'doughnut', data: { labels: Object.keys(priorities), datasets: [{ data: Object.values(priorities), backgroundColor: Object.keys(priorities).map(prio => priorityColors[prio] || '#bdc3c7'), borderWidth: 1 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } } }); }
    
    function renderTimelineChart(incidentes, exploits, zeroDays, cves, startDateStr, endDateStr) {
        const dataPoints = {};
        let labels = [];

        if (startDateStr && endDateStr) {
            let currentDate = new Date(startDateStr + 'T00:00:00Z');
            const endDate = new Date(endDateStr + 'T00:00:00Z');
            while(currentDate <= endDate) {
                const dateString = currentDate.toISOString().split('T')[0];
                dataPoints[dateString] = { incidents: 0, exploits: 0, zeroDays: 0, cves: 0 };
                labels.push(new Date(currentDate));
                currentDate.setUTCDate(currentDate.getUTCDate() + 1);
            }
        } else {
            for (let i = 29; i >= 0; i--) {
                const d = new Date();
                d.setUTCHours(0, 0, 0, 0);
                d.setUTCDate(d.getUTCDate() - i);
                const dateString = d.toISOString().split('T')[0];
                dataPoints[dateString] = { incidents: 0, exploits: 0, zeroDays: 0, cves: 0 };
                labels.push(d);
            }
        }
        
        const processItems = (items, typeKey) => {
            if (!Array.isArray(items)) return;
            items.forEach(item => {
                if (item && item.fecha) {
                    const dateString = new Date(item.fecha).toISOString().split('T')[0];
                    if (dataPoints.hasOwnProperty(dateString)) {
                        dataPoints[dateString][typeKey]++;
                    }
                }
            });
        };

        processItems(incidentes, 'incidents');
        processItems(exploits, 'exploits');
        processItems(zeroDays, 'zeroDays');
        processItems(cves, 'cves');
        
        const sortedDateStrings = Object.keys(dataPoints).sort((a, b) => new Date(a) - new Date(b));

        createOrUpdateChart('timelineChart', {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Incidentes',
                    data: sortedDateStrings.map(d => dataPoints[d]?.incidents || 0),
                    borderColor: ROOT_CSS_VARIABLES['--danger']?.hex || '#e74c3c',
                    backgroundColor: (ROOT_CSS_VARIABLES['--danger']?.hex || '#e74c3c') + '1A',
                    tension: 0.3, fill: true
                }, {
                    label: 'Exploits',
                    data: sortedDateStrings.map(d => dataPoints[d]?.exploits || 0),
                    borderColor: ROOT_CSS_VARIABLES['--secondary']?.hex || '#3498db',
                    backgroundColor: (ROOT_CSS_VARIABLES['--secondary']?.hex || '#3498db') + '1A',
                    tension: 0.3, fill: true
                }, {
                    label: 'ZeroDays',
                    data: sortedDateStrings.map(d => dataPoints[d]?.zeroDays || 0),
                    borderColor: ROOT_CSS_VARIABLES['--success']?.hex || '#2ecc71',
                    backgroundColor: (ROOT_CSS_VARIABLES['--success']?.hex || '#2ecc71') + '1A',
                    tension: 0.3, fill: true
                }, {
                    label: 'CVEs',
                    data: sortedDateStrings.map(d => dataPoints[d]?.cves || 0),
                    borderColor: ROOT_CSS_VARIABLES['--warning']?.hex || '#f39c12',
                    backgroundColor: (ROOT_CSS_VARIABLES['--warning']?.hex || '#f39c12') + '1A',
                    tension: 0.3, fill: true
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            unit: labels.length > 60 ? 'month' : (labels.length > 7 ? 'week' : 'day'), 
                            tooltipFormat: 'dd/MM/yyyy',
                            displayFormats: { day: 'dd MMM', week: 'dd MMM', month: 'MMM yyyy' }
                        },
                        ticks: { source: 'auto', maxRotation: 0, autoSkip: true }
                    },
                    y: { beginAtZero: true, ticks: { stepSize: 1 } }
                },
                plugins: { legend: { position: 'top' }, tooltip: { mode: 'index', intersect: false } },
                interaction: { mode: 'index', intersect: false }
            }
        });
    }

    function renderSeverityChart(cves) {
        const recentCVEs = cves
            .filter(cve => cve.fecha)
            .sort((a,b) => new Date(b.fecha) - new Date(a.fecha))
            .slice(0, 5); 
        
        createOrUpdateChart('severityChart', { type: 'radar', data: { 
            labels: recentCVEs.map(cve => {
                const id = cve.cveId || 'N/A';
                const date = new Date(cve.fecha).toLocaleDateString('es-ES', {month: '2-digit', day: '2-digit'});
                return (id.length > 15 ? id.substring(0,12)+"..." : id) + ` (${date})`;
            }), 
            datasets: [{ 
                label: 'Puntaje CVSS', 
                data: recentCVEs.map(cve => cve.cvss), 
                backgroundColor: (ROOT_CSS_VARIABLES['--secondary']?.hex || '#3498db') + '33', 
                borderColor: ROOT_CSS_VARIABLES['--secondary']?.hex || '#3498db', 
                pointBackgroundColor: ROOT_CSS_VARIABLES['--secondary']?.hex || '#3498db' 
            }] }, 
            options: { responsive: true, maintainAspectRatio: false, scales: { r: { angleLines: { display: true }, suggestedMin: 0, suggestedMax: 10, pointLabels: { font: {size: 9}}}} } 
        });
    }
    
    // =============================================================================
    // EXPORT & REPORTING FUNCTIONS
    // =============================================================================

    function exportarExcel() {
        const workbook = XLSX.utils.book_new();
        const dataKeys = {
            'incidentes': 'Incidentes', 
            'exploits': 'Exploits', 
            'zero-days': 'ZeroDays', 
            'cves': 'CVEs', 
            'alertas': 'Alertas', 
            'fuentes': 'Fuentes_Intel', 
            'mitigaciones': 'Mitigaciones'
        };

        for (const key in dataKeys) {
            const sheetName = dataKeys[key];
            const data = ALL_DATA_CACHE[key] || [];
            
            if (data.length > 0) {
                const cleanedData = data.map(item => {
                    const { _id, __v, createdAt, updatedAt, ...rest } = item;
                    return rest;
                });
                const ws = XLSX.utils.json_to_sheet(cleanedData);
                XLSX.utils.book_append_sheet(workbook, ws, sheetName);
            }
        }
        XLSX.writeFile(workbook, 'OSINT_Reporte_Completo_API.xlsx');
    }

    function handlePdfExportClick() {
        const startDateStr = document.getElementById('reportStartDate').value;
        const endDateStr = document.getElementById('reportEndDate').value;
        if (!startDateStr || !endDateStr) {
            alert('Por favor, seleccione una fecha de inicio y una fecha de fin para el reporte.');
            return;
        }
        if (new Date(startDateStr) > new Date(endDateStr)) {
            alert('La fecha de inicio no puede ser posterior a la fecha de fin.');
            return;
        }
        generarReportePDF(startDateStr, endDateStr);
    }
async function generarReportePDF(startDateStr, endDateStr) {
    // 1. VERIFICACIÓN Y CONFIGURACIÓN INICIAL
    if (typeof window.jspdf === 'undefined' || typeof window.jspdf.jsPDF === 'undefined') {
        alert('Error: La librería principal jsPDF no se cargó correctamente.');
        return;
    }
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p', 'pt', 'a4');
    if (typeof doc.autoTable !== 'function') {
        alert('Error: El plugin jsPDF-AutoTable no se cargó correctamente.');
        return;
    }

    const pageHeight = doc.internal.pageSize.height;
    const pageWidth = doc.internal.pageSize.width;
    const margin = 45;
    let yPos = 0;

    const COLOR_PRIMARY_PURPLE = '#6A3093';
    const COLOR_BLACK = '#1c1c1c';
    const COLOR_WHITE = '#FFFFFF';
    const COLOR_GREY_TEXT = '#333333';
    const COLOR_LIGHT_GREY_BG = '#F8F9FA';
    const COLOR_LINK = '#2574A9';

    const FONT_H1 = 22;
    const FONT_H2 = 14;
    const FONT_H3 = 11;
    const FONT_NORMAL = 10;
    const FONT_SMALL = 8;

    const autoTableOptions = {
        theme: 'striped',
        headStyles: { fillColor: COLOR_BLACK, textColor: COLOR_WHITE, fontSize: FONT_SMALL },
        styles: { fontSize: FONT_SMALL, cellPadding: 4, valign: 'middle' },
        margin: { left: margin, right: margin }
    };

    const imgElement = document.getElementById('fondo-pdf');
    let backgroundImageData = null;

    if (imgElement && imgElement.complete && imgElement.naturalWidth !== 0) {
        try {
            const canvas = document.createElement('canvas');
            canvas.width = imgElement.naturalWidth;
            canvas.height = imgElement.naturalHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(imgElement, 0, 0);
            backgroundImageData = canvas.toDataURL('image/jpeg');
        } catch (e) {
            console.error("Error al convertir la imagen para el PDF:", e);
            backgroundImageData = null;
        }
    } else {
        console.error("La imagen de fondo con id 'fondo-pdf' no se encontró o no se pudo cargar.");
    }

    // 2. FILTRADO Y CARGA DE DATOS
    const startDate = new Date(startDateStr);
    const endDate = new Date(endDateStr);
    endDate.setHours(23, 59, 59, 999);
    
    const filterByDate = (item) => {
        if (!item.fecha) return false;
        const itemDate = new Date(item.fecha);
        return itemDate >= startDate && itemDate <= endDate;
    };

    const incidentesData = (ALL_DATA_CACHE.incidentes || []).filter(filterByDate);
    const exploitsData = (ALL_DATA_CACHE.exploits || []).filter(filterByDate);
    const zeroDaysData = (ALL_DATA_CACHE['zero-days'] || []).filter(filterByDate);
    const cvesData = (ALL_DATA_CACHE.cves || []).filter(filterByDate);
    const alertasData = (ALL_DATA_CACHE.alertas || []).filter(filterByDate);
    const mitigacionesData = (ALL_DATA_CACHE.mitigaciones || []).filter(filterByDate);
    const fuentesData = (ALL_DATA_CACHE.fuentes || []).filter(filterByDate);

    // 3. FUNCIONES AUXILIARES DE RENDERIZADO
    const addPageFooter = () => {
        const pageCount = doc.internal.getNumberOfPages();
        for (let i = 1; i <= pageCount; i++) {
            doc.setPage(i);
            doc.setFontSize(FONT_SMALL);
            doc.setTextColor(COLOR_GREY_TEXT);
            const footerText = `Este reporte es clasificado como TLP:CLEAR (https://first.org/tlp/)`;
            doc.text(footerText, margin, pageHeight - 20);
            doc.text(`Página ${i} de ${pageCount}`, pageWidth - margin, pageHeight - 20, { align: 'right' });
        }
    };

    const checkAndAddPage = (neededHeight) => {
        if (yPos + neededHeight > pageHeight - margin - 20) {
            doc.addPage();
            yPos = margin;
        }
    };

    const addSectionTitle = (title) => {
        // --- CORRECCIÓN APLICADA AQUÍ ---
        // Se aumenta el espacio requerido a 115 para asegurar que el título
        // no quede huérfano al final de la página. (65 para el título + 50 para contenido)
        checkAndAddPage(115); 
        
        yPos += 20;
        doc.setFillColor(COLOR_PRIMARY_PURPLE);
        doc.rect(0, yPos, pageWidth, 25, 'F');
        doc.setFontSize(FONT_H2);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(COLOR_WHITE);
        doc.text(title.toUpperCase(), margin, yPos + 17);
        yPos += 25 + 20;
    };

    const addIntroductoryText = (text) => {
        checkAndAddPage(60);
        doc.setFontSize(FONT_NORMAL);
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(COLOR_BLACK);
        const textLines = doc.splitTextToSize(text, pageWidth - margin * 2);
        doc.text(textLines, margin, yPos);
        yPos += doc.getTextDimensions(textLines).h + 20;
    };
    
    const addNoDataMessage = (message = 'No se registraron datos para esta sección en el período seleccionado.') => {
        checkAndAddPage(30);
        doc.setFontSize(FONT_NORMAL);
        doc.setFont('helvetica', 'italic');
        doc.setTextColor(COLOR_GREY_TEXT);
        doc.text(message, margin, yPos);
        yPos += doc.getTextDimensions(message).h + 20;
    };

    const getTopItems = (data, key, count = 2) => {
        const counts = data.reduce((acc, item) => {
            const value = item[key];
            if (value && typeof value === 'string' && value.trim() && value.trim().toLowerCase() !== 'desconocido') {
                acc[value.trim()] = (acc[value.trim()] || 0) + 1;
            }
            return acc;
        }, {});
        return Object.entries(counts).sort((a, b) => b[1] - a[1]).slice(0, count).map(e => e[0]);
    };

    const getSeverityTextForCVSS = (cvss) => {
        const score = parseFloat(cvss);
        if (isNaN(score)) return 'N/A';
        if (score >= 9.0) return 'Crítico';
        if (score >= 7.0) return 'Alto';
        if (score >= 4.0) return 'Medio';
        if (score > 0) return 'Bajo';
        return 'Info';
    };

    const formatDate = (dateString) => {
        if (!dateString) return 'Fecha no especificada';
        const date = new Date(dateString);
        if (!(date instanceof Date && !isNaN(date))) return dateString;
        return date.toLocaleDateString('es-ES', { day: 'numeric', month: 'long', year: 'numeric', timeZone: 'UTC' });
    };

    const renderTextItem = (config) => {
        const availableWidth = pageWidth - margin * 2;
        checkAndAddPage(config.neededHeight || 80);
        doc.setFontSize(FONT_H3);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(COLOR_PRIMARY_PURPLE);
        const titleLines = doc.splitTextToSize(config.title, availableWidth);
        doc.text(titleLines, margin, yPos);
        yPos += doc.getTextDimensions(titleLines).h + 5;

        doc.setFont('helvetica', 'normal');
        doc.setFontSize(FONT_NORMAL);
        doc.setTextColor(COLOR_GREY_TEXT);

        config.details.forEach(detail => {
            if (detail.value) {
                const detailText = detail.label + detail.value;
                const detailLines = doc.splitTextToSize(detailText, availableWidth);
                doc.text(detailLines, margin, yPos);
                yPos += doc.getTextDimensions(detailLines).h + 5;
            }
        });
        
        if (config.url) {
            yPos += 5;
            checkAndAddPage(15);
            doc.setTextColor(COLOR_LINK);
            doc.textWithLink('Visitar URL', margin, yPos, { url: config.url });
            doc.setTextColor(COLOR_GREY_TEXT);
            yPos += 15;
        }

        yPos += 5;

        if (config.description) {
            const descLines = doc.splitTextToSize(`Descripción: ${config.description}`, availableWidth);
            doc.text(descLines, margin, yPos);
            yPos += doc.getTextDimensions(descLines).h;
        }

        yPos += 25;
    };

    const drawMetricsCards = (startY) => {
        const metrics = [
            { label: 'Incidentes', value: incidentesData.length },
            { label: 'Exploits', value: exploitsData.length },
            { label: 'Zero-Days', value: zeroDaysData.length },
            { label: 'CVEs Nuevos', value: cvesData.length },
            { label: 'Alertas', value: alertasData.length },
            { label: 'Mitigaciones', value: mitigacionesData.length },
        ];
        const numColumns = 3;
        const cardGap = 15;
        const availableWidth = pageWidth - (margin * 2) - (cardGap * (numColumns - 1));
        const cardWidth = availableWidth / numColumns;
        const cardHeight = 60;
        metrics.forEach((metric, index) => {
            const col = index % numColumns;
            const row = Math.floor(index / numColumns);
            const cardX = margin + col * (cardWidth + cardGap);
            const cardY = startY + row * (cardHeight + cardGap);
            doc.setFillColor(COLOR_LIGHT_GREY_BG);
            doc.setDrawColor('#EAECEE');
            doc.roundedRect(cardX, cardY, cardWidth, cardHeight, 5, 5, 'FD');
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(28);
            doc.setTextColor(COLOR_GREY_TEXT);
            doc.text(String(metric.value), cardX + cardWidth / 2, cardY + 35, { align: 'center' });
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(10);
            doc.setTextColor(COLOR_GREY_TEXT);
            doc.text(metric.label, cardX + cardWidth / 2, cardY + 50, { align: 'center' });
        });
        const numRows = Math.ceil(metrics.length / numColumns);
        return startY + (numRows * cardHeight) + ((numRows - 1) * cardGap);
    };

    // 4. CONSTRUCCIÓN DEL DOCUMENTO PDF
    
    if (backgroundImageData) {
        doc.addImage(backgroundImageData, 'JPEG', 0, 0, pageWidth, 250);
    } else {
        doc.setFillColor(COLOR_BLACK);
        doc.rect(0, 0, pageWidth, 250, 'F');
    }

    doc.setFontSize(FONT_H1);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(COLOR_WHITE);
    doc.text('CYBER THREAT INTELLIGENCE BRIEF', margin, 100);
    doc.setFontSize(48);
    doc.text('ACCENTURE', margin, 155);

    yPos = 205;

    const reportMonthName = startDate.toLocaleDateString('es-ES', { month: 'long', timeZone: 'UTC' });
    const capitalizedMonth = reportMonthName.charAt(0).toUpperCase() + reportMonthName.slice(1);
    const reportYear = startDate.getFullYear();
    const reportPeriodText = `${capitalizedMonth} ${reportYear}`;

    doc.setFillColor(COLOR_BLACK);
    doc.rect(margin, yPos, 150, 25, 'F');
    doc.setFontSize(FONT_H3);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(COLOR_WHITE);
    doc.text(reportPeriodText, margin + 10, yPos + 17);

    yPos += 25;
    yPos += 35;
    yPos = drawMetricsCards(yPos);
    yPos += 10;

    addSectionTitle('RESUMEN EJECUTIVO');
    const criticalVulns = cvesData.filter(cve => (cve.cvss || 0) >= 9.0);
    const topSectors = getTopItems(incidentesData, 'sector');
    const topActors = getTopItems(incidentesData, 'actor');
    let summaryParagraph = `Análisis correspondiente al mes de ${reportMonthName} de ${reportYear}. Durante este tiempo, se publicaron ${cvesData.length} nuevas vulnerabilidades, de las cuales ${criticalVulns.length} se calificaron como críticas (CVSS 9.0+). Se registraron ${incidentesData.length} incidentes relevantes, con especial afectación al sector ${topSectors.length > 0 ? topSectors.join(' y ') : 'diversos'}. Los grupos de amenaza más destacados fueron ${topActors.length > 0 ? topActors.join(', ') : 'varios'}. Además, se descubrieron ${zeroDaysData.length} nuevas vulnerabilidades de día cero y se publicaron ${exploitsData.length} exploits con prueba de concepto.`;
    addIntroductoryText(summaryParagraph);

    addSectionTitle('Incidentes');
    addIntroductoryText('El conocimiento y la vigilancia de los ciber incidentes es fundamental para la seguridad de cualquier organización. La respuesta ante estos incidentes y su posterior análisis post mortem son cruciales para el proceso de fortalecimiento de los sistemas. Al mantenerse informadas sobre los últimos ataques, las organizaciones pueden identificar y mitigar posibles amenazas.');
    if (incidentesData.length > 0) {
        [...incidentesData].sort((a, b) => new Date(b.fecha) - new Date(a.fecha)).forEach(item => renderTextItem({
            title: `${item.tipo || 'N/A'} - ${item.entidad || 'Entidad no especificada'}`,
            details: [
                { label: 'Fecha: ', value: formatDate(item.fecha) },
                { label: 'Actor de Amenazas: ', value: item.actor || 'Desconocido' },
                { label: 'País y Sector: ', value: `${item.pais || 'N/A'} | ${item.sector || 'N/A'}` },
                { label: 'Datos Comprometidos: ', value: item.datosComprometidos || 'N/A' }
            ],
            description: item.descripcion || 'Sin descripción.',
            url: item.url
        }));
    } else { 
        addNoDataMessage();
    }

    addSectionTitle('Exploits Publicados');
    addIntroductoryText('Los exploit son puertas traseras que los atacantes pueden utilizar permitiendo el robo de datos, la instalación de malware, la toma de control de sistemas y múltiples ataques a sistemas informáticos. Al comprender estos exploit, la amenaza que representan y cómo funcionan, las empresas pueden tomar medidas proactivas para protegerse de ataques cibernéticos.');
    if (exploitsData.length > 0) {
        const sortedExploits = [...exploitsData].sort((a,b) => new Date(b.fecha) - new Date(a.fecha));
        doc.autoTable({ ...autoTableOptions, theme: 'grid', startY: yPos,
            head: [['Fecha', 'Nombre', 'Tipo', 'Plataforma', 'CVE Asociado', 'URL']],
            body: sortedExploits.map(e => [ formatDate(e.fecha), e.nombre || 'N/A', e.tipo || 'N/A', e.plataforma, e.cve || 'N/A', '' ]),
            columnStyles: { 0: { cellWidth: 80 }, 1: { cellWidth: 'auto' }, 5: { cellWidth: 40, halign: 'center' } },
            didDrawCell: (data) => {
                if (data.column.index === 5 && data.row.section === 'body') {
                    const exploit = sortedExploits[data.row.index];
                    if (exploit && exploit.url) {
                        doc.setTextColor(COLOR_LINK);
                        doc.textWithLink('Ver', data.cell.x + data.cell.width / 2, data.cell.y + data.cell.height / 2 + 4, { url: exploit.url, align: 'center' });
                    }
                }
            }
        });
        yPos = doc.lastAutoTable.finalY + 20;
    } else { 
        addNoDataMessage();
    }

    addSectionTitle('Zero-Days');
    addIntroductoryText('El conocimiento de los "zero days" o vulnerabilidades de día cero es fundamental en el ámbito de la ciberseguridad. Estas vulnerabilidades son fallos de seguridad en software o hardware que son desconocidos para los fabricantes y, por lo tanto, no tienen un parche o solución disponible en el momento de su descubrimiento.');
    if (zeroDaysData.length > 0) {
        [...zeroDaysData].sort((a, b) => new Date(b.fecha) - new Date(a.fecha)).forEach(item => renderTextItem({
            title: `Zero Day: ${item.nombre || 'N/A'} (ID: ${item.idZD || 'N/A'})`,
            details: [
                { label: 'Fecha Detección: ', value: formatDate(item.fecha) },
                { label: 'Plataforma Afectada: ', value: item.plataforma || 'N/A' },
                { label: 'CVSS y Estado: ', value: `${item.cvss || 'N/A'} | ${item.estado || 'N/A'}` }
            ],
            description: item.descripcion || 'Sin descripción.',
            url: item.url
        }));
    } else { 
        addNoDataMessage();
    }

    addSectionTitle('Vulnerabilidades');
    addIntroductoryText('Las Vulnerabilidades Comunes Enumeradas (CVE) proporcionan detalles sobre vulnerabilidades de seguridad en sistemas y software, permitiendo a las organizaciones identificar y mitigar posibles amenazas. Las CVE aquí listadas son sumamente relevantes para la seguridad de los sistemas, recomendamos realizar las mitigaciones necesarias para evitar la exposición a estas vulnerabilidades.');
    if (cvesData.length > 0) {
        const sortedCves = [...cvesData].sort((a,b) => new Date(b.fecha) - new Date(a.fecha));
        doc.autoTable({ ...autoTableOptions, startY: yPos,
            head: [['ID CVE', 'Aplicativo', 'Fecha Pub.','Descripción', 'CVSS (Severidad)', 'URL']],
            body: sortedCves.map(c => [ c.cveId || 'N/A', c.aplicativo || 'N/A', formatDate(c.fecha), c.descripcion || 'N/A' , `${c.cvss || 'N/A'} (${getSeverityTextForCVSS(c.cvss)})`, '' ]),
            columnStyles: {2: { cellWidth: 70 }, 3: { cellWidth: 'auto' }, 4: { cellWidth: 70 }, 5: { cellWidth: 40, halign: 'center' } },
            didDrawCell: (data) => {
                if (data.column.index === 5 && data.row.section === 'body') {
                    const cve = sortedCves[data.row.index];
                    if (cve && cve.url) {
                        doc.setTextColor(COLOR_LINK);
                        doc.textWithLink('Ver', data.cell.x + data.cell.width / 2, data.cell.y + data.cell.height / 2 + 4, { url: cve.url, align: 'center' });
                    }
                }
            }
        });
        yPos = doc.lastAutoTable.finalY + 20;
    } else { 
        addNoDataMessage();
    }
    
    addSectionTitle('Alertas CTI');
    addIntroductoryText('Las alertas de Cyber Threat Intelligence son notificaciones que informan sobre amenazas cibernéticas identificadas, como vulnerabilidades o ataques activos. La importancia de estas alertas es su capacidad para comunicar información crítica de manera segura y eficiente, asegurando que solo las partes adecuadas tengan acceso a la información necesaria para protegerse contra amenazas cibernéticas.');
    if (alertasData.length > 0) {
        [...alertasData].sort((a,b) => new Date(b.fecha) - new Date(a.fecha)).forEach(item => renderTextItem({
            title: `${item.titulo || 'Sin título'} (Criticidad: ${item.criticidad || 'N/A'})`,
            details: [{ label: 'Fecha: ', value: formatDate(item.fecha) }],
            description: item.descripcion || 'Sin descripción.',
            url: item.url
        }));
    } else { 
        addNoDataMessage();
    }

    addSectionTitle('Recomendaciones para las Organizaciones');
    addIntroductoryText('La inteligencia de amenazas (CTI) permite transformar datos en acciones defensivas proactivas, reduciendo la superficie de ataque y fortaleciendo la resiliencia frente a un panorama de amenazas cada vez más sofisticado y dirigido.');
    if (mitigacionesData.length > 0) {
        const priorityOrder = { 'Alta': 1, 'Media': 2, 'Baja': 3 };
        [...mitigacionesData].sort((a,b) => (priorityOrder[a.prioridad] || 4) - (priorityOrder[b.prioridad] || 4)).forEach((item, index) => renderTextItem({
            title: `${item.titulo || 'Recomendación sin título'}`,
            details: [{ label: 'Categoría y Prioridad: ', value: `${item.categoria || 'N/A'} | ${item.prioridad || 'N/A'}` }],
            description: item.descripcion || 'Sin descripción.',
            url: item.url
        }));
    } else { 
        addNoDataMessage('No se han definido mitigaciones específicas en el período seleccionado.');
    }
    
    addSectionTitle('Fuentes de Inteligencia');
    addIntroductoryText('En el último mes, nuestro equipo de CTI ha realizado un exhaustivo trabajo de recopilación y análisis de fuentes abiertas, utilizando diversas herramientas y metodologías de OSINT. Nuestro objetivo ha sido identificar y evaluar los riesgos latentes que amenazan la red abierta.');
    if (fuentesData.length > 0) {
        [...fuentesData].sort((a,b) => new Date(b.fecha) - new Date(a.fecha)).forEach(f => {
            renderTextItem({
                title: f.nombre || 'Fuente sin nombre',
                details: [{ label: 'Tipo: ', value: f.tipo || 'N/A' }],
                description: f.descripcion,
                url: f.url
            });
        });
    } else { 
        addNoDataMessage();
    }
    
    addSectionTitle('Equipo de CTI');
    addIntroductoryText('El contenido de este boletin, sus recomendaciones, alertas y la evaluación del riesgo que estas amenazas representa para las organizaciones interesadas fue proporcionado por el equipo de Cyber Threat Intelligence del Clan de Cyber Resilience de Accenture Buenos Aires.');

    // 5. FINALIZACIÓN Y GUARDADO DEL DOCUMENTO
    addPageFooter();
    doc.save(`Cyber_Threat_Intelligence_Brief_${capitalizedMonth}_${reportYear}.pdf`);
}
    function generarReporteCompletoHTML() {
        const startDateStr = document.getElementById('reportStartDate').value;
        const endDateStr = document.getElementById('reportEndDate').value;
        const previewDiv = document.getElementById('previewReporte');

        if (!startDateStr || !endDateStr) {
            previewDiv.innerHTML = `<p style="color: red; font-weight: bold; text-align: center;">Por favor, seleccione una fecha de inicio y una fecha de fin para previsualizar el reporte.</p>`;
            return;
        }
        if (new Date(startDateStr) > new Date(endDateStr)) {
            previewDiv.innerHTML = `<p style="color: red; font-weight: bold; text-align: center;">La fecha de inicio no puede ser posterior a la fecha de fin.</p>`;
            return;
        }

        const startDate = new Date(startDateStr);
        const endDate = new Date(endDateStr);
        endDate.setHours(23, 59, 59, 999);
        
        const filterByDate = (item) => {
            if (!item.fecha) return false;
            const itemDate = new Date(item.fecha);
            return itemDate >= startDate && itemDate <= endDate;
        };

        const incidentesData = (ALL_DATA_CACHE.incidentes || []).filter(filterByDate);
        const exploitsData = (ALL_DATA_CACHE.exploits || []).filter(filterByDate);
        const zeroDaysData = (ALL_DATA_CACHE['zero-days'] || []).filter(filterByDate);
        const cvesData = (ALL_DATA_CACHE.cves || []).filter(filterByDate);
        const alertasData = (ALL_DATA_CACHE.alertas || []).filter(filterByDate);
        const mitigacionesData = (ALL_DATA_CACHE.mitigaciones || []).filter(filterByDate);
        const fuentesData = (ALL_DATA_CACHE.fuentes || []).filter(filterByDate);
        
        const formatDate = (dateString) => {
            if (!dateString) return 'Fecha no especificada';
            const date = new Date(dateString);
            return date.toLocaleDateString('es-ES', { day: 'numeric', month: 'long', year: 'numeric', timeZone: 'UTC' });
        };
        const getSeverityTextForCVSS = (cvss) => {
            const score = parseFloat(cvss);
            if (isNaN(score)) return 'N/A';
            if (score >= 9.0) return 'Crítico';
            if (score >= 7.0) return 'Alto';
            if (score >= 4.0) return 'Medio';
            if (score > 0) return 'Bajo';
            return 'Info';
        };
        const getTopItems = (data, key, count = 2) => {
            const counts = data.reduce((acc, item) => {
                const value = item[key];
                if (value && typeof value === 'string' && value.trim() && value.trim().toLowerCase() !== 'desconocido') {
                    acc[value.trim()] = (acc[value.trim()] || 0) + 1;
                }
                return acc;
            }, {});
            return Object.entries(counts).sort((a, b) => b[1] - a[1]).slice(0, count).map(e => e[0]);
        };
        
        const styles = {
            container: `padding: 20px; border: 1px solid #ccc; background-color: #fff; font-family: 'Helvetica', 'Arial', sans-serif; color: #333;`,
            h1: `font-size: 22px; color: #6A3093; border-bottom: 2px solid #6A3093; padding-bottom: 5px; margin-bottom: 20px; font-weight: bold;`,
            h2: `font-size: 14px; color: #6A3093; margin-top: 30px; margin-bottom: 15px; font-weight: bold; text-transform: uppercase; border-bottom: 1px solid #eaeaea; padding-bottom: 8px;`,
            introText: `font-size: 12px; color: #555; margin-bottom: 20px; line-height: 1.5;`,
            item: `border-left: 4px solid #6A3093; padding: 15px; margin-bottom: 15px; background-color: #fdfdfd; box-shadow: 0 1px 3px rgba(0,0,0,0.05);`,
            itemTitle: `font-size: 13px; color: #333; font-weight: bold; margin: 0 0 10px 0;`,
            itemDetail: `font-size: 11px; color: #444; margin-bottom: 5px;`,
            itemDesc: `font-size: 12px; color: #444; margin-top: 10px;`,
            table: `width: 100%; border-collapse: collapse; font-size: 11px; margin-bottom: 20px;`,
            th: `background-color: #1c1c1c; color: white; padding: 8px; text-align: left;`,
            td: `border: 1px solid #ddd; padding: 8px; vertical-align: top;`,
            metricContainer: `display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 30px;`,
            metricCard: `flex: 1; min-width: 120px; background-color: #F8F9FA; border: 1px solid #EAECEE; border-radius: 5px; padding: 15px; text-align: center;`,
            metricValue: `font-size: 28px; font-weight: bold; color: #333;`,
            metricLabel: `font-size: 11px; color: #555; margin-top: 5px;`,
            noData: `font-style: italic; color: #777;`,
            urlLink: `display: block; margin-top: 8px; font-size: 11px;`
        };
        const urlFormatter = (url) => {
             if (!url) return '';
             return `<a href="${url}" target="_blank" rel="noopener noreferrer" style="${styles.urlLink}">Ver referencia</a>`;
        };
        
        let reporteHTML = `<div style="${styles.container}">`;
        const reportMonthName = startDate.toLocaleDateString('es-ES', { month: 'long', timeZone: 'UTC' });
        const capitalizedMonth = reportMonthName.charAt(0).toUpperCase() + reportMonthName.slice(1);
        const reportYear = startDate.getFullYear();
        reporteHTML += `<h1 style="${styles.h1}">Cyber Threat Intelligence Brief (${capitalizedMonth} ${reportYear})</h1>`;

        const metrics = [
            { label: 'Incidentes', value: incidentesData.length }, { label: 'Exploits', value: exploitsData.length },
            { label: 'Zero-Days', value: zeroDaysData.length }, { label: 'CVEs Nuevos', value: cvesData.length },
            { label: 'Alertas', value: alertasData.length }, { label: 'Mitigaciones', value: mitigacionesData.length }
        ];
        reporteHTML += `<div style="${styles.metricContainer}">`;
        metrics.forEach(metric => {
            reporteHTML += `<div style="${styles.metricCard}"><div style="${styles.metricValue}">${metric.value}</div><div style="${styles.metricLabel}">${metric.label}</div></div>`;
        });
        reporteHTML += `</div>`;
        
        const criticalVulns = cvesData.filter(cve => (cve.cvss || 0) >= 9.0);
        const topSectors = getTopItems(incidentesData, 'sector');
        const topActors = getTopItems(incidentesData, 'actor');
        let summaryParagraph = `Análisis correspondiente al período. Se publicaron ${cvesData.length} nuevas vulnerabilidades, de las cuales ${criticalVulns.length} se calificaron como críticas (CVSS 9.0+). Se registraron ${incidentesData.length} incidentes relevantes, con especial afectación al sector ${topSectors.length > 0 ? topSectors.join(' y ') : 'diversos'}. Los grupos de amenaza más destacados fueron ${topActors.length > 0 ? topActors.join(', ') : 'varios'}. Además, se descubrieron ${zeroDaysData.length} nuevas vulnerabilidades de día cero y se publicaron ${exploitsData.length} exploits con prueba de concepto.`;
        reporteHTML += `<h2 style="${styles.h2}">Resumen Ejecutivo</h2><p style="${styles.introText}">${summaryParagraph}</p>`;

        const renderSection = (title, intro, data, renderer) => {
            reporteHTML += `<h2 style="${styles.h2}">${title}</h2><p style="${styles.introText}">${intro}</p>`;
            if (data.length > 0) { renderer(data); } 
            else { reporteHTML += `<p style="${styles.noData}">No hay datos para esta sección en el período seleccionado.</p>`; }
        };

        renderSection('Incidentes', 'El conocimiento y la vigilancia de los ciber incidentes es fundamental...', incidentesData, (data) => {
            [...data].sort((a,b) => new Date(b.fecha) - new Date(a.fecha)).forEach(item => {
                reporteHTML += `<div style="${styles.item}"><h3 style="${styles.itemTitle}">${item.tipo || 'N/A'} - ${item.entidad || 'Entidad no especificada'}</h3><p style="${styles.itemDetail}"><strong>Fecha:</strong> ${formatDate(item.fecha)} | <strong>Actor:</strong> ${item.actor || 'Desconocido'}</p><p style="${styles.itemDetail}"><strong>País y Sector:</strong> ${item.pais || 'N/A'} | ${item.sector || 'N/A'}</p><p style="${styles.itemDesc}">${item.descripcion || 'Sin descripción.'}</p>${urlFormatter(item.url)}</div>`;
            });
        });

        renderSection('Exploits Publicados', 'Los exploit son puertas traseras que los atacantes pueden utilizar...', exploitsData, (data) => {
            reporteHTML += `<table style="${styles.table}"><thead><tr><th style="${styles.th}">Fecha</th><th style="${styles.th}">Nombre</th><th style="${styles.th}">Tipo</th><th style="${styles.th}">Plataforma</th></tr></thead><tbody>`;
            [...data].sort((a,b) => new Date(b.fecha) - new Date(a.fecha)).forEach(e => {
                reporteHTML += `<tr><td style="${styles.td}">${formatDate(e.fecha)}</td><td style="${styles.td}">${e.nombre || 'N/A'} ${urlFormatter(e.url)}</td><td style="${styles.td}">${e.tipo || 'N/A'}</td><td style="${styles.td}">${e.plataforma}</td></tr>`;
            });
            reporteHTML += '</tbody></table>';
        });

        renderSection('Zero-Days', 'El conocimiento de los "zero days" es fundamental...', zeroDaysData, (data) => {
            [...data].sort((a,b) => new Date(b.fecha) - new Date(a.fecha)).forEach(item => {
                reporteHTML += `<div style="${styles.item}"><h3 style="${styles.itemTitle}">Zero Day: ${item.nombre || 'N/A'} (ID: ${item.idZD || 'N/A'})</h3><p style="${styles.itemDetail}"><strong>Fecha Detección:</strong> ${formatDate(item.fecha)} | <strong>Plataforma:</strong> ${item.plataforma || 'N/A'}</p><p style="${styles.itemDetail}"><strong>CVSS y Estado:</strong> ${item.cvss || 'N/A'} | ${item.estado || 'N/A'}</p><p style="${styles.itemDesc}">${item.descripcion || 'Sin descripción.'}</p>${urlFormatter(item.url)}</div>`;
            });
        });

        renderSection('Vulnerabilidades', 'Las Vulnerabilidades Comunes Enumeradas (CVE) proporcionan detalles...', cvesData, (data) => {
            reporteHTML += `<table style="${styles.table}"><thead><tr><th style="${styles.th}">ID CVE</th><th style="${styles.th}">Nombre</th><th style="${styles.th}">Descripción</th><th style="${styles.th}">CVSS (Severidad)</th></tr></thead><tbody>`;
            [...data].sort((a,b) => new Date(b.fecha) - new Date(a.fecha)).forEach(c => {
                reporteHTML += `<tr><td style="${styles.td}">${c.cveId || 'N/A'} ${urlFormatter(c.url)}</td><td style="${styles.td}">${c.aplicativo || 'N/A'}</td><td style="${styles.td}">${c.descripcion || 'N/A'}</td><td style="${styles.td}">${c.cvss || 'N/A'} (${getSeverityTextForCVSS(c.cvss)})</td></tr>`;
            });
            reporteHTML += '</tbody></table>';
        });
        
        renderSection('Alertas CTI', 'Las alertas de Cyber Threat Intelligence son notificaciones...', alertasData, (data) => {
             [...data].sort((a,b) => new Date(b.fecha) - new Date(a.fecha)).forEach(item => {
                reporteHTML += `<div style="${styles.item}"><h3 style="${styles.itemTitle}">${item.titulo || 'Sin título'} (Criticidad: ${item.criticidad || 'N/A'})</h3><p style="${styles.itemDetail}"><strong>Fecha:</strong> ${formatDate(item.fecha)}</p><p style="${styles.itemDesc}">${item.descripcion || 'Sin descripción.'}</p>${urlFormatter(item.url)}</div>`;
            });
        });

        renderSection('Recomendaciones para las Organizaciones', 'La inteligencia de amenazas (CTI) permite transformar datos...', mitigacionesData, (data) => {
            const priorityOrder = { 'Alta': 1, 'Media': 2, 'Baja': 3 };
            [...data].sort((a,b) => (priorityOrder[a.prioridad] || 4) - (priorityOrder[b.prioridad] || 4)).forEach(item => {
                reporteHTML += `<div style="${styles.item}"><h3 style="${styles.itemTitle}">${item.titulo || 'Recomendación sin título'}</h3><p style="${styles.itemDetail}"><strong>Categoría y Prioridad:</strong> ${item.categoria || 'N/A'} | ${item.prioridad || 'N/A'}</p><p style="${styles.itemDesc}">${item.descripcion || 'Sin descripción.'}</p>${urlFormatter(item.url)}</div>`;
            });
        });

        renderSection('Fuentes de Inteligencia', 'Nuestro equipo de CTI ha realizado un exhaustivo trabajo...', fuentesData, (data) => {
            [...data].sort((a,b) => new Date(b.fecha) - new Date(a.fecha)).forEach(f => {
                reporteHTML += `<div style="${styles.item}"><h3 style="${styles.itemTitle}">${f.nombre || 'Fuente sin nombre'}</h3><p style="${styles.itemDetail}"><strong>Tipo:</strong> ${f.tipo || 'N/A'}</p><p style="${styles.itemDesc}">${f.descripcion || ''}</p>${urlFormatter(f.url)}</div>`;
            });
        });

        reporteHTML += `</div>`;
        previewDiv.innerHTML = reporteHTML;
    }

        // =============================================================================
    // EXPORT & REPORTING FUNCTIONS (Puedes añadir las nuevas funciones aquí debajo)
    // =============================================================================

    /* ... aquí van tus funciones existentes como exportarExcel(), generarReportePDF(), etc. ... */

    /**
     * Maneja la selección de un archivo Excel para importación.
     * Lee el archivo, lo procesa por hojas y envía los datos a la API.
     * @param {Event} event - El evento del input de archivo.
     */
    async function handleExcelImport(event) {
        const file = event.target.files[0];
        if (!file) {
            return;
        }

        const reader = new FileReader();
        reader.onload = async (e) => {
            try {
                const data = new Uint8Array(e.target.result);
                // Lee el libro de trabajo con la opción de convertir fechas de Excel a objetos Date de JS.
                const workbook = XLSX.read(data, { type: 'array', cellDates: true });

                // Mapeo de los nombres de las hojas a los endpoints de la API.
                const sheetToEndpointMap = {
                    'Incidentes': 'incidentes',
                    'Exploits': 'exploits',
                    'ZeroDays': 'zero-days',
                    'CVEs': 'cves',
                    'Alertas': 'alertas',
                    'Fuentes_Intel': 'fuentes',
                    'Mitigaciones': 'mitigaciones'
                };
                
                let importSummary = [];

                // Procesa cada hoja del archivo Excel.
                for (const sheetName of workbook.SheetNames) {
                    if (sheetToEndpointMap[sheetName]) {
                        const endpoint = sheetToEndpointMap[sheetName];
                        const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName]);

                        if(jsonData && jsonData.length > 0) {
                            const importedCount = await importarRegistros(endpoint, jsonData);
                            importSummary.push(`${importedCount} registros importados a la sección '${sheetName}'.`);
                        }
                    }
                }
                
                // Una vez finalizada la importación, actualiza los datos de la aplicación.
                await fetchAndCacheAllData();
                
                // Si el dashboard está activo, renderízalo de nuevo.
                if (document.getElementById('dashboard').classList.contains('active')) {
                    await renderDashboard();
                }
                
                // Informa al usuario sobre el resultado de la importación.
                if (importSummary.length > 0) {
                    alert('Importación completada:\n\n' + importSummary.join('\n'));
                } else {
                    alert('No se encontraron hojas con nombres válidos o datos para importar en el archivo seleccionado.');
                }

            } catch (error) {
                console.error('Error al importar el archivo Excel:', error);
                alert('Ocurrió un error al procesar el archivo. Verifique que el formato sea correcto y revise la consola para más detalles.');
            } finally {
                // Limpia el valor del input para permitir importar el mismo archivo otra vez.
                event.target.value = '';
            }
        };
        reader.readAsArrayBuffer(file);
    }

    /**
     * Envía un array de registros a un endpoint específico de la API mediante POST.
     * @param {string} endpoint - El endpoint de la API (ej: 'incidentes').
     * @param {Array<Object>} registros - Un array de objetos a crear.
     * @returns {Promise<number>} - El número de registros creados exitosamente.
     */
    async function importarRegistros(endpoint, registros) {
        let successCount = 0;
        for (const registro of registros) {
            // El archivo generado por la app no incluye _id, por lo que no es necesario limpiarlo.
            // Si el archivo es externo, las columnas deben coincidir con el esquema esperado por la API.
            try {
                const response = await fetch(`${API_BASE_URL}/${endpoint}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(registro)
                });

                if (response.ok) {
                    successCount++;
                } else {
                    const errorData = await response.json();
                    console.warn(`Error al importar registro a '${endpoint}':`, errorData.message, registro);
                }
            } catch (error) {
                console.error(`Error de red o conexión al importar a '${endpoint}':`, error, registro);
            }
        }
        return successCount;
    }
</script>
</body>
</html>